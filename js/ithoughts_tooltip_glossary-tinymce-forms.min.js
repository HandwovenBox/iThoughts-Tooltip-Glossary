/**
 * @file Client-side scripts for handling tooltip creation wizzard in Wordpress TinyMCE
 *
 * @author Gerkin
 * @copyright 2016 GerkinDevelopment
 * @license http://www.gnu.org/licenses/old-licenses/gpl-2.0.fr.html GPLv2
 * @package ithoughts-tooltip-glossary
 *
 * @version 2.5.0
 */
!function(t){"use strict";function e(t){var e=a("#ithoughts_tt_gl_link");switch(t){case 0:e.qtip({show:{event:"focus"},hide:{event:"blur"},content:{title:e.attr("data-warning-title"),button:!0,text:e.attr("data-warning-text")},position:{container:a("#ithoughts_tt_gl-tooltip-form")}});break;case 1:e.qtip("destroy",!0);break;case 2:e.qtip("destroy",!0)}}var i,a=t.$,n=t.$w;ithoughts_tt_gl;t.$d.ready(function(){function o(t){try{tinymce.EditorManager.execCommand("mceRemoveEditor",!0,t)}catch(e){console.warn("Force cleaning needed: ",e),tinymce.EditorManager.editors=tinymce.EditorManager.editors.filter(function(e){return e.id!=t})}}function r(){var t=h.offset().top-n.scrollTop(),e=n.height(),i=e-t;m.css({maxHeight:i})}function s(){setTimeout(function(){h.find("*:focus").length||u.is(":focus")||m.addClass("hidden")},100)}function l(){var e=[],i=[];t.tinymce.terms.map(function(t){var a=t.title.toLowerCase().indexOf(searchedString);return-1==a&&(a=t.slug.toLowerCase().indexOf(searchedString)),-1!=a?0==a?void e.push(t):void i.push(t):void 0});var n=e.concat(i);h.empty();var o=n.length;if(o>0)for(var s=0;o>s;s++){var l=n[s];"undefined"==typeof l.thislang||l.thislang?h.append(a.parseHTML('<div tabindex="0" class="option" data-id="'+l.id+'" data-excerpt="'+l.content+'"><p><b>'+l.title+"</b><br><em>"+l.slug+"</em></p></div>")):h.append(a.parseHTML('<div tabindex="0" class="option foreign-language" data-id="'+l.id+'" data-excerpt="'+l.content+'"><p><b>'+l.title+"</b><br><em>"+l.slug+"</em></p></div>"))}else h.append(a.parseHTML('<p style="text-align:center"><em>No results</em><p>'));m.removeClass("hidden"),setTimeout(r,25),h.find(".option").on("click",function(t){a('[name="glossary_term_id"]').val(t.currentTarget.getAttribute("data-id")),u[0].value=a(t.currentTarget).find("p > b").text(),m.addClass("hidden")})}ithoughts_tt_gl.doInitTooltips(),a(".tabs li").click(function(t){var e=a(t.target).index();a(this).hasClass("active")||(a(this).parent().find(".active").removeClass("active"),a(this).addClass("active"),a(t.target).parent().parent().find(" > .active").removeClass("active"),a(a(t.target).parent().parent().children()[e+1]).addClass("active"))}),a("#ithoughts_tt_gl-tabs-mode").click(function(t){a(this).hasClass("active")||e(a(t.target).index())});var c=parseInt(a("#ithoughts_tt_gl-tabs-mode").attr("data-init-tab-index"))||0;e(c),a(a("#ithoughts_tt_gl-tabs-mode").children()[c]).click();var d=a("#ithoughts_tt_gl-tooltip-form-container .tinymce");d.each(function(e,i){for(var a=i.value;null==i.getAttribute("id");){var n="editor"+Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,10);gei(n)||i.setAttribute("id",n)}var o=i.getAttribute("id");tinymce.init({selector:"#"+o,menubar:!1,external_plugins:{code:t.tinymce.base_tinymce+"/code/plugin.min.js",wordcount:t.tinymce.base_tinymce+"/wordcount/plugin.min.js"},plugins:"wplink",toolbar:["styleselect | bold italic underline link | bullist numlist | alignleft aligncenter alignright alignjustify | code"],min_height:70,height:70,resize:!1});var r=setInterval(function(){tinymce.get(o)&&(clearInterval(r),tinymce.get(o).setContent(a.replace(/&/g,"&amp;")))},50)}),a(".modeswitcher").on("click keyup",function(){var t=this.id;a("[data-"+t+"]:not([data-"+t+'="mediatip-'+this.value+'-type"])').hide(),a("[data-"+t+'~="mediatip-'+this.value+'-type"]').show()}).keyup(),a("#ithoughts_tt_gl_select_image").click(function(){onclickEntryPoint=this,window.mb=window.mb||{},window.mb.frame=wp.media({frame:"post",state:"insert",library:{type:["audio","video","image"]},multiple:!1}),window.mb.frame.on("insert",function(){var t=window.mb.frame.state().get("selection").first().toJSON();0>a.trim(t.url.length)||(a("#image-box-data").val(JSON.stringify({url:t.url,id:t.id,link:t.link})),gei("image-box").innerHTML='<img src="'+t.url+'"/>',gei("mediatip_caption").value=t.caption,gei("ithoughts_tt_gl_link").value=t.link)}),window.mb.frame.open()});var u=a("#glossary_term"),h=a("#glossary_term_completer"),m=a("#glossary_term_completer_container");n.resize(r);var g=null;u.on("keyup focusin",function(){g&&g.abort(),searchedString=removeAccents(a(this).val().toLowerCase()),g=a.ajax({url:t.tinymce.admin_ajax,method:"POST",dataType:"json",data:{action:"ithoughts_tt_gl_get_terms_list",search:searchedString},complete:function(e){var i=e.responseJSON;if("undefined"!=typeof i&&i.success){if(i.data.searched!=searchedString)return void console.info("Outdated response");t.tinymce.terms=i.data.terms,l()}}}),l()}).on("focusout",s).on("keyup",function(){this.removeAttribute("data-term-id")}),a("#ithoughts_tt_gl-tinymce-validate").click(function(){var t={type:["glossary","tooltip","mediatip"][a(".tabs li.active").index()],text:gei("ithoughts_tt_gl_text").value,link:gei("ithoughts_tt_gl_link").value,opts:i};switch(t.type){case"glossary":t=a.extend(t,{glossary_id:a('[name="glossary_term_id"]').val(),disable_auto_translation:function(t){return t?t.checked:!1}(qs('[name="glossary_disable_auto_translation"]'))});break;case"tooltip":t=a.extend(t,{tooltip_content:tinymce.EditorManager.get("ithoughts_tt_gl-tooltip-content").getContent()||a("#ithoughts_tt_gl-tooltip-content").val()});break;case"mediatip":switch(t=a.extend(t,{mediatip_type:a("#mediatip_type").val()}),t.mediatip_type){case"localimage":t=a.extend(t,{mediatip_content:a("#image-box-data").val(),mediatip_caption:a("#mediatip_caption").val()});break;case"webimage":t=a.extend(t,{mediatip_content:a("#mediatip_url_image").val(),mediatip_caption:a("#mediatip_caption").val()});break;case"webvideo":t=a.extend(t,{mediatip_content:a("#mediatip_url_video_embed").val(),mediatip_link:a("#mediatip_url_video_link").val()})}}setTimeout(function(){o("ithoughts_tt_gl-tooltip-content")},500),ithoughts_tt_gl.finishTinymce(t)}),a(".ithoughts_tt_gl-tinymce-discard").click(function(){setTimeout(function(){o("ithoughts_tt_gl-tooltip-content")},500),ithoughts_tt_gl.finishTinymce()}),function(){a("#mediatip_url_video_link").bind("keyup mouseup change click focusin focusout",function(){var t=null,e={direct:{regex:/^(.*\.mp4)(\?.*)?$/,embed:'<video width="512" height="288" controls="controls"><source src="$1" type="video/mp4" /></video>',video:"$1"},youtube:{regex:/^(?:https?:\/\/(?:youtu\.be\/|\w*\.youtube\.\w{2,3}\/watch\?v=)|<iframe .*?src="https?:\/\/\w*\.youtube\.\w{2,3}\/embed\/)([a-zA-Z0-9]*).*$/,embed:'<iframe width="512" height="288" src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>',video:"https://www.youtube.com/watch?v=$1"},dailymotion:{regex:/^(?:https?:\/\/(?:dai\.ly\/|\w*\.dailymotion\.\w{2,3}\/video\/)|<iframe .*?src=".*?\w*\.dailymotion\.\w{2,3}\/embed\/video\/)([a-zA-Z0-9]*).*/,embed:'<iframe width="512" height="288" src="https://www.dailymotion.com/embed/video/$1" frameborder="0" allowfullscreen></iframe>',video:"https://www.dailymotion.com/video/$1"}};for(var i in e)if(this.value.match(e[i].regex)){t={embed:this.value.replace(e[i].regex,e[i].embed),video:this.value.replace(e[i].regex,e[i].video)};break}t&&(a("#mediatip_url_video_embed").val(t.embed),a("#mediatip_url_video_link").val(t.video))}).keyup()}(),function(){var t=["span","link"];t.forEach(function(t){a("#kv-pair-"+t+"-attrs-add").click(function(){var e=a("#attributes-"+t+"-key"),i=a("#attributes-"+t+"-value"),n=a("#kv-pair-"+t+"-attrs");return function(){if(e.val().length>0){var t='<div id="'+e.val()+'"><button class="delete button" type="button">x</button><div class="kv"><p class="key">'+e.val()+'<p class="value">'+i.val()+"</p></div></div>";e.val(""),i.val(""),t=a(a.parseHTML(t)),t.find(".delete").click(function(){t.remove()}),n.append(t)}}}())})}(),function(){function t(){return 0===a(this).closest(".ithoughts-prototype").length}function e(){var t=a(this),e=t.parent().parent(),i=e.find("input").filter(function(){return this!=t.get(0)});setTimeout(function(){var a=t.closest(".ithoughts-attrs-container").attr("data-attr-family");return console.log(o,a,e.parent(),e),o[a]?void(o[a]=!1):(console.log("Check remove attr",this),t.val(t.val().trim()),i.val(i.val().trim()),console.log(t.get(0),i.get(0),document.activeElement),void(t.val()||i.val()||document.activeElement==t.get(0)||document.activeElement==i.get(0)||e.remove()))},100)}var n=a("#ithoughts_tt_gl-tooltip-form-options"),o={span:!1,link:!1};n.find('input[type="checkbox"].ithoughts-tristate').prop("tristate",1).change(function(t){var e=this,i=e.tristate=((e.tristate||0)-2)%3+1;console.log(i),this.indeterminate=0==i,this.checked=1==i,console.log("After",e.indeterminate,e.checked)}).change(),a("#ithoughts_tt_gl-tinymce-advanced_options").click(function(){n.show()}),a("#ithoughts_tt_gl-tinymce-close-attrs").click(function(){n.hide()}),a("#ithoughts_tt_gl-tinymce-validate-attrs").click(function(){var t=a("#ithoughts_tt_gl-tooltip-form-options form"),e={};t.find(".ithoughts-tristate").each(function(){a.extend(!0,e,a(this).serializeInputsObject({"-1":!1,0:null,1:!0}[this.tristate]))}),i=a.extend(!0,t.serializeObject(),e),n.hide()}),a("#kv-pair-link-attrs-add,#kv-pair-span-attrs-add").bind("mousedown touchstart",function(){var t=a(this).parent().find(".ithoughts-attrs-container"),e=t.attr("data-attr-family");o[e]=!0}).bind("mouseup touchend",function(){var i=a(this).parent().find(".ithoughts-attrs-container"),n=i.find("input:invalid").filter(t),r=i.attr("data-attr-family");if(console.log(n,i,r),n.length>0)return o[r]=!0,n.eq(0).focus(),void e.call(n.get(0));o[r]=!1;var s=i.find(".ithoughts-prototype"),l=s.clone().removeClass("ithoughts-prototype");console.log(l),i.append(l),l.find("input").blur(e).eq(0).focus(),e.call(l.find("input").get(0))}),a(".ithoughts-attrs-container input").blur(e)}()})}(Ithoughts);