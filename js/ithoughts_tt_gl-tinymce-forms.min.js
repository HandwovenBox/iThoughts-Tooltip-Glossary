/**
 * @file Client-side scripts for handling tooltip creation wizzard in Wordpress TinyMCE
 *
 * @author Gerkin
 * @copyright 2016 GerkinDevelopment
 * @license https://www.gnu.org/licenses/gpl-3.0.html GPLv3
 * @package ithoughts-tooltip-glossary
 *
 */
!function(t){"use strict";var e=t.$,i=t.$d,a=t.$w,n=ithoughts_tt_gl_editor;i.ready(function(){function t(t){try{tinymce.EditorManager.execCommand("mceRemoveEditor",!0,t)}catch(e){console.warn("Force cleaning needed: ",e),tinymce.EditorManager.editors=tinymce.EditorManager.editors.filter(function(e){return e.id!=t})}}function i(){var t=d.offset().top-a.scrollTop(),e=a.height(),i=e-t;c.css({maxHeight:i})}function o(){setTimeout(function(){d.find("*:focus").length||s.is(":focus")||c.addClass("hidden")},100)}function r(){var t=[],a=[];ithoughts_tt_gl_tinymce_form.terms.map(function(e){var i=e.title.toLowerCase().indexOf(m);return-1==i&&(i=e.slug.toLowerCase().indexOf(m)),-1!=i?0==i?void t.push(e):void a.push(e):void 0});var n=t.concat(a);d.empty();var o=n.length;if(o>0)for(var r=0;o>r;r++){var l=n[r];"undefined"==typeof l.thislang||l.thislang?d.append(e.parseHTML('<div tabindex="0" class="option" data-id="'+l.id+'" data-excerpt="'+l.content+'"><p><b>'+l.title+"</b><br><em>"+l.slug+"</em></p></div>")):d.append(e.parseHTML('<div tabindex="0" class="option foreign-language" data-id="'+l.id+'" data-excerpt="'+l.content+'"><p><b>'+l.title+"</b><br><em>"+l.slug+"</em></p></div>"))}else d.append(e.parseHTML('<p style="text-align:center"><em>No results</em><p>'));c.removeClass("hidden"),setTimeout(i,25),d.find(".option").on("click",function(t){e('[name="glossary_term_id"]').val(t.currentTarget.getAttribute("data-id")),s[0].value=e(t.currentTarget).find("p > b").text(),c.addClass("hidden")})}e(".tabs li").click(function(t){if(!e(this).hasClass("active")){e(this).parent().find(".active").removeClass("active"),e(this).addClass("active"),e(t.target).parent().parent().find(" > .active").removeClass("active");var i=e(t.target).index();e(e(t.target).parent().parent().children()[i+1]).addClass("active");var a=e("#ithoughts_tt_gl_link");a.prop("disabled",0==i)}});var l=e("#ithoughts_tt_gl-tooltip-form-container .tinymce");l.each(function(t,i){for(var a=i.value;null==i.getAttribute("id");){var n="editor"+Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,10);e(n).length||i.setAttribute("id",n)}var o=i.getAttribute("id");tinymce.init({selector:"#"+o,menubar:!1,external_plugins:{code:ithoughts_tt_gl_tinymce_form.base_tinymce+"/code/plugin.min.js",wordcount:ithoughts_tt_gl_tinymce_form.base_tinymce+"/wordcount/plugin.min.js"},plugins:"wplink",toolbar:["styleselect | bold italic underline link | bullist numlist | alignleft aligncenter alignright alignjustify | code"],min_height:70,height:70,resize:!1});var r=setInterval(function(){tinymce.get(o)&&(clearInterval(r),tinymce.get(o).setContent(a.replace(/&/g,"&amp;")))},50)}),e(".modeswitcher").on("click keyup",function(){var t=this.id;e("[data-"+t+"]:not([data-"+t+'="mediatip-'+this.value+'-type"])').hide(),e("[data-"+t+'~="mediatip-'+this.value+'-type"]').show()}).keyup(),e("#ithoughts_tt_gl_select_image").click(function(){onclickEntryPoint=this,window.mb=window.mb||{},window.mb.frame=wp.media({frame:"post",state:"insert",library:{type:["audio","video","image"]},multiple:!1}),window.mb.frame.on("insert",function(){var t=window.mb.frame.state().get("selection").first().toJSON();0>e.trim(t.url.length)||(e("#image-box-data").val(JSON.stringify({url:t.url,id:t.id,link:t.link})),e("#image-box").html('<img src="'+t.url+'"/>'),e("#mediatip_caption").val(t.caption),e("#ithoughts_tt_gl_link").val(t.link))}),window.mb.frame.open()});var s=e("#glossary_term"),d=e("#glossary_term_completer"),c=e("#glossary_term_completer_container"),m="",u=null;a.resize(i),s.on("keyup focusin",function(){u&&u.abort(),m=n.removeAccents(e(this).val().toLowerCase()),u=e.ajax({url:ithoughts_tt_gl_tinymce_form.admin_ajax,method:"POST",dataType:"json",data:{action:"ithoughts_tt_gl_get_terms_list",search:m},complete:function(t){var e=t.responseJSON;if("undefined"!=typeof e&&e.success){if(e.data.searched!=m)return void console.info("Outdated response");ithoughts_tt_gl_tinymce_form.terms=e.data.terms,r()}}}),r()}).on("focusout",o).on("keyup",function(){this.removeAttribute("data-term-id")}),e("#ithoughts_tt_gl-tinymce-validate").click(function(){var i={type:["glossary","tooltip","mediatip"][e(".tabs li.active").index()],text:e("#ithoughts_tt_gl_text").val(),link:e("#ithoughts_tt_gl_link").val()};switch(n.log("Before per-type form data handling:",i),i.type){case"glossary":i=e.extend(i,{glossary_id:e('[name="glossary_term_id"]').val(),disable_auto_translation:e('[name="glossary_disable_auto_translation"]').is(":checked")});break;case"tooltip":i=e.extend(i,{tooltip_content:tinymce.EditorManager.get("ithoughts_tt_gl-tooltip-content").getContent()||e("#ithoughts_tt_gl-tooltip-content").val()});break;case"mediatip":switch(i=e.extend(i,{mediatip_type:e("#mediatip_type").val()}),i.mediatip_type){case"localimage":i=e.extend(i,{mediatip_content:e("#image-box-data").val(),mediatip_caption:e("#mediatip_caption").val()});break;case"webimage":i=e.extend(i,{mediatip_content:e("#mediatip_url_image").val(),mediatip_caption:e("#mediatip_caption").val()});break;case"webvideo":i=e.extend(i,{mediatip_content:e("#mediatip_url_video_embed").val(),mediatip_link:e("#mediatip_url_video_link").val()})}}setTimeout(function(){t("ithoughts_tt_gl-tooltip-content")},500),n.finishTinymce(i)}),e("#ithoughts_tt_gl-tinymce-discard").click(function(){setTimeout(function(){t("ithoughts_tt_gl-tooltip-content")},500),n.finishTinymce()}),e("#mediatip_url_video_link").bind("keyup mouseup change click focusin focusout",function(){var t=null,i={direct:{regex:/^(.*\.mp4)(\?.*)?$/,embed:'<video width="512" height="288" controls="controls"><source src="$1" type="video/mp4" /></video>',video:"$1"},youtube:{regex:/^(?:https?:\/\/(?:youtu\.be\/|\w*\.youtube\.\w{2,3}\/watch\?v=)|<iframe .*?src="https?:\/\/\w*\.youtube\.\w{2,3}\/embed\/)([a-zA-Z0-9]*).*$/,embed:'<iframe width="512" height="288" src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>',video:"https://www.youtube.com/watch?v=$1"},dailymotion:{regex:/^(?:https?:\/\/(?:dai\.ly\/|\w*\.dailymotion\.\w{2,3}\/video\/)|<iframe .*?src=".*?\w*\.dailymotion\.\w{2,3}\/embed\/video\/)([a-zA-Z0-9]*).*/,embed:'<iframe width="512" height="288" src="https://www.dailymotion.com/embed/video/$1" frameborder="0" allowfullscreen></iframe>',video:"https://www.dailymotion.com/video/$1"}};for(var a in i)if(this.value.match(i[a].regex)){t={embed:this.value.replace(i[a].regex,i[a].embed),video:this.value.replace(i[a].regex,i[a].video)};break}t&&(e("#mediatip_url_video_embed").val(t.embed),e("#mediatip_url_video_link").val(t.video))}).keyup();var p=["span","link"];p.forEach(function(t){e("#kv-pair-"+t+"-attrs-add").click(function(){var i=e("#attributes-"+t+"-key"),a=e("#attributes-"+t+"-value"),n=e("#kv-pair-"+t+"-attrs");return function(){if(i.val().length>0){var t='<div id="'+i.val()+'"><button class="delete button" type="button">x</button><div class="kv"><p class="key">'+i.val()+'<p class="value">'+a.val()+"</p></div></div>";i.val(""),a.val(""),t=e(e.parseHTML(t)),t.find(".delete").click(function(){t.remove()}),n.append(t)}}}())})})}(Ithoughts.v4);