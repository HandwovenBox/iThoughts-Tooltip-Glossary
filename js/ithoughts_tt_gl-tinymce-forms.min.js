/**
 * @file Client-side scripts for handling tooltip creation wizzard in Wordpress TinyMCE
 *
 * @author Gerkin
 * @copyright 2016 GerkinDevelopment
 * @license http://www.gnu.org/licenses/old-licenses/gpl-2.0.fr.html GPLv2
 * @package ithoughts-tooltip-glossary
 *
 */
!function(t){"use strict";function e(t){var e=n("#ithoughts_tt_gl_link");switch(t){case 0:e.qtip({show:{event:"focus"},hide:{event:"blur"},content:{title:e.attr("data-warning-title"),button:!0,text:e.attr("data-warning-text")},position:{container:n("#ithoughts_tt_gl-tooltip-form")}});break;case 1:e.qtip("destroy",!0);break;case 2:e.qtip("destroy",!0)}}var i,a,n=t.$,o=t.$w,r=ithoughts_tt_gl,s=t.gei,l=t.qs;t.$d.ready(function(){function d(t){try{tinymce.EditorManager.execCommand("mceRemoveEditor",!0,t)}catch(e){console.warn("Force cleaning needed: ",e),tinymce.EditorManager.editors=tinymce.EditorManager.editors.filter(function(e){return e.id!=t})}}function c(){var t=v.offset().top-o.scrollTop(),e=o.height(),i=e-t;f.css({maxHeight:i})}function u(){setTimeout(function(){v.find("*:focus").length||g.is(":focus")||f.addClass("hidden")},100)}function m(){var e=[],i=[];t.tinymce.terms.map(function(t){var n=t.title.toLowerCase().indexOf(a);return-1==n&&(n=t.slug.toLowerCase().indexOf(a)),-1!=n?0==n?void e.push(t):void i.push(t):void 0});var o=e.concat(i);v.empty();var r=o.length;if(r>0)for(var s=0;r>s;s++){var l=o[s];"undefined"==typeof l.thislang||l.thislang?v.append(n.parseHTML('<div tabindex="0" class="option" data-id="'+l.id+'" data-excerpt="'+l.content+'"><p><b>'+l.title+"</b><br><em>"+l.slug+"</em></p></div>")):v.append(n.parseHTML('<div tabindex="0" class="option foreign-language" data-id="'+l.id+'" data-excerpt="'+l.content+'"><p><b>'+l.title+"</b><br><em>"+l.slug+"</em></p></div>"))}else v.append(n.parseHTML('<p style="text-align:center"><em>No results</em><p>'));f.removeClass("hidden"),setTimeout(c,25),v.find(".option").on("click",function(t){n('[name="glossary_term_id"]').val(t.currentTarget.getAttribute("data-id")),g[0].value=n(t.currentTarget).find("p > b").text(),f.addClass("hidden")})}ithoughts_tt_gl.doInitTooltips(),n(".tabs li").click(function(t){var e=n(t.target).index();n(this).hasClass("active")||(n(this).parent().find(".active").removeClass("active"),n(this).addClass("active"),n(t.target).parent().parent().find(" > .active").removeClass("active"),n(n(t.target).parent().parent().children()[e+1]).addClass("active"))}),n("#ithoughts_tt_gl-tabs-mode").click(function(t){n(this).hasClass("active")||e(n(t.target).index())});var h=parseInt(n("#ithoughts_tt_gl-tabs-mode").attr("data-init-tab-index"))||0;e(h),n(n("#ithoughts_tt_gl-tabs-mode").children()[h]).click();var p=n("#ithoughts_tt_gl-tooltip-form-container .tinymce");p.each(function(e,i){for(var a=i.value;null==i.getAttribute("id");){var n="editor"+Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,10);s(n)||i.setAttribute("id",n)}var o=i.getAttribute("id");tinymce.init({selector:"#"+o,menubar:!1,external_plugins:{code:t.tinymce.base_tinymce+"/code/plugin.min.js",wordcount:t.tinymce.base_tinymce+"/wordcount/plugin.min.js"},plugins:"wplink",toolbar:["styleselect | bold italic underline link | bullist numlist | alignleft aligncenter alignright alignjustify | code"],min_height:70,height:70,resize:!1});var r=setInterval(function(){tinymce.get(o)&&(clearInterval(r),tinymce.get(o).setContent(a.replace(/&/g,"&amp;")))},50)}),n(".modeswitcher").on("click keyup",function(){var t=this.id;n("[data-"+t+"]:not([data-"+t+'="mediatip-'+this.value+'-type"])').hide(),n("[data-"+t+'~="mediatip-'+this.value+'-type"]').show()}).keyup(),n("#ithoughts_tt_gl_select_image").click(function(){window.mb=window.mb||{},window.mb.frame=wp.media({frame:"post",state:"insert",library:{type:["audio","video","image"]},multiple:!1}),window.mb.frame.on("insert",function(){var t=window.mb.frame.state().get("selection").first().toJSON();0>n.trim(t.url.length)||(n("#image-box-data").val(JSON.stringify({url:t.url,id:t.id,link:t.link})),s("image-box").innerHTML='<img src="'+t.url+'"/>',s("mediatip_caption").value=t.caption,s("ithoughts_tt_gl_link").value=t.link)}),window.mb.frame.open()});var g=n("#glossary_term"),v=n("#glossary_term_completer"),f=n("#glossary_term_completer_container");o.resize(c);var _=null;g.on("keyup focusin",function(){_&&_.abort(),a=r.removeAccents(n(this).val().toLowerCase()),_=n.ajax({url:t.tinymce.admin_ajax,method:"POST",dataType:"json",data:{action:"ithoughts_tt_gl_get_terms_list",search:a},complete:function(e){var i=e.responseJSON;return"undefined"!=typeof i&&i.success?i.data.searched!=a?void console.info("Outdated response"):(t.tinymce.terms=i.data.terms,void m()):void console.error("Response is not a valid JSON")}}),m()}).on("focusout",u).on("keyup",function(){this.removeAttribute("data-term-id")}),n("#ithoughts_tt_gl-tinymce-validate").click(function(){var t={type:["glossary","tooltip","mediatip"][n(".tabs li.active").index()],text:s("ithoughts_tt_gl_text").value,link:s("ithoughts_tt_gl_link").value,opts:i};switch(t.type){case"glossary":t=n.extend(t,{glossary_id:n('[name="glossary_term_id"]').val(),disable_auto_translation:function(t){return t?t.checked:!1}(l('[name="glossary_disable_auto_translation"]'))});break;case"tooltip":t=n.extend(t,{tooltip_content:tinymce.EditorManager.get("ithoughts_tt_gl-tooltip-content").getContent()||n("#ithoughts_tt_gl-tooltip-content").val()});break;case"mediatip":switch(t=n.extend(t,{mediatip_type:n("#mediatip_type").val()}),t.mediatip_type){case"localimage":t=n.extend(t,{mediatip_content:n("#image-box-data").val(),mediatip_caption:n("#mediatip_caption").val()});break;case"webimage":t=n.extend(t,{mediatip_content:n("#mediatip_url_image").val(),mediatip_caption:n("#mediatip_caption").val()});break;case"webvideo":t=n.extend(t,{mediatip_content:n("#mediatip_url_video_embed").val(),mediatip_link:n("#mediatip_url_video_link").val()})}}setTimeout(function(){d("ithoughts_tt_gl-tooltip-content")},500),ithoughts_tt_gl.finishTinymce(t)}),n(".ithoughts_tt_gl-tinymce-discard").click(function(){setTimeout(function(){d("ithoughts_tt_gl-tooltip-content")},500),ithoughts_tt_gl.finishTinymce()}),function(){n("#mediatip_url_video_link").bind("keyup mouseup change click focusin focusout",function(){var t=null,e={direct:{regex:/^(.*\.mp4)(\?.*)?$/,embed:'<video width="512" height="288" controls="controls"><source src="$1" type="video/mp4" /></video>',video:"$1"},youtube:{regex:/^(?:https?:\/\/(?:youtu\.be\/|\w*\.youtube\.\w{2,3}\/watch\?v=)|<iframe .*?src="https?:\/\/\w*\.youtube\.\w{2,3}\/embed\/)([a-zA-Z0-9]*).*$/,embed:'<iframe width="512" height="288" src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>',video:"https://www.youtube.com/watch?v=$1"},dailymotion:{regex:/^(?:https?:\/\/(?:dai\.ly\/|\w*\.dailymotion\.\w{2,3}\/video\/)|<iframe .*?src=".*?\w*\.dailymotion\.\w{2,3}\/embed\/video\/)([a-zA-Z0-9]*).*/,embed:'<iframe width="512" height="288" src="https://www.dailymotion.com/embed/video/$1" frameborder="0" allowfullscreen></iframe>',video:"https://www.dailymotion.com/video/$1"}};for(var i in e)if(this.value.match(e[i].regex)){t={embed:this.value.replace(e[i].regex,e[i].embed),video:this.value.replace(e[i].regex,e[i].video)};break}t&&(n("#mediatip_url_video_embed").val(t.embed),n("#mediatip_url_video_link").val(t.video))}).keyup()}(),function(){function e(){return 0===n(this).closest(".ithoughts-prototype").length}function a(){var t=n(this),e=t.parent().parent(),i=e.find("input").filter(function(){return this!=t.get(0)});setTimeout(function(){var a=t.closest(".ithoughts-attrs-container").attr("data-attr-family");return r[a]?void(r[a]=!1):(t.val(t.val().trim()),i.val(i.val().trim()),void(t.val()||i.val()||document.activeElement==t.get(0)||document.activeElement==i.get(0)||e.remove()))},100)}var o=n("#ithoughts_tt_gl-tooltip-form-options"),r={span:!1,link:!1};o.find('input[type="checkbox"].ithoughts-tristate').attr("data-state",function(t,e){return((e||0)-1)%3+2}).change(function(t){var e=n(this),i=((e.attr("data-state")||0)-2)%3+1;console.log(i),e.attr("data-state",i),this.indeterminate=0==i,this.checked=1==i}).change(),n("#ithoughts_tt_gl-tinymce-advanced_options").click(function(){o.show()}),n("#ithoughts_tt_gl-tinymce-close-attrs").click(function(){o.hide()}),n("#ithoughts_tt_gl-tinymce-validate-attrs").click(function(){for(var t=n("#ithoughts_tt_gl-tooltip-form-options form"),e=t[0],a=e.elements,r=a.length,s={},l=!0,d=-1,c={},u=n("#attributes-list option").map(function(){return this.value}).toArray();++d<r&&l;){var m=a[d].validity;l&=m.valid,m.valid||(console.log("Form field invalid",a[d],m),a[d].focus())}if(l){t.find(".ithoughts-tristate").each(function(){console.log(n(this).serializeInputsObject({"-1":!1,0:null,1:!0}[this.dataset.state])),n.extend(!0,s,n(this).serializeInputsObject({"-1":!1,0:null,1:!0}[this.dataset.state]))}),i=n.extend(!0,t.serializeObject(),s);for(var h=["span","link"],d=0;2>d;d++){c[h[d]]={};for(var p=i["attributes-"+h[d]+"-key"]||[],g=i["attributes-"+h[d]+"-value"]||[],v=0,f=Math.min(p.length,g.length);f>v;v++)if(p[v]&&g[v]){var _=u.indexOf(p[v])>-1?"":"data-";c[h[d]][_+p[v]]=g[v]}delete i["attributes-"+h[d]+"-key"],delete i["attributes-"+h[d]+"-value"]}i.attributes=c,console.log(i),o.hide()}}),n("#qtip-keep-open").change(function(){var e,i=t.gei("qtiptrigger"),a=t.gei("qtiptriggerText");return function(){this.checked?(e=i.value,i.value=a.value="click",i.disabled=!(a.disabled=!1)):(i.value=a.value=e,i.disabled=!(a.disabled=!0))}}()),n('[name^="position[my]"]').change(function(){var t="position[my][",e=s(t+"1]"),i=s(t+"2]"),a=s(t+"invert]");return function(){e.required=i.required=e.value||i.value||a.checked}}()),n('[name^="position[at]"]').change(function(){var t="position[at][",e=s(t+"1]"),i=s(t+"2]");return function(){e.required=i.required=e.value||i.value}}()),n("#kv-pair-link-attrs-add,#kv-pair-span-attrs-add").bind("mousedown touchstart",function(){var t=n(this).parent().find(".ithoughts-attrs-container"),e=t.attr("data-attr-family");r[e]=!0}).bind("mouseup touchend",function(){var t=n(this).parent().find(".ithoughts-attrs-container"),i=t.find("input:invalid").filter(e),o=t.attr("data-attr-family");if(i.length>0)return r[o]=!0,i.eq(0).focus(),void a.call(i.get(0));r[o]=!1;var s=t.find(".ithoughts-prototype"),l=s.clone().removeClass("ithoughts-prototype"),d=["attributes-"+o+"-","-"+(new Date).getTime()];l.find(".dynamicId").each(function(){var t=n(this),e=d[0]+(t.hasClass("dynamicId-key")?"key":"value")+d[1];t.attr("LABEL"==this.tagName?"for":"id",e)}),l.find("input").prop("required",!0).prop("disabled",!1),t.append(l),l.find("input").blur(a).eq(0).focus(),a.call(l.find("input").get(0))}),n(".ithoughts-attrs-container input").blur(a)}()})}(Ithoughts.v3);