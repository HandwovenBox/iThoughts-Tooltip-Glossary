/**
 * @file Client-side scripts for handling tooltip creation wizzard in Wordpress TinyMCE
 *
 * @author Gerkin
 * @copyright 2016 GerkinDevelopment
 * @license https://www.gnu.org/licenses/gpl-3.0.html GPLv3
 * @package ithoughts-tooltip-glossary
 *
 * @version 2.7.0
 */
!function(t){"use strict";var e=t.$,i=t.$d,a=t.$w,n=ithoughts_tt_gl_editor;i.ready(function(){function t(t,i){t.click(function(t){e(this).parent().find(".active").removeClass("active"),e(this).addClass("active"),e(t.target).parent().parent().find(" > .active").removeClass("active");var a=e(t.target).index();e(e(t.target).parent().parent().children()[a+1]).addClass("active"),i&&i(a)}),t.filter(".active").click()}var i="";if(e("#ithoughts_tt_gl-tooltip-form-container").length)i="TIP";else{if(!e("#ithoughts_tt_gl-list-form-container").length)return;i="LIST"}"TIP"==i?!function(){function i(t){try{tinymce.EditorManager.execCommand("mceRemoveEditor",!0,t)}catch(e){console.warn("Force cleaning needed: ",e),tinymce.EditorManager.editors=tinymce.EditorManager.editors.filter(function(e){return e.id!=t})}}function o(){var t=u.offset().top-a.scrollTop(),e=a.height(),i=e-t;p.css({maxHeight:i})}function r(){setTimeout(function(){u.find("*:focus").length||d.is(":focus")||p.addClass("hidden")},100)}function s(){var t=[],i=[];n.terms.map(function(e){var a=e.title.toLowerCase().indexOf(h);return-1==a&&(a=e.slug.toLowerCase().indexOf(h)),-1!=a?0==a?void t.push(e):void i.push(e):void 0});var a=t.concat(i);u.empty();var r=a.length;if(r>0)for(var s=0;r>s;s++){var l=a[s];"undefined"==typeof l.thislang||l.thislang?u.append(e.parseHTML('<div tabindex="0" class="option" data-id="'+l.id+'" data-excerpt="'+l.content+'"><p><b>'+l.title+"</b><br><em>"+l.slug+"</em></p></div>")):u.append(e.parseHTML('<div tabindex="0" class="option foreign-language" data-id="'+l.id+'" data-excerpt="'+l.content+'"><p><b>'+l.title+"</b><br><em>"+l.slug+"</em></p></div>"))}else u.append(e.parseHTML('<p style="text-align:center"><em>No results</em><p>'));p.removeClass("hidden"),setTimeout(o,25),u.find(".option").on("click",function(t){e('[name="glossary_term_id"]').val(t.currentTarget.getAttribute("data-id")),d[0].value=e(t.currentTarget).find("p > b").text(),p.addClass("hidden")})}t(e("#ithoughts_tt_gl-tooltip-form .tabs li"),function(t){var i=e("#ithoughts_tt_gl_link");i.prop("disabled",0==t)}),t(e("#ithoughts_tt_gl-tooltip-form-options .tabs li"));var l=e("#ithoughts_tt_gl-tooltip-form-container .tinymce");l.each(function(t,i){for(var a=i.value;null==i.getAttribute("id");){var o="editor"+Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,10);e(o).length||i.setAttribute("id",o)}var r=i.getAttribute("id");tinymce.init({selector:"#"+r,menubar:!1,external_plugins:{code:n.base_tinymce+"/code/plugin.min.js",wordcount:n.base_tinymce+"/wordcount/plugin.min.js"},plugins:"wplink",toolbar:["styleselect | bold italic underline link | bullist numlist | alignleft aligncenter alignright alignjustify | code"],min_height:70,height:70,resize:!1});var s=setInterval(function(){var t=tinymce.get(r);t&&t.getDoc()&&t.getBody()&&(n.log("Initing subeditor with content ",JSON.stringify(a)),clearInterval(s),t.setContent(a.replace(/&/g,"&amp;")))},50)}),e(".modeswitcher").on("click keyup",function(){var t=this.id;e("[data-"+t+"]:not([data-"+t+'="mediatip-'+this.value+'-type"])').hide(),e("[data-"+t+'~="mediatip-'+this.value+'-type"]').show()}).keyup(),e("#ithoughts_tt_gl_select_image").click(function(){onclickEntryPoint=this,window.mb=window.mb||{},window.mb.frame=wp.media({frame:"post",state:"insert",library:{type:["audio","video","image"]},multiple:!1}),window.mb.frame.on("insert",function(){var t=window.mb.frame.state().get("selection").first().toJSON();0>e.trim(t.url.length)||(e("#image-box-data").val(JSON.stringify({url:t.url,id:t.id,link:t.link})),e("#image-box").html('<img src="'+t.url+'"/>'),e("#mediatip_caption").val(t.caption),e("#ithoughts_tt_gl_link").val(t.link))}),window.mb.frame.open()});var c,d=e("#glossary_term"),u=e("#glossary_term_completer"),p=e("#glossary_term_completer_container"),h="",g=null;a.resize(o),d.on("keyup focusin",function(){g&&g.abort(),h=n.removeAccents(e(this).val().toLowerCase()),g=e.ajax({url:n.admin_ajax,method:"POST",dataType:"json",data:{action:"ithoughts_tt_gl_get_terms_list",search:h},complete:function(t){var e=t.responseJSON;if("undefined"!=typeof e&&e.success){if(e.data.searched!=h)return void console.info("Outdated response");n.terms=e.data.terms,s()}}}),s()}).on("focusout",r).on("keyup",function(){this.removeAttribute("data-term-id")}),e("#ithoughts_tt_gl-tinymce-validate").click(function(){var t={type:["glossary","tooltip","mediatip"][e(".tabs li.active").index()],text:e("#ithoughts_tt_gl_text").val(),link:e("#ithoughts_tt_gl_link").val(),opts:c};switch(n.log("Before per-type form data handling:",t),t.type){case"glossary":t=e.extend(t,{glossary_id:e('[name="glossary_term_id"]').val(),disable_auto_translation:e('[name="glossary_disable_auto_translation"]').is(":checked")});break;case"tooltip":t=e.extend(t,{tooltip_content:tinymce.EditorManager.get("ithoughts_tt_gl-tooltip-content").getContent()||e("#ithoughts_tt_gl-tooltip-content").val()});break;case"mediatip":switch(t=e.extend(t,{mediatip_type:e("#mediatip_type").val()}),t.mediatip_type){case"localimage":t=e.extend(t,{mediatip_content:e("#image-box-data").val(),mediatip_caption:e("#mediatip_caption").val()});break;case"webimage":t=e.extend(t,{mediatip_content:e("#mediatip_url_image").val(),mediatip_caption:e("#mediatip_caption").val()});break;case"webvideo":t=e.extend(t,{mediatip_content:e("#mediatip_url_video_embed").val(),mediatip_link:e("#mediatip_url_video_link").val()})}}setTimeout(function(){i("ithoughts_tt_gl-tooltip-content")},500),n.finishTipTinymce(t)}),e(".ithoughts_tt_gl-tinymce-discard").click(function(){setTimeout(function(){i("ithoughts_tt_gl-tooltip-content")},500),n.finishTipTinymce()}),e("#mediatip_url_video_link").bind("keyup mouseup change click focusin focusout",function(){var t=null,i={direct:{regex:/^(.*\.mp4)(\?.*)?$/,embed:'<video width="512" height="288" controls="controls"><source src="$1" type="video/mp4" /></video>',video:"$1"},youtube:{regex:/^(?:https?:\/\/(?:youtu\.be\/|\w*\.youtube\.\w{2,3}\/watch\?v=)|<iframe .*?src="https?:\/\/\w*\.youtube\.\w{2,3}\/embed\/)([a-zA-Z0-9]*).*$/,embed:'<iframe width="512" height="288" src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>',video:"https://www.youtube.com/watch?v=$1"},dailymotion:{regex:/^(?:https?:\/\/(?:dai\.ly\/|\w*\.dailymotion\.\w{2,3}\/video\/)|<iframe .*?src=".*?\w*\.dailymotion\.\w{2,3}\/embed\/video\/)([a-zA-Z0-9]*).*/,embed:'<iframe width="512" height="288" src="https://www.dailymotion.com/embed/video/$1" frameborder="0" allowfullscreen></iframe>',video:"https://www.dailymotion.com/video/$1"}};for(var a in i)if(this.value.match(i[a].regex)){t={embed:this.value.replace(i[a].regex,i[a].embed),video:this.value.replace(i[a].regex,i[a].video)};break}t&&(e("#mediatip_url_video_embed").val(t.embed),e("#mediatip_url_video_link").val(t.video))}).keyup(),function(){function t(){for(var t,i=s[0],a=i.elements,n={},o=!0,r=a.length,l=-1,c={},d=e("#attributes-list option").map(function(){return this.value}).toArray();++l<r&&o;){var u=a[l].validity;o&=u.valid,u.valid||a[l].focus()}s.find(".ithoughts-tristate").each(function(){e.extend(!0,n,e(this).serializeInputsObject({"-1":!1,0:null,1:!0}[this.dataset.state]))}),t=e.extend(!0,s.serializeObject(),n);for(var p=["span","link"],l=0;2>l;l++){var h=p[l];c[h]={};for(var g=t["attributes-"+h+"-key"]||[],m=t["attributes-"+h+"-value"]||[],v=0,f=Math.min(g.length,m.length);f>v;v++)if(g[v]&&m[v]){var _=d.indexOf(g[v])>-1?"":"data-";c[h][_+g[v]]=m[v]}delete t["attributes-"+h+"-value"],delete t["attributes-"+h+"-key"]}return t.attributes=c,t}function i(){return 0===e(this).closest(".ithoughts-prototype").length}function a(){var t=e(this),i=t.parent().parent(),a=i.find("input").filter(function(){return this!=t.get(0)});setTimeout(function(){var e=t.closest(".ithoughts-attrs-container").attr("data-attr-family");return r[e]?void(r[e]=!1):(t.val(t.val().trim()),a.val(a.val().trim()),void(t.val()||a.val()||document.activeElement==t.get(0)||document.activeElement==a.get(0)||i.remove()))},100)}var n=e("#ithoughts_tt_gl-tooltip-form-options"),o=e("#ithoughts_tt_gl-tooltip-form"),r={span:!1,link:!1},s=e("#ithoughts_tt_gl-tooltip-form-options form");n.find('input[type="checkbox"].ithoughts-tristate').attr("data-state",function(t,e){return((e||0)-1)%3+2}).change(function(t){var i=e(this),a=((i.attr("data-state")||0)-2)%3+1;i.attr("data-state",a),this.checked=1==a,this.indeterminate=0==a}).change(),c=t(),e("#ithoughts_tt_gl-tinymce-advanced_options").click(function(){n.show(),o.hide()}),e("#ithoughts_tt_gl-tinymce-close-attrs").click(function(){n.hide(),o.show()}),e("#ithoughts_tt_gl-tinymce-validate-attrs").click(function(){c=t(),n.hide(),o.show()}),e("#qtip-keep-open").change(function(){var t,i=e("#qtiptrigger"),a=e("#qtiptriggerText"),n=e([i,a]);return function(){i.prop("disabled",this.checked),a.prop("disabled",!this.checked),n.val(this.checked?"click":t),this.checked?t=i.value:i.disabled=!(a.disabled=!0)}}()),e('[name^="position[my]"]').change(function(){var t="#position[my][",i=e(t+"1]"),a=e(t+"2]"),n=e(a.get(0),i.get(0)),o=e(t+"invert]");return function(){n.prop("required",i.val()||a.val()||o.prop("checked"))}}()),e('[name^="position[at]"]').change(function(){var t="#position[at][",i=e(t+"1]"),a=e(t+"2]"),n=e(a.get(0),i.get(0));return function(){n.prop("required",i.val()||a.val())}}()),e("#kv-pair-link-attrs-add,#kv-pair-span-attrs-add").bind("mousedown touchstart",function(){var t=e(this).parent().find(".ithoughts-attrs-container");t.attr("data-attr-family")}).bind("mouseup touchend",function(){r[o]=!0;var t=e(this).parent().find(".ithoughts-attrs-container"),n=t.find("input:invalid").filter(i),o=t.attr("data-attr-family");if(n.length>0)return r[o]=!0,n.eq(0).focus(),a.call(n.get(0)),void(r[o]=!1);var s=t.find(".ithoughts-prototype"),l=s.clone().removeClass("ithoughts-prototype"),c=["attributes-"+o+"-","-"+(new Date).getTime()];l.find(".dynamicId").each(function(){var t=e(this),i=c[0]+(t.hasClass("dynamicId-key")?"key":"value")+c[1];t.attr("LABEL"==this.tagName?"for":"id",i)}),l.find("input").prop("required",!0).prop("disabled",!1),t.append(l),l.find("input").blur(a).eq(0).focus(),a.call(l.find("input").get(0))}),e(".ithoughts-attrs-container input").blur(a)}()}():"LIST"==i&&!function(){t(e(".tabs li")),function(){var t=e("#groups"),i=e("#groups_text"),n=e("#groupspicker"),o=e([n.get(0),i.parent().get(0)]),r=e("#groupspicker .group-select input");i.focusin(function(){function t(){n.toggleClass("hidden"),o.off("click",e)}function e(t){t.stopImmediatePropagation()}n.toggleClass("hidden"),o.click(e),a.one("click",t)}),r.change(function(){var a=r.filter(":checked"),n=[],o=[];a.each(function(){n.push(e(this).parent().find(".group-title").text()),o.push(e(this).val())}),t.val(o.join(",")),i.val(n.join(", "))}).change()}(),e("#ithoughts_tt_gl-tinymce-validate").click(function(){var t={type:["atoz","list"][e(".tabs li.active").index()],alpha:e("#letters").val(),group:e("#groups").val()};switch(t.alpha||delete t.alpha,t.group||delete t.group,t.type){case"list":e.extend(t,{desc:e("#description_mode").val(),cols:e("#columns_count").val()})}n.finishListTinymce(t)}),e(".ithoughts_tt_gl-tinymce-discard").click(function(){n.finishListTinymce()})}()})}(Ithoughts.v4);