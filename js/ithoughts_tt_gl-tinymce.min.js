/**
 * @file TinyMCE plugin scripts
 *
 * @author Gerkin
 * @copyright 2016 GerkinDevelopment
 * @license http://www.gnu.org/licenses/old-licenses/gpl-2.0.fr.html GPLv2
 * @package ithoughts-tooltip-glossary
 *
 */
!function(t){"use strict";function e(e){for(var a=t.replaceShortcodesEl.length,i=0;a>i;i++)e=t.replaceShortcodesEl[i](e);return e}function a(e){for(var a=t.restoreShortcodesEl.length,i=0;a>i;i++)e=t.restoreShortcodesEl[i](e);return e}var i=t.$,o=t.$w,n=ithoughts_tt_gl,r="ithoughts_tt_gl",l=r+"_tinymce",s="ithoughts-tooltip-glossary",p="ithoughts_tooltip_glossary",d=n.stripQuotes,g=t.isNA,u=/[¹²³áàâãäåaaaÀÁÂÃÄÅAAAÆccç©CCÇÐÐèéê?ëeeeeeÈÊË?EEEEE€gGiìíîïìiiiÌÍÎÏ?ÌIIIlLnnñNNÑòóôõöoooøÒÓÔÕÖOOOØŒr®Ršs?ßŠS?ùúûüuuuuÙÚÛÜUUUUýÿÝŸžzzŽZZ]/g,c={"¹":"1","²":"2","³":"3","á":"a","à":"a","â":"a","ã":"a","ä":"a","å":"a",a:"a",a:"a",a:"a","À":"a","Á":"a","Â":"a","Ã":"a","Ä":"a","Å":"a",A:"a",A:"a",A:"a","Æ":"a",c:"c",c:"c","ç":"c","©":"c",C:"c",C:"c","Ç":"c","Ð":"d","Ð":"d","è":"e","é":"e","ê":"e","?":"e","ë":"e",e:"e",e:"e",e:"e",e:"e",e:"e","È":"e","Ê":"e","Ë":"e","?":"e",E:"e",E:"e",E:"e",E:"e",E:"e","€":"e",g:"g",G:"g",i:"i","ì":"i","í":"i","î":"i","ï":"i","ì":"i",i:"i",i:"i",i:"i","Ì":"i","Í":"i","Î":"i","Ï":"i","?":"i","Ì":"i",I:"i",I:"i",I:"i",l:"l",L:"l",n:"n",n:"n","ñ":"n",N:"n",N:"n","Ñ":"n","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o",o:"o",o:"o",o:"o","ø":"o","Ò":"o","Ó":"o","Ô":"o","Õ":"o","Ö":"o",O:"o",O:"o",O:"o","Ø":"o","Œ":"o",r:"r","®":"r",R:"r","š":"s",s:"s","?":"s","ß":"s","Š":"s",S:"s","?":"s","ù":"u","ú":"u","û":"u","ü":"u",u:"u",u:"u",u:"u",u:"u","Ù":"u","Ú":"u","Û":"u","Ü":"u",U:"u",U:"u",U:"u",U:"u","ý":"y","ÿ":"y","Ý":"y","Ÿ":"y","ž":"z",z:"z",z:"z","Ž":"z",Z:"z",Z:"z"};n.removeAccents=function(t){return t.replace(u,function(t){return c[t]})},tinyMCE.setToggleable=function(t,e){return function(){var a=this;e.on(t,function(t){a.active(t.active)})}},tinymce.PluginManager.add(l,function(t,u){function c(e){var a={list:{alpha:"",cols:"",desc:"",group:""},atoz:{group:"",alpha:"",lazy:!0},type:0},i="insert_content";sel=t.selection;var o=sel.getStart();o===sel.getEnd()&&("ithoughts-tooltip-glossary-atoz"==o.getAttribute("data-type")?(i="load",a.type=1,a.atoz={alpha:o.getAttribute("data-alpha"),group:o.getAttribute("data-group"),lazy:"true"===o.getAttribute("data-lazy")}):"ithoughts-tooltip-glossary-term_list"==o.getAttribute("data-type")&&(i="load",a.type=0,a.list={alpha:o.getAttribute("data-alpha"),cols:o.getAttribute("data-cols"),desc:o.getAttribute("data-desc"),group:o.getAttribute("data-group")})),y=a.type,t.windowManager.open({title:t.getLang(l+".insert_index"),margin:"0 0 0 0",padding:"0 0 0 0",border:"0 0 0 0",body:[new tinyMCE.ui.TabPanel({margin:"0 0 0 0",padding:"0 0 0 0",border:"0 0 0 0",onclick:function(t){try{t.target.id.match(/^mceu_\d+-t(\d+)$/)&&(y=t.target.id.replace(/^mceu_\d+-t(\d+)$/,"$1"))}catch(t){}},items:[new tinyMCE.ui.Factory.create({type:"form",title:t.getLang(l+".list"),items:[{type:"textbox",label:t.getLang(l+".letters"),name:"ll",value:a.list.alpha,tooltip:t.getLang(l+".letters_explain")},{type:"textbox",label:t.getLang(l+".columns"),name:"lc",value:a.list.cols,tooltip:t.getLang(l+".columns_explain")},{type:"listbox",label:t.getLang(l+".description"),name:"ld",values:[{text:"None",value:""},{text:t.getLang(l+".excerpt"),value:"excerpt"},{text:t.getLang(l+".full"),value:"full"},{text:t.getLang(l+".glossarytips"),value:"glossarytips"}],value:a.list.desc,tooltip:t.getLang(l+".description_explain")},{type:"textbox",label:t.getLang(l+".group"),name:"lg",value:a.list.group,tooltip:t.getLang(l+".group_explain")}]}),new tinyMCE.ui.Factory.create({type:"form",title:t.getLang(l+".atoz"),items:[{type:"textbox",label:t.getLang(l+".letters"),name:"al",value:a.atoz.alpha,tooltip:t.getLang(l+".letters_explain")},{type:"textbox",label:t.getLang(l+".group"),name:"ag",value:a.atoz.group,tooltip:t.getLang(l+".group_explain")}]})],activeTab:a.type})],onsubmit:function(e){switch("load"==i&&sel.select(sel.getStart()),parseInt(y)){case 0:var a=[];e.data.ll&&a.push('alpha="'+d(e.data.ll,!0)+'"'),e.data.lg&&a.push('group="'+d(e.data.lg,!0)+'"'),e.data.lc&&a.push('cols="'+d(e.data.lc,!0)+'"'),e.data.ld&&a.push('desc="'+d(e.data.ld,!0)+'"'),t.insertContent("[glossary_term_list"+(a.length>0?" "+a.join(" "):"")+" /]");break;case 1:var a=[];e.data.al&&a.push('alpha="'+d(e.data.al,!0)+'"'),e.data.ag&&a.push('group="'+d(e.data.ag,!0)+'"'),t.insertContent("[glossary_atoz"+(a.length>0?" "+a.join(" "):"")+" /]")}}})}function m(e){function a(t,e){!g(e)&&e||(t="data-"+t);var a=_[t];return delete _[t],a}function l(t){return"true"===t?!0:"false"===t?!1:null}var s={},u=t.selection,c="",m=["ithoughts-tooltip-glossary-term","ithoughts-tooltip-glossary-tooltip","ithoughts-tooltip-glossary-mediatip"];if(u.getStart()===u.getEnd()){var y=u.getContent({format:"text"});if(m.indexOf(u.getStart().getAttribute("data-type"))>-1){c="load";for(var f,h=u.getStart(),_=(i(h),{}),x=0,v=h.attributes,b=v.length;b>x;x++)f=v[x],_[f.nodeName]=f.nodeValue;var A=(a("position-at")||" ").split(" "),w=(a("position-my")||" ").split(" "),q=1===Math.max(w.indexOf("top"),w.indexOf("bottom"))||0===Math.max(w.indexOf("right"),w.indexOf("left"));A={1:A[0],2:A[1]},w={1:w[q?1:0],2:w[q?0:1],invert:q?"enabled":void 0},s={text:y,link:a("href",!0),tooltip_content:d(a("tooltip-content")||y,!1),glossary_id:a("glossary-id"),term_search:n.removeAccents(y.toLowerCase()),mediatip_type:a("mediatip-type"),mediatip_content:d(a("mediatip-content"),!1),mediatip_link:a("mediatip-link"),mediatip_caption:a("mediatip-caption"),type:["glossary","tooltip","mediatip"][m.indexOf(a("type"))],glossary_disable_auto_translation:"true"===(a("disable_auto_translation")||!1),opts:{termcontent:a("termcontent"),"qtip-keep-open":"true"===a("qtip-keep-open"),qtiprounded:l(a("qtiprounded")),qtipshadow:l(a("qtipshadow")),qtipstyle:a("qtipstyle"),qtiptrigger:a("qtiptrigger"),position:{at:A,my:w},attributes:{span:{},link:{}},anim:{"in":a("animation_in"),out:a("animation_out"),time:a("animation_time")},maxwidth:a("tooltip-maxwidth")}},console.log("Values:",s);for(var x in _)x.match(/^data-link-/)?s.opts.attributes.link[x.replace(/^data-link-/,"")]=_[x]:s.opts.attributes.span[x.replace(/^data-/,"")]=_[x]}else if(y&&y.length>0)c="insert_content",s={text:y,link:"",tooltip_content:y,glossary_id:null,term_search:n.removeAccents(y.toLowerCase()),mediatip_type:"",mediatip_content:"",mediatip_caption:"",type:"tooltip",glossary_disable_auto_translation:!1};else{var C=u.getRng(),k=C.commonAncestorContainer.textContent;k.length}}i.ajax({method:"POST",async:!0,url:n.admin_ajax,data:{action:r+"_get_tinymce_tooltip_form",data:s},success:function(e){var a=i(i.parseHTML(e,!0)),l=400,m=455,y=a.find("#"+r+"-tooltip-form"),f=a.find("#"+r+"-tooltip-form-options");o.on("resize",function(){var t={width:m+"px",height:l+"px",left:(o.width()-m)/2+"px",top:(o.height()-l)/2+"px"};y.css(t),f.css(t)}).resize(),i(document.body).append(a.css({opacity:0}).animate({opacity:1},500)),n.finishTinymce=function(){var e=a;return function(a){function i(t,e,a){return e=(e+"").trim(),t.match(/^[\w_\-]*$/)?d(t.trim(),!0)+'="'+(!g(a)&&a?e.replace(/"/g,"&aquot;").replace(/\n/g,"<br/>"):d(e,!0))+'"':null}function o(t,e,a){m.push(i(t,e,a)),m=m.filter(function(t){return!g(t)})}console.log(a);var n=e.find("#attributes-list option").map(function(){return this.value}).toArray();if(e.animate({opacity:0},500,function(){e.remove()}),"undefined"!=typeof a){if("load"==c)u.select(u.getStart());else if(c.indexOf("extend")>-1){C=u.getRng(!0);var r=JSON.parse(c.match(/extend(.*)$/)[1]),l=C.commonAncestorContainer.textContent;C.commonAncestorContainer.textContent=l.slice(0,r[0])+l.slice(r[1],l.length-1),t.fire("DblClick")}var m=[],y=a.opts||s.opts;if(console.log("Opts",a.opts,s.opts),console.log("Before add opts",y),!g(y)){if(y["qtip-content"]&&o("data-termcontent",y["qtip-content"]),y["qtip-keep-open"]&&o("data-qtip-keep-open","true"),g(y.qtiprounded)||o("data-qtiprounded",y.qtiprounded+""),g(y.qtipshadow)||o("data-qtipshadow",y.qtipshadow+""),y.qtipstyle&&o("data-qtipstyle",y.qtipstyle),y.qtiptrigger&&o("data-qtiptrigger",y.qtiptrigger),y.position&&(y.position.at&&y.position.at[1]&&y.position.at[2]&&o("data-position-at",y.position.at[1]+" "+y.position.at[2]),y.position.my&&y.position.my[1]&&y.position.my[2])){var f=[y.position.my[1],y.position.my[2]];y.position.my.invert&&f.reverse(),o("data-position-my",f.join(" "))}y.anim&&(y.anim["in"]&&o("data-animation_in",y.anim["in"]),y.anim.out&&o("data-animation_out",y.anim.out),y.anim.time&&o("data-animation_time",y.anim.time)),y.maxwidth&&o("data-tooltip-maxwidth",y.maxwidth);for(var h=["span","link"],_=0;2>_;_++)for(var x in y.attributes[h[_]])if(x&&y.attributes[h[_]][x]){console.log(x,y.attributes[h[_]][x]);var v=n.indexOf(x)>-1?"":"data-",b="link"==h[_]?"link-":"";o(v+b+x,y.attributes[h[_]][x],!0)}}switch(a.link&&o("href",encodeURI(a.link)),console.log(m),a.type){case"glossary":if(""==a.term_id||""==a.text)return;o("glossary-id",a.glossary_id),a.disable_auto_translation&&o("disable_auto_translation","true"),t.insertContent("["+p+"-glossary "+m.join(" ")+"]"+a.text+"[/"+p+"-glossary]"+("load"!=c?" ":""));break;case"tooltip":if(""==a.tooltip_content||""==a.text)return;o("tooltip-content",a.tooltip_content,!0),t.insertContent("["+p+"-tooltip "+m.join(" ")+"]"+a.text+"[/"+p+"-tooltip]"+("load"!=c?" ":""));break;case"mediatip":if(""==a.mediatip_type||""==a.mediatip_content||""==a.text)return;o("mediatip-type",a.mediatip_type),o("mediatip-content",a.mediatip_content,!0),o("mediatip-link",a.mediatip_link),a.mediatip_caption&&o("mediatip-caption",a.mediatip_caption,!0),t.insertContent("["+p+"-mediatip "+m.join(" ")+"]"+a.text+"[/"+p+"-mediatip]"+("load"!=c?" ":""))}}}}()},error:function(){console.error("Error while getting TinyMCE form.",arguments)}})}t.addButton("glossaryterm",{title:t.getLang(l+".add_tooltip"),image:u+"/icon/glossaryterm.png",onclick:m,onPostRender:tinymce.setToggleable("glossaryterm",t)});var y=0;t.addButton("glossarylist",{title:t.getLang(l+".add_index"),image:u+"/icon/glossaryindex.png",onPostRender:tinymce.setToggleable("glossarylist",t),onclick:c}),t.contentCSS.push(u+"/../css/"+r+"-admin.css?v=2.1.7"),t.on("BeforeSetcontent",function(t){t.content=e(t.content)}),t.on("GetContent",function(t){t.content=a(t.content)}),t.onNodeChange.add(function(e,a,i){i.getAttribute("data-type")==s+"-term"||i.getAttribute("data-type")==s+"-tooltip"||i.getAttribute("data-type")==s+"-mediatip"?t.fire("glossaryterm",{active:!0}):t.fire("glossaryterm",{active:!1}),i.getAttribute("data-type")==s+"-term_list"||i.getAttribute("data-type")==s+"-atoz"?t.fire("glossarylist",{active:!0}):t.fire("glossarylist",{active:!1})})});var m=["href"];t.replaceShortcodesEl=[function(t){return t.replace(/\[(?:ithoughts_tooltip_glossary-)?(glossary|tooltip|mediatip)(?!_)(.*?)\](.*?)\[\/(?:ithoughts_tooltip_glossary-)?(glossary|tooltip|mediatip)\]/g,function(t,e,a,i){for(var o={},n=/([\w\d\-]+?)="(.+?)"/g,r=null;r=n.exec(a);)o[r[1]]=r[2];var l='<a data-type="'+s+"-"+["term","tooltip","mediatip"][["glossary","tooltip","mediatip"].indexOf(e)]+'"';for(var p in o)l+=m.indexOf(p)>-1||0==p.indexOf("data-")?" "+p+'="'+o[p]+'"':" data-"+p+'="'+o[p]+'"';return l+">"+i+"</a>"})},function(t){return t.replace(/\[glossary_(term_list|atoz)(.*?)\/\]/g,function(t,e,a){for(var i={},o=/([\w\d\-]+?)="(.+?)"/g,n=null;n=o.exec(a);)i[n[1]]=n[2];var r='<span data-type="'+s+"-"+e+'"';for(var l in i)r+=m.indexOf(l)>-1||0==l.indexOf("data-")?" "+l+'="'+i[l]+'"':" data-"+l+'="'+i[l]+'"';return r+">Glossary "+("term_list"==e?"List":"A-to-Z")+"</span>"})}],t.restoreShortcodesEl=[function(t){return t.replace(/<a\s+(?=[^>]*data-type="ithoughts-tooltip-glossary-(term|tooltip|mediatip)")(.*?)>(.*?)<\/a>/g,function(t,e,a,i){for(var o={},n=/(data-)?([\w\d\-]+?)="(.+?)"/g,r=null;r=n.exec(a);)"data-"==r[1]&&"type"==r[2]||(m.indexOf(r[2])>-1&&"undefined"!=typeof r[1]?o[r[1]+r[2]]=r[3]:o[r[2]]=r[3]);var l=["glossary","tooltip","mediatip"][["term","tooltip","mediatip"].indexOf(e)],s="["+p+"-"+l;for(var d in o)s+=" "+d+'="'+o[d]+'"';return s+"]"+i+"[/"+p+"-"+l+"]"})},function(t){return t.replace(/<span\s+(?=[^>]*data-type="ithoughts-tooltip-glossary-(term_list|atoz)")(.*?)>.*?<\/span>/g,function(t,e,a){for(var i={},o=/(data-)?([\w\d\-]+?)="(.+?)"/g,n=null;n=o.exec(a);)"data-"==n[1]&&"type"==n[2]||(m.indexOf(l)>-1&&"undefined"!=typeof n[1]?i[n[1]+n[2]]=n[3]:i[n[2]]=n[3]);var r="[glossary_"+e;for(var l in i)r+=" "+l+'="'+i[l]+'"';return r+"/]"})}]}(Ithoughts);