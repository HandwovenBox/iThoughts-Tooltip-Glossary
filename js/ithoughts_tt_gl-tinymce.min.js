/**
 * @file TinyMCE plugin scripts
 *
 * @author Gerkin
 * @copyright 2016 GerkinDevelopment
 * @license http://www.gnu.org/licenses/old-licenses/gpl-2.0.fr.html GPLv2
 * @package ithoughts-tooltip-glossary
 *
 */
!function(t){"use strict";function e(e){for(var a=t.replaceShortcodesEl.length,i=0;a>i;i++)e=t.replaceShortcodesEl[i](e);return e}function a(e){for(var a=t.restoreShortcodesEl.length,i=0;a>i;i++)e=t.restoreShortcodesEl[i](e);return e}var i=t.$,o=t.$w,n=ithoughts_tt_gl,r="ithoughts_tt_gl",l=r+"_tinymce",s="ithoughts-tooltip-glossary",p="ithoughts_tooltip_glossary",d=n.stripQuotes,g=t.isNA;tinyMCE.setToggleable=function(t,e){return function(){var a=this;e.on(t,function(t){a.active(t.active)})}},tinymce.PluginManager.add(l,function(c,u){function m(t){var e={list:{alpha:"",cols:"",desc:"",group:""},atoz:{group:"",alpha:"",lazy:!0},type:0},a="insert_content";sel=c.selection;var i=sel.getStart();i===sel.getEnd()&&("ithoughts-tooltip-glossary-atoz"==i.getAttribute("data-type")?(a="load",e.type=1,e.atoz={alpha:i.getAttribute("data-alpha"),group:i.getAttribute("data-group"),lazy:"true"===i.getAttribute("data-lazy")}):"ithoughts-tooltip-glossary-term_list"==i.getAttribute("data-type")&&(a="load",e.type=0,e.list={alpha:i.getAttribute("data-alpha"),cols:i.getAttribute("data-cols"),desc:i.getAttribute("data-desc"),group:i.getAttribute("data-group")})),f=e.type,c.windowManager.open({title:c.getLang(l+".insert_index"),margin:"0 0 0 0",padding:"0 0 0 0",border:"0 0 0 0",body:[new tinyMCE.ui.TabPanel({margin:"0 0 0 0",padding:"0 0 0 0",border:"0 0 0 0",onclick:function(t){try{t.target.id.match(/^mceu_\d+-t(\d+)$/)&&(f=t.target.id.replace(/^mceu_\d+-t(\d+)$/,"$1"))}catch(t){}},items:[new tinyMCE.ui.Factory.create({type:"form",title:c.getLang(l+".list"),items:[{type:"textbox",label:c.getLang(l+".letters"),name:"ll",value:e.list.alpha,tooltip:c.getLang(l+".letters_explain")},{type:"textbox",label:c.getLang(l+".columns"),name:"lc",value:e.list.cols,tooltip:c.getLang(l+".columns_explain")},{type:"listbox",label:c.getLang(l+".description"),name:"ld",values:[{text:"None",value:""},{text:c.getLang(l+".excerpt"),value:"excerpt"},{text:c.getLang(l+".full"),value:"full"},{text:c.getLang(l+".glossarytips"),value:"glossarytips"}],value:e.list.desc,tooltip:c.getLang(l+".description_explain")},{type:"textbox",label:c.getLang(l+".group"),name:"lg",value:e.list.group,tooltip:c.getLang(l+".group_explain")}]}),new tinyMCE.ui.Factory.create({type:"form",title:c.getLang(l+".atoz"),items:[{type:"textbox",label:c.getLang(l+".letters"),name:"al",value:e.atoz.alpha,tooltip:c.getLang(l+".letters_explain")},{type:"textbox",label:c.getLang(l+".group"),name:"ag",value:e.atoz.group,tooltip:c.getLang(l+".group_explain")}]})],activeTab:e.type})],onsubmit:function(t){switch("load"==a&&sel.select(sel.getStart()),parseInt(f)){case 0:var e=[];t.data.ll&&e.push('alpha="'+d(t.data.ll,!0)+'"'),t.data.lg&&e.push('group="'+d(t.data.lg,!0)+'"'),t.data.lc&&e.push('cols="'+d(t.data.lc,!0)+'"'),t.data.ld&&e.push('desc="'+d(t.data.ld,!0)+'"'),c.insertContent("[glossary_term_list"+(e.length>0?" "+e.join(" "):"")+" /]");break;case 1:var e=[];t.data.al&&e.push('alpha="'+d(t.data.al,!0)+'"'),t.data.ag&&e.push('group="'+d(t.data.ag,!0)+'"'),c.insertContent("[glossary_atoz"+(e.length>0?" "+e.join(" "):"")+" /]")}}})}function y(e){function a(t,e){!g(e)&&e||(t="data-"+t);var a=x[t];return delete x[t],a}function l(t){return"true"===t?!0:"false"===t?!1:null}var s={},u=c.selection,m="",y=["ithoughts-tooltip-glossary-term","ithoughts-tooltip-glossary-tooltip","ithoughts-tooltip-glossary-mediatip"];if(u.getStart()===u.getEnd()){var f=u.getContent({format:"text"});if(y.indexOf(u.getStart().getAttribute("data-type"))>-1){m="load";for(var h,_=u.getStart(),x=(i(_),{}),v=0,b=_.attributes,w=b.length;w>v;v++)h=b[v],x[h.nodeName]=h.nodeValue;var q=(a("position-at")||" ").split(" "),k=(a("position-my")||" ").split(" "),L=1===Math.max(k.indexOf("top"),k.indexOf("bottom"))||0===Math.max(k.indexOf("right"),k.indexOf("left"));q={1:q[0],2:q[1]},k={1:k[L?1:0],2:k[L?0:1],invert:L?"enabled":void 0},s={text:f,link:a("href",!0),tooltip_content:d(a("tooltip-content")||f,!1),glossary_id:a("glossary-id"),term_search:t.removeAccents(f.toLowerCase()),mediatip_type:a("mediatip-type"),mediatip_content:d(a("mediatip-content"),!1),mediatip_link:a("mediatip-link"),mediatip_caption:a("mediatip-caption"),type:["glossary","tooltip","mediatip"][y.indexOf(a("type"))],glossary_disable_auto_translation:"true"===(a("disable_auto_translation")||!1),opts:{termcontent:a("termcontent"),"qtip-keep-open":"true"===a("qtip-keep-open"),qtiprounded:l(a("qtiprounded")),qtipshadow:l(a("qtipshadow")),qtipstyle:a("qtipstyle"),qtiptrigger:a("qtiptrigger"),position:{at:q,my:k},attributes:{span:{},link:{}},anim:{"in":a("animation_in"),out:a("animation_out"),time:a("animation_time")},maxwidth:a("tooltip-maxwidth")}},console.log("Values:",s);for(var v in x)v.match(/^data-link-/)?s.opts.attributes.link[v.replace(/^data-link-/,"")]=x[v]:s.opts.attributes.span[v.replace(/^data-/,"")]=x[v]}else if(f&&f.length>0)m="insert_content",s={text:f,link:"",tooltip_content:f,glossary_id:null,term_search:t.removeAccents(f.toLowerCase()),mediatip_type:"",mediatip_content:"",mediatip_caption:"",type:"tooltip",glossary_disable_auto_translation:!1};else{var A=u.getRng(),C=A.commonAncestorContainer.textContent;C.length}}i.ajax({method:"POST",async:!0,url:n.admin_ajax,data:{action:r+"_get_tinymce_tooltip_form",data:s},success:function(t){var e=i(i.parseHTML(t,!0)),a=400,l=455,y=e.find("#"+r+"-tooltip-form"),f=e.find("#"+r+"-tooltip-form-options");o.on("resize",function(){var t={width:l+"px",height:a+"px",left:(o.width()-l)/2+"px",top:(o.height()-a)/2+"px"};y.css(t),f.css(t)}).resize(),i(document.body).append(e.css({opacity:0}).animate({opacity:1},500)),n.finishTinymce=function(){var t=e;return function(e){function a(t,e,a){return e=(e+"").trim(),t.match(/^[\w_\-]*$/)?d(t.trim(),!0)+'="'+(!g(a)&&a?e.replace(/"/g,"&aquot;").replace(/\n/g,"<br/>"):d(e,!0))+'"':null}function i(t,e,i){l.push(a(t,e,i)),l=l.filter(function(t){return!g(t)})}console.log(e);var o=t.find("#attributes-list option").map(function(){return this.value}).toArray();if(t.animate({opacity:0},500,function(){t.remove()}),"undefined"!=typeof e){if("load"==m)u.select(u.getStart());else if(m.indexOf("extend")>-1){A=u.getRng(!0);var n=JSON.parse(m.match(/extend(.*)$/)[1]),r=A.commonAncestorContainer.textContent;A.commonAncestorContainer.textContent=r.slice(0,n[0])+r.slice(n[1],r.length-1),c.fire("DblClick")}var l=[],y=e.opts||s.opts;if(console.log("Opts",e.opts,s.opts),console.log("Before add opts",y),!g(y)){if(y["qtip-content"]&&i("data-termcontent",y["qtip-content"]),y["qtip-keep-open"]&&i("data-qtip-keep-open","true"),g(y.qtiprounded)||i("data-qtiprounded",y.qtiprounded+""),g(y.qtipshadow)||i("data-qtipshadow",y.qtipshadow+""),y.qtipstyle&&i("data-qtipstyle",y.qtipstyle),y.qtiptrigger&&i("data-qtiptrigger",y.qtiptrigger),y.position&&(y.position.at&&y.position.at[1]&&y.position.at[2]&&i("data-position-at",y.position.at[1]+" "+y.position.at[2]),y.position.my&&y.position.my[1]&&y.position.my[2])){var f=[y.position.my[1],y.position.my[2]];y.position.my.invert&&f.reverse(),i("data-position-my",f.join(" "))}y.anim&&(y.anim["in"]&&i("data-animation_in",y.anim["in"]),y.anim.out&&i("data-animation_out",y.anim.out),y.anim.time&&i("data-animation_time",y.anim.time)),y.maxwidth&&i("data-tooltip-maxwidth",y.maxwidth);for(var h=["span","link"],_=0;2>_;_++)for(var x in y.attributes[h[_]])if(x&&y.attributes[h[_]][x]){console.log(x,y.attributes[h[_]][x]);var v=o.indexOf(x)>-1?"":"data-",b="link"==h[_]?"link-":"";i(v+b+x,y.attributes[h[_]][x],!0)}}switch(e.link&&i("href",encodeURI(e.link)),console.log(l),e.type){case"glossary":if(""==e.term_id||""==e.text)return;i("glossary-id",e.glossary_id),e.disable_auto_translation&&i("disable_auto_translation","true"),c.insertContent("["+p+"-glossary "+l.join(" ")+"]"+e.text+"[/"+p+"-glossary]"+("load"!=m?" ":""));break;case"tooltip":if(""==e.tooltip_content||""==e.text)return;i("tooltip-content",e.tooltip_content,!0),c.insertContent("["+p+"-tooltip "+l.join(" ")+"]"+e.text+"[/"+p+"-tooltip]"+("load"!=m?" ":""));break;case"mediatip":if(""==e.mediatip_type||""==e.mediatip_content||""==e.text)return;i("mediatip-type",e.mediatip_type),i("mediatip-content",e.mediatip_content,!0),i("mediatip-link",e.mediatip_link),e.mediatip_caption&&i("mediatip-caption",e.mediatip_caption,!0),c.insertContent("["+p+"-mediatip "+l.join(" ")+"]"+e.text+"[/"+p+"-mediatip]"+("load"!=m?" ":""))}}}}()},error:function(){console.error("Error while getting TinyMCE form.",arguments)}})}c.addButton("glossaryterm",{title:c.getLang(l+".add_tooltip"),image:u+"/icon/glossaryterm.png",onclick:y,onPostRender:tinymce.setToggleable("glossaryterm",c)});var f=0;c.addButton("glossarylist",{title:c.getLang(l+".add_index"),image:u+"/icon/glossaryindex.png",onPostRender:tinymce.setToggleable("glossarylist",c),onclick:m}),c.contentCSS.push(u+"/../css/"+r+"-admin.css?v=2.1.7"),c.on("BeforeSetcontent",function(t){t.content=e(t.content)}),c.on("GetContent",function(t){t.content=a(t.content)}),c.onNodeChange.add(function(t,e,a){a.getAttribute("data-type")==s+"-term"||a.getAttribute("data-type")==s+"-tooltip"||a.getAttribute("data-type")==s+"-mediatip"?c.fire("glossaryterm",{active:!0}):c.fire("glossaryterm",{active:!1}),a.getAttribute("data-type")==s+"-term_list"||a.getAttribute("data-type")==s+"-atoz"?c.fire("glossarylist",{active:!0}):c.fire("glossarylist",{active:!1})})});var c=["href"];t.replaceShortcodesEl=[function(t){return t.replace(/\[(?:ithoughts_tooltip_glossary-)?(glossary|tooltip|mediatip)(?!_)(.*?)\](.*?)\[\/(?:ithoughts_tooltip_glossary-)?(glossary|tooltip|mediatip)\]/g,function(t,e,a,i){for(var o={},n=/([\w\d\-]+?)="(.+?)"/g,r=null;r=n.exec(a);)o[r[1]]=r[2];var l='<a data-type="'+s+"-"+["term","tooltip","mediatip"][["glossary","tooltip","mediatip"].indexOf(e)]+'"';for(var p in o)l+=c.indexOf(p)>-1||0==p.indexOf("data-")?" "+p+'="'+o[p]+'"':" data-"+p+'="'+o[p]+'"';return l+">"+i+"</a>"})},function(t){return t.replace(/\[glossary_(term_list|atoz)(.*?)\/\]/g,function(t,e,a){for(var i={},o=/([\w\d\-]+?)="(.+?)"/g,n=null;n=o.exec(a);)i[n[1]]=n[2];var r='<span data-type="'+s+"-"+e+'"';for(var l in i)r+=c.indexOf(l)>-1||0==l.indexOf("data-")?" "+l+'="'+i[l]+'"':" data-"+l+'="'+i[l]+'"';return r+">Glossary "+("term_list"==e?"List":"A-to-Z")+"</span>"})}],t.restoreShortcodesEl=[function(t){return t.replace(/<a\s+(?=[^>]*data-type="ithoughts-tooltip-glossary-(term|tooltip|mediatip)")(.*?)>(.*?)<\/a>/g,function(t,e,a,i){for(var o={},n=/(data-)?([\w\d\-]+?)="(.+?)"/g,r=null;r=n.exec(a);)"data-"==r[1]&&"type"==r[2]||(c.indexOf(r[2])>-1&&"undefined"!=typeof r[1]?o[r[1]+r[2]]=r[3]:o[r[2]]=r[3]);var l=["glossary","tooltip","mediatip"][["term","tooltip","mediatip"].indexOf(e)],s="["+p+"-"+l;for(var d in o)s+=" "+d+'="'+o[d]+'"';return s+"]"+i+"[/"+p+"-"+l+"]"})},function(t){return t.replace(/<span\s+(?=[^>]*data-type="ithoughts-tooltip-glossary-(term_list|atoz)")(.*?)>.*?<\/span>/g,function(t,e,a){for(var i={},o=/(data-)?([\w\d\-]+?)="(.+?)"/g,n=null;n=o.exec(a);)"data-"==n[1]&&"type"==n[2]||(c.indexOf(l)>-1&&"undefined"!=typeof n[1]?i[n[1]+n[2]]=n[3]:i[n[2]]=n[3]);var r="[glossary_"+e;for(var l in i)r+=" "+l+'="'+i[l]+'"';return r+"/]"})}]}(Ithoughts);