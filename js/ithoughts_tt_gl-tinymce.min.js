/**
 * @file TinyMCE plugin scripts
 *
 * @author Gerkin
 * @copyright 2016 GerkinDevelopment
 * @license http://www.gnu.org/licenses/old-licenses/gpl-2.0.fr.html GPLv2
 * @package ithoughts-tooltip-glossary
 *
 * @version 2.5.0
 */
function replaceShortcodes(t){for(var e=replaceShortcodesEl.length,o=0;e>o;o++)t=replaceShortcodesEl[o](t);return t}function restoreShortcodes(t){for(var e=restoreShortcodesEl.length,o=0;e>o;o++)t=restoreShortcodesEl[o](t);return t}function replaceHtmlAmp(t){return t.replace(/&amp;/g,"&")}!function(){tinyMCE.setToggleable=function(t,e){return function(){var o=this;e.on(t,function(t){o.active(t.active)})}},tinymce.PluginManager.add("ithoughts_tt_gl_tinymce",function(t,e){function o(e){var o={list:{alpha:"",cols:"",desc:"",group:""},atoz:{group:"",alpha:"",lazy:!0},type:0},i="insert_content";sel=t.selection;var n=sel.getStart();n===sel.getEnd()&&("ithoughts-tooltip-glossary-atoz"==n.getAttribute("data-type")?(i="load",o.type=1,o.atoz={alpha:n.getAttribute("data-alpha"),group:n.getAttribute("data-group"),lazy:"true"===n.getAttribute("data-lazy")}):"ithoughts-tooltip-glossary-term_list"==n.getAttribute("data-type")&&(i="load",o.type=0,o.list={alpha:n.getAttribute("data-alpha"),cols:n.getAttribute("data-cols"),desc:n.getAttribute("data-desc"),group:n.getAttribute("data-group")})),a=o.type,t.windowManager.open({title:t.getLang("ithoughts_tt_gl_tinymce.insert_index"),margin:"0 0 0 0",padding:"0 0 0 0",border:"0 0 0 0",body:[new tinyMCE.ui.TabPanel({margin:"0 0 0 0",padding:"0 0 0 0",border:"0 0 0 0",onclick:function(t){try{t.target.id.match(/^mceu_\d+-t(\d+)$/)&&(a=t.target.id.replace(/^mceu_\d+-t(\d+)$/,"$1"))}catch(t){}},items:[new tinyMCE.ui.Factory.create({type:"form",title:t.getLang("ithoughts_tt_gl_tinymce.list"),items:[{type:"textbox",label:t.getLang("ithoughts_tt_gl_tinymce.letters"),name:"ll",value:o.list.alpha,tooltip:t.getLang("ithoughts_tt_gl_tinymce.letters_explain")},{type:"textbox",label:t.getLang("ithoughts_tt_gl_tinymce.columns"),name:"lc",value:o.list.cols,tooltip:t.getLang("ithoughts_tt_gl_tinymce.columns_explain")},{type:"listbox",label:t.getLang("ithoughts_tt_gl_tinymce.description"),name:"ld",values:[{text:"None",value:""},{text:t.getLang("ithoughts_tt_gl_tinymce.excerpt"),value:"excerpt"},{text:t.getLang("ithoughts_tt_gl_tinymce.full"),value:"full"},{text:t.getLang("ithoughts_tt_gl_tinymce.glossarytips"),value:"glossarytips"}],value:o.list.desc,tooltip:t.getLang("ithoughts_tt_gl_tinymce.description_explain")},{type:"textbox",label:t.getLang("ithoughts_tt_gl_tinymce.group"),name:"lg",value:o.list.group,tooltip:t.getLang("ithoughts_tt_gl_tinymce.group_explain")}]}),new tinyMCE.ui.Factory.create({type:"form",title:t.getLang("ithoughts_tt_gl_tinymce.atoz"),items:[{type:"textbox",label:t.getLang("ithoughts_tt_gl_tinymce.letters"),name:"al",value:o.atoz.alpha,tooltip:t.getLang("ithoughts_tt_gl_tinymce.letters_explain")},{type:"textbox",label:t.getLang("ithoughts_tt_gl_tinymce.group"),name:"ag",value:o.atoz.group,tooltip:t.getLang("ithoughts_tt_gl_tinymce.group_explain")}]})],activeTab:o.type})],onsubmit:function(e){switch("load"==i&&sel.select(sel.getStart()),parseInt(a)){case 0:var o=[];e.data.ll&&o.push('alpha="'+stripQuotes(e.data.ll,!0)+'"'),e.data.lg&&o.push('group="'+stripQuotes(e.data.lg,!0)+'"'),e.data.lc&&o.push('cols="'+stripQuotes(e.data.lc,!0)+'"'),e.data.ld&&o.push('desc="'+stripQuotes(e.data.ld,!0)+'"'),t.insertContent("[glossary_term_list"+(o.length>0?" "+o.join(" "):"")+" /]");break;case 1:var o=[];e.data.al&&o.push('alpha="'+stripQuotes(e.data.al,!0)+'"'),e.data.ag&&o.push('group="'+stripQuotes(e.data.ag,!0)+'"'),t.insertContent("[glossary_atoz"+(o.length>0?" "+o.join(" "):"")+" /]")}}})}function i(e){var o={},i=t.selection,a="",n=["ithoughts-tooltip-glossary-term","ithoughts-tooltip-glossary-tooltip","ithoughts-tooltip-glossary-mediatip"];if(i.getStart()===i.getEnd()){var l=i.getContent({format:"text"});if(n.indexOf(i.getStart().getAttribute("data-type"))>-1){a="load";var s=i.getStart();console.log("Auto translation",s.getAttribute("data-disable_auto_translation")),o={text:l,link:s.getAttribute("href"),tooltip_content:stripQuotes((s.getAttribute("data-tooltip-content")?s.getAttribute("data-tooltip-content"):null)||l,!1),glossary_id:s.getAttribute("data-glossary-id"),term_search:removeAccents(l.toLowerCase()),mediatip_type:s.getAttribute("data-mediatip-type"),mediatip_content:stripQuotes(s.getAttribute("data-mediatip-content"),!1),mediatip_link:s.getAttribute("data-mediatip-link"),mediatip_caption:s.getAttribute("data-mediatip-caption"),type:["glossary","tooltip","mediatip"][n.indexOf(s.getAttribute("data-type"))],glossary_disable_auto_translation:s.getAttribute("data-disable_auto_translation")?"true"===s.getAttribute("data-disable_auto_translation"):!1},console.log(o)}else if(l&&l.length>0)a="insert_content",o={text:l,link:"",tooltip_content:l,glossary_id:null,term_search:removeAccents(l.toLowerCase()),mediatip_type:"",mediatip_content:"",mediatip_caption:"",type:"tooltip",glossary_disable_auto_translation:!1};else{var r=i.getRng(),g=r.commonAncestorContainer.textContent;g.length}}$.post(ithoughts_tt_gl.admin_ajax,{action:"ithoughts_tt_gl_get_tinymce_tooltip_form",data:o},function(e){var o=$($.parseHTML(e,!0)).css({opacity:0}),n=400,l=455,s=o.find("#ithoughts_tt_gl-tooltip-form"),g=o.find("#ithoughts_tt_gl-tooltip-form-options");$w.on("resize",function(){var t={width:l+"px",height:n+"px",left:($w.width()-l)/2+"px",top:($w.height()-n)/2+"px"};s.css(t),g.css(t)}).resize(),$("body").append(o.animate({opacity:1},500)),ithoughts_tt_gl.finishTinymce=function(){var e=o;return function(o){if(console.log(o),e.animate({opacity:0},500,function(){e.remove()}),"undefined"!=typeof o){if("load"==a)i.select(i.getStart());else if(a.indexOf("extend")>-1){r=i.getRng(!0);var n=JSON.parse(a.match(/extend(.*)$/)[1]),l=r.commonAncestorContainer.textContent;r.commonAncestorContainer.textContent=l.slice(0,n[0])+l.slice(n[1],l.length-1),t.fire("DblClick")}switch(o.type){case"glossary":if(""==o.term_id||""==o.text)return;t.insertContent('[ithoughts_tooltip_glossary-glossary glossary-id="'+o.glossary_id+'"'+(o.disable_auto_translation?' disable_auto_translation="true"':"")+"]"+o.text+"[/ithoughts_tooltip_glossary-glossary]"+("load"!=a?" ":""));break;case"tooltip":if(""==o.tooltip_content||""==o.text)return;t.insertContent('[ithoughts_tooltip_glossary-tooltip tooltip-content="'+stripQuotes(o.tooltip_content.trim(),!0)+'"'+(o.link&&o.link.length>0?' href="'+encodeURI(o.link)+'"':"")+"]"+o.text+"[/ithoughts_tooltip_glossary-tooltip]"+("load"!=a?" ":""));break;case"mediatip":if(""==o.mediatip_type||""==o.mediatip_content||""==o.text)return;t.insertContent('[ithoughts_tooltip_glossary-mediatip mediatip-type="'+o.mediatip_type+'" mediatip-content="'+stripQuotes(o.mediatip_content,!0)+'" mediatip-link="'+o.mediatip_link+'"'+(o.mediatip_caption.length>0?' mediatip-caption="'+stripQuotes(o.mediatip_caption,!0)+'"':"")+(o.link&&o.link.length>0?' href="'+encodeURI(o.link)+'"':"")+"]"+o.text+"[/ithoughts_tooltip_glossary-mediatip]"+("load"!=a?" ":""))}}}}()})}editorG=t,t.addButton("glossaryterm",{title:t.getLang("ithoughts_tt_gl_tinymce.add_tooltip"),image:e+"/icon/glossaryterm.png",onclick:i,onPostRender:tinymce.setToggleable("glossaryterm",t)});var a=0;t.addButton("glossarylist",{title:t.getLang("ithoughts_tt_gl_tinymce.add_index"),image:e+"/icon/glossaryindex.png",onPostRender:tinymce.setToggleable("glossarylist",t),onclick:o}),t.contentCSS.push(e+"/../css/ithoughts_tooltip_glossary-admin.css?v=2.1.7"),t.on("BeforeSetcontent",function(t){t.content=replaceShortcodes(t.content)}),t.on("GetContent",function(t){t.content=restoreShortcodes(t.content)}),t.onNodeChange.add(function(e,o,i){"ithoughts-tooltip-glossary-term"==i.getAttribute("data-type")||"ithoughts-tooltip-glossary-tooltip"==i.getAttribute("data-type")||"ithoughts-tooltip-glossary-mediatip"==i.getAttribute("data-type")?t.fire("glossaryterm",{active:!0}):t.fire("glossaryterm",{active:!1}),"ithoughts-tooltip-glossary-term_list"==i.getAttribute("data-type")||"ithoughts-tooltip-glossary-atoz"==i.getAttribute("data-type")?t.fire("glossarylist",{active:!0}):t.fire("glossarylist",{active:!1})})})}();var htmlAttrs=["href"];replaceShortcodesEl=[function(t){return t.replace(/\[(?:ithoughts_tooltip_glossary-)?(glossary|tooltip|mediatip)(?!_)(.*?)\](.*?)\[\/(?:ithoughts_tooltip_glossary-)?(glossary|tooltip|mediatip)\]/g,function(t,e,o,i){for(var a={},n=/([\w\d\-]+?)="(.+?)"/g,l=null;l=n.exec(o);)a[l[1]]=l[2];var s='<a data-type="ithoughts-tooltip-glossary-'+["term","tooltip","mediatip"][["glossary","tooltip","mediatip"].indexOf(e)]+'"';for(var r in a)s+=htmlAttrs.indexOf(r)>-1||0==r.indexOf("data-")?" "+r+'="'+a[r]+'"':" data-"+r+'="'+a[r]+'"';return s+">"+i+"</a>"})},function(t){return t.replace(/\[glossary_(term_list|atoz)(.*?)\/\]/g,function(t,e,o){for(var i={},a=/([\w\d\-]+?)="(.+?)"/g,n=null;n=a.exec(o);)i[n[1]]=n[2];var l='<span data-type="ithoughts-tooltip-glossary-'+e+'"';for(var s in i)l+=htmlAttrs.indexOf(s)>-1||0==s.indexOf("data-")?" "+s+'="'+i[s]+'"':" data-"+s+'="'+i[s]+'"';return l+">Glossary "+("term_list"==e?"List":"A-to-Z")+"</span>"})}],restoreShortcodesEl=[function(t){return t.replace(/<a\s+(?=[^>]*data-type="ithoughts-tooltip-glossary-(term|tooltip|mediatip)")(.*?)>(.*?)<\/a>/g,function(t,e,o,i){for(var a={},n=/(data-)?([\w\d\-]+?)="(.+?)"/g,l=null;l=n.exec(o);)"data-"==l[1]&&"type"==l[2]||(htmlAttrs.indexOf(l[2])>-1&&"undefined"!=typeof l[1]?a[l[1]+l[2]]=l[3]:a[l[2]]=l[3]);var s=["glossary","tooltip","mediatip"][["term","tooltip","mediatip"].indexOf(e)],r="[ithoughts_tooltip_glossary-"+s;for(var g in a)r+=" "+g+'="'+a[g]+'"';return r+"]"+i+"[/ithoughts_tooltip_glossary-"+s+"]"})},function(t){return t.replace(/<span\s+(?=[^>]*data-type="ithoughts-tooltip-glossary-(term_list|atoz)")(.*?)>.*?<\/span>/g,function(t,e,o){for(var i={},a=/(data-)?([\w\d\-]+?)="(.+?)"/g,n=null;n=a.exec(o);)"data-"==n[1]&&"type"==n[2]||(htmlAttrs.indexOf(s)>-1&&"undefined"!=typeof n[1]?i[n[1]+n[2]]=n[3]:i[n[2]]=n[3]);var l="[glossary_"+e;for(var s in i)l+=" "+s+'="'+i[s]+'"';return l+"/]"})}];