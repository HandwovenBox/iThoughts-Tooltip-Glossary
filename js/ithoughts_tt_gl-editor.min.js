/*global Ithoughts, ithoughts_tt_gl, tinyMCE, tinymce */
!function(t){"use strict";t.$d.ready(function(){function e(){var t=i("#content").get(0),e={html:t.value.substring(t.selectionStart,t.selectionEnd)};return e.DOM=i.parseHTML(e.html),e.start=i(e.DOM).first().get(0),e.end=i(e.DOM).last().get(0),e}var i=t.$,o=t.$w,a=ithoughts_tt_gl,n=ithoughts_tt_gl_editor,r=a.stripQuotes,l="ithoughts_tt_gl",s="ithoughts_tooltip_glossary",p=["ithoughts-tooltip-glossary-term","ithoughts-tooltip-glossary-tooltip","ithoughts-tooltip-glossary-mediatip"],d=t.isNA;t.initLoggers(n,"iThoughts Tooltip Glossary",n.jslog),n.removeAccents=function(t){var e=/[¹²³áàâãäåaaaÀÁÂÃÄÅAAAÆccç©CCÇÐÐèéê?ëeeeeeÈÊË?EEEEE€gGiìíîïìiiiÌÍÎÏ?ÌIIIlLnnñNNÑòóôõöoooøÒÓÔÕÖOOOØŒr®Ršs?ßŠS?ùúûüuuuuÙÚÛÜUUUUýÿÝŸžzzŽZZ]/g,i={"¹":"1","²":"2","³":"3","á":"a","à":"a","â":"a","ã":"a","ä":"a","å":"a",a:"a","À":"a","Á":"a","Â":"a","Ã":"a","Ä":"a","Å":"a",A:"a","Æ":"a",c:"c","ç":"c","©":"c",C:"c","Ç":"c","Ð":"d","è":"e","é":"e","ê":"e","?":"s","ë":"e",e:"e","È":"e","Ê":"e","Ë":"e",E:"e","€":"e",g:"g",G:"g",i:"i","ì":"i","í":"i","î":"i","ï":"i","Ì":"i","Í":"i","Î":"i","Ï":"i",I:"i",l:"l",L:"l",n:"n","ñ":"n",N:"n","Ñ":"n","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o",o:"o","ø":"o","Ò":"o","Ó":"o","Ô":"o","Õ":"o","Ö":"o",O:"o","Ø":"o","Œ":"o",r:"r","®":"r",R:"r","š":"s",s:"s","ß":"s","Š":"s",S:"s","ù":"u","ú":"u","û":"u","ü":"u",u:"u","Ù":"u","Ú":"u","Û":"u","Ü":"u",U:"u","ý":"y","ÿ":"y","Ý":"y","Ÿ":"y","ž":"z",z:"z","Ž":"z",Z:"z"};return t.replace(e,function(t){return i[t]})},console.log("Initing editor forms"),n.editorForms={list:function(t,e,i){n.info("Selection infos to load TIP: ",t);var o,a="insert_content",l={list:{alpha:"",cols:"",desc:"",group:""},atoz:{group:"",alpha:"",lazy:!0},type:0};ce===sel.getEnd()&&("ithoughts-tooltip-glossary-atoz"===ce.getAttribute("data-type")?(a="load",l.type=1,l.atoz={alpha:ce.getAttribute("data-alpha"),group:ce.getAttribute("data-group"),lazy:"true"===ce.getAttribute("data-lazy")}):"ithoughts-tooltip-glossary-term_list"===ce.getAttribute("data-type")&&(a="load",l.type=0,l.list={alpha:ce.getAttribute("data-alpha"),cols:ce.getAttribute("data-cols"),desc:ce.getAttribute("data-desc"),group:ce.getAttribute("data-group")})),o=l.type,editor.windowManager.open({title:editor.getLang(prefix2+".insert_index"),margin:"0 0 0 0",padding:"0 0 0 0",border:"0 0 0 0",body:[new tinyMCE.ui.TabPanel({margin:"0 0 0 0",padding:"0 0 0 0",border:"0 0 0 0",onclick:function(t){try{t.target.id.match(/^mceu_\d+-t(\d+)$/)&&(o=t.target.id.replace(/^mceu_\d+-t(\d+)$/,"$1"))}catch(e){}},items:[new tinyMCE.ui.Factory.create({type:"form",title:editor.getLang(prefix2+".list"),items:[{type:"textbox",label:editor.getLang(prefix2+".letters"),name:"ll",value:l.list.alpha,tooltip:editor.getLang(prefix2+".letters_explain")},{type:"textbox",label:editor.getLang(prefix2+".columns"),name:"lc",value:l.list.cols,tooltip:editor.getLang(prefix2+".columns_explain")},{type:"listbox",label:editor.getLang(prefix2+".description"),name:"ld",values:[{text:"None",value:""},{text:editor.getLang(prefix2+".excerpt"),value:"excerpt"},{text:editor.getLang(prefix2+".full"),value:"full"},{text:editor.getLang(prefix2+".glossarytips"),value:"glossarytips"}],value:l.list.desc,tooltip:editor.getLang(prefix2+".description_explain")},{type:"textbox",label:editor.getLang(prefix2+".group"),name:"lg",value:l.list.group,tooltip:editor.getLang(prefix2+".group_explain")}]}),new tinyMCE.ui.Factory.create({type:"form",title:editor.getLang(prefix2+".atoz"),items:[{type:"textbox",label:editor.getLang(prefix2+".letters"),name:"al",value:l.atoz.alpha,tooltip:editor.getLang(prefix2+".letters_explain")},{type:"textbox",label:editor.getLang(prefix2+".group"),name:"ag",value:l.atoz.group,tooltip:editor.getLang(prefix2+".group_explain")}]})],activeTab:l.type})],onsubmit:function(t){"load"===a&&sel.select(sel.getStart());var i,n=parseInt(o,10),l=t.data;return 0===n?(i=[],l.ll&&i.push('alpha="'+r(l.ll,!0)+'"'),l.lg&&i.push('group="'+r(l.lg,!0)+'"'),l.lc&&i.push('cols="'+r(l.lc,!0)+'"'),l.ld&&i.push('desc="'+r(l.ld,!0)+'"'),e("[glossary_term_list"+(i.length>0?" "+i.join(" "):"")+" /]")):1===n?(i=[],l.al&&i.push('alpha="'+r(l.al,!0)+'"'),l.ag&&i.push('group="'+r(l.ag,!0)+'"'),e("[glossary_atoz"+(i.length>0?" "+i.join(" "):"")+" /]")):void 0}})},tip:function(t,e,a){n.info("Selection infos to load TIP: ",t);var g,u,c,m,h,y,_,f,x,b,v={},T=t,w=(i(t.DOM),t.DOM),q="",L=-1;if(T.start===T.end)if(n.log("Start & End node are the same, operating on a node of type "+T.start.nodeName),g=T.start&&T.start.text||T.html,T.start&&"#text"!=T.start.nodeName&&p.indexOf(T.start.getAttribute("data-type"))>-1){for(q="load",m={},u=w.attributes,c=u.length;(L+=1)<c;)h=u[L],m[h.nodeName]=h.nodeValue;y=function(t,e){!d(e)&&e||(t="data-"+t);var i=m[t];return delete m[t],i},_=(y("position-at")||" ").split(" "),f=(y("position-my")||" ").split(" "),x=1===Math.max(f.indexOf("top"),f.indexOf("bottom"))||0===Math.max(f.indexOf("right"),f.indexOf("left")),_={1:_[0],2:_[1]},f={1:f[x?1:0],2:f[x?0:1],invert:x?"enabled":void 0},b=function(t){return"true"===t?!0:"false"===t?!1:null},v={text:g,link:y("href",!0),tooltip_content:r(y("tooltip-content")||g,!1),glossary_id:y("glossary-id"),term_search:n.removeAccents(g.toLowerCase()),mediatip_type:y("mediatip-type"),mediatip_content:r(y("mediatip-content"),!1),mediatip_link:y("mediatip-link"),mediatip_caption:y("mediatip-caption"),type:["glossary","tooltip","mediatip"][p.indexOf(y("type"))],glossary_disable_auto_translation:"true"===(y("disable_auto_translation")||!1),opts:{termcontent:y("termcontent"),"qtip-keep-open":"true"===y("qtip-keep-open"),qtiprounded:b(y("qtiprounded")),qtipshadow:b(y("qtipshadow")),qtipstyle:y("qtipstyle"),qtiptrigger:y("qtiptrigger"),position:{at:_,my:f},attributes:{span:{},link:{}},anim:{"in":y("animation_in"),out:y("animation_out"),time:y("animation_time")},maxwidth:y("tooltip-maxwidth")}};for(L in m)m.hasOwnProperty(L)&&(L.match(/^data-link-/)?v.opts.attributes.link[L.replace(/^data-link-/,"")]=m[L]:v.opts.attributes.span[L.replace(/^data-/,"")]=m[L])}else g&&g.length>0?(q="replace_content",v={text:g,link:"",tooltip_content:g,glossary_id:null,term_search:n.removeAccents(g.toLowerCase()),mediatip_type:"",mediatip_content:"",mediatip_caption:"",type:"tooltip",glossary_disable_auto_translation:!1}):(q="add_content",v={text:"",link:"",tooltip_content:"",glossary_id:null,term_search:n.removeAccents(g.toLowerCase()),mediatip_type:"",mediatip_content:"",mediatip_caption:"",type:"tooltip",glossary_disable_auto_translation:!1});i.ajax({method:"POST",async:!0,url:n.admin_ajax,data:{action:l+"_get_tinymce_tooltip_form",data:v},success:function(t){var a=i(i.parseHTML(t,!0)),p=400,u=455,c=a.find("#"+l+"-tooltip-form"),m=a.find("#"+l+"-tooltip-form-options");o.on("resize",function(){var t={width:u+"px",height:p+"px",left:(o.width()-u)/2+"px",top:(o.height()-p)/2+"px"};c.css(t),m.css(t)}).resize(),i(document.body).append(a.css({opacity:0}).animate({opacity:1},500)),n.finishTinymce=function(){var t=a;return function(i){if(n.info("New tooltip data:",i),t.animate({opacity:0},500,function(){t.remove()}),"undefined"!=typeof i){var o,a,l,p,u=t.find("#attributes-list option").map(function(){return this.value}).toArray(),c=[],m=i.opts||v.opts,h=function(t,e,i){return e=String(e).trim(),t.match(/^[\w_\-]*$/)?r(t.trim(),!0)+'="'+(!d(i)&&i?e.replace(/"/g,"&aquot;").replace(/\n/g,"<br/>"):r(e,!0))+'"':null},y=function(t,e,i){c.push(h(t,e,i)),c=c.filter(function(t){return!d(t)})},_=["span","link"],f=_.length,x=-1,b=m&&m.attributes||{},w=s+"-"+i.type,L="load"!==q&&0===g.length?" ":"";if("load"===q?T.select(T.getStart()):q.indexOf("extend")>-1&&n.error('Unhandled mode "extend" during writing of new tooltip shortcode'),!d(m))for(m["qtip-content"]&&y("data-termcontent",m["qtip-content"]),m["qtip-keep-open"]&&y("data-qtip-keep-open","true"),d(m.qtiprounded)||y("data-qtiprounded",String(m.qtiprounded)),d(m.qtipshadow)||y("data-qtipshadow",String(m.qtipshadow)),m.qtipstyle&&y("data-qtipstyle",m.qtipstyle),m.qtiptrigger&&y("data-qtiptrigger",m.qtiptrigger),m.position&&(m.position.at&&m.position.at[1]&&m.position.at[2]&&y("data-position-at",m.position.at[1]+" "+m.position.at[2]),m.position.my&&m.position.my[1]&&m.position.my[2]&&(o=[m.position.my[1],m.position.my[2]],m.position.my.invert&&o.reverse(),y("data-position-my",o.join(" ")))),m.anim&&(m.anim["in"]&&y("data-animation_in",m.anim["in"]),m.anim.out&&y("data-animation_out",m.anim.out),m.anim.time&&y("data-animation_time",m.anim.time)),m.maxwidth&&y("data-tooltip-maxwidth",m.maxwidth);(x+=1)<f;)if(b.hasOwnProperty(x))for(a in b[_[x]])b[_[x]].hasOwnProperty(a)&&(l=u.indexOf(a)>-1?"":"data-",p="link"===_[x]?"link-":"",y(l+p+a,b[_[x]][a],!0));if(i.link&&y("href",encodeURI(i.link)),"glossary"===i.type){if(!i.glossary_id||!i.text)return;y("glossary-id",i.glossary_id),i.disable_auto_translation&&y("disable_auto_translation","true")}else if("tooltip"===i.type){if(!i.tooltip_content||!i.text)return;y("tooltip-content",i.tooltip_content,!0)}else if("mediatip"===i.type){if(!(i.mediatip_type&&i.mediatip_content&&i.text))return;y("mediatip-type",i.mediatip_type),y("mediatip-content",i.mediatip_content,!0),i.mediatip_caption&&y("mediatip-caption",i.mediatip_caption,!0)}var A="["+w+" "+c.join(" ")+"]"+i.text+"[/"+w+"]"+L;return n.log("Final content:",A),e(A)}}}()},error:function(){console.error("Error while getting TinyMCE form.",arguments)}})}},QTags.addButton("ithoughts_tt_gl-glossary","ITG Term",'[ithoughts_tooltip_glossary-glossary glossary-id=""]',"[/ithoughts_tooltip_glossary-glossary]","iThoughts Tooltip Glossary term","Add a glossary tooltip",null),QTags.addButton("ithoughts_tt_gl-tooltip","ITG Tooltip",'[ithoughts_tooltip_glossary-tooltip href="" tooltip-content=""]',"[/ithoughts_tooltip_glossary-tooltip]","iThoughts Tooltip Glossary tooltip","Add a tooltip",null),QTags.addButton("ithoughts_tt_gl-mediatip","ITG Mediatip",'[ithoughts_tooltip_glossary-mediatip href="" mediatip-type="webimage" mediatip-content="" mediatip-caption=""]',"[/ithoughts_tooltip_glossary-mediatip]","iThoughts Tooltip Glossary mediatip","Add a mediatip",null),QTags.addButton("ithoughts_tt_gl-tip","ITG Tip",function(){n.editorForms.tip(e(),QTags.insertContent)}),QTags.addButton("ithoughts_tt_gl-list","ITG List",function(){n.editorForms.list(e(),QTags.insertContent)})})}(Ithoughts.v4);