/*global Ithoughts, ithoughts_tt_gl, tinyMCE, tinymce */
!function(t){"use strict";t.$d.ready(function(){function i(){var t=o("#content").get(0),i={html:a.replaceShortcodes(t.value.substring(t.selectionStart,t.selectionEnd))};return i.DOM=o.parseHTML(i.html),i.start=o(i.DOM).first().get(0),i.end=o(i.DOM).last().get(0),i}var o=t.$,e=(t.$w,ithoughts_tt_gl),a=ithoughts_tt_gl_editor,n=e.stripQuotes,r="ithoughts_tt_gl",p="ithoughts-tooltip-glossary",s="ithoughts_tooltip_glossary",l=["ithoughts-tooltip-glossary-term","ithoughts-tooltip-glossary-tooltip","ithoughts-tooltip-glossary-mediatip"],d=["href"],u=t.isNA;t.initLoggers(a,"iThoughts Tooltip Glossary",a.verbosity),a.removeAccents=function(t){var i=/[¹²³áàâãäåaaaÀÁÂÃÄÅAAAÆccç©CCÇÐÐèéê?ëeeeeeÈÊË?EEEEE€gGiìíîïìiiiÌÍÎÏ?ÌIIIlLnnñNNÑòóôõöoooøÒÓÔÕÖOOOØŒr®Ršs?ßŠS?ùúûüuuuuÙÚÛÜUUUUýÿÝŸžzzŽZZ]/g,o={"¹":"1","²":"2","³":"3","á":"a","à":"a","â":"a","ã":"a","ä":"a","å":"a",a:"a","À":"a","Á":"a","Â":"a","Ã":"a","Ä":"a","Å":"a",A:"a","Æ":"a",c:"c","ç":"c","©":"c",C:"c","Ç":"c","Ð":"d","è":"e","é":"e","ê":"e","?":"s","ë":"e",e:"e","È":"e","Ê":"e","Ë":"e",E:"e","€":"e",g:"g",G:"g",i:"i","ì":"i","í":"i","î":"i","ï":"i","Ì":"i","Í":"i","Î":"i","Ï":"i",I:"i",l:"l",L:"l",n:"n","ñ":"n",N:"n","Ñ":"n","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o",o:"o","ø":"o","Ò":"o","Ó":"o","Ô":"o","Õ":"o","Ö":"o",O:"o","Ø":"o","Œ":"o",r:"r","®":"r",R:"r","š":"s",s:"s","ß":"s","Š":"s",S:"s","ù":"u","ú":"u","û":"u","ü":"u",u:"u","Ù":"u","Ú":"u","Û":"u","Ü":"u",U:"u","ý":"y","ÿ":"y","Ý":"y","Ÿ":"y","ž":"z",z:"z","Ž":"z",Z:"z"};return t.replace(i,function(t){return o[t]})},a.replaceShortcodes=function(t){for(var i=a.replaceShortcodesEl.length,o=-1;(o+=1)<i;)t=a.replaceShortcodesEl[o](t);return t},a.restoreShortcodes=function(t){for(var i=a.restoreShortcodesEl.length,o=-1;(o+=1)<i;)t=a.restoreShortcodesEl[o](t);return t},a.replaceShortcodesEl=[function(t){return t.replace(/\[(?:ithoughts_tooltip_glossary-)?(glossary|tooltip|mediatip)(?!_)(.*?)\](.*?)\[\/(?:ithoughts_tooltip_glossary-)?(glossary|tooltip|mediatip)\]/g,function(t,i,o,e){for(var a,n={},r=/([\w\d\-]+?)="(.+?)"/g,s=null,l='<a data-type="'+p+"-"+{glossary:"term",tooltip:"tooltip",mediatip:"mediatip"}[i]+'"';Boolean(s=r.exec(o))===!0;)n[s[1]]=s[2];for(a in n)n.hasOwnProperty(a)&&(l+=d.indexOf(a)>-1||0===a.indexOf("data-")?" "+a+'="'+n[a]+'"':" data-"+a+'="'+n[a]+'"');return l+">"+e+"</a>"})},function(t){return t.replace(/\[glossary_(term_list|atoz)(.*?)\/\]/g,function(t,i,o){for(var e,a={},n=/([\w\d\-]+?)="(.+?)"/g,r=null,s='<span data-type="'+p+"-"+i+'"';Boolean(r=n.exec(o))===!0;)a[r[1]]=r[2];for(e in a)a.hasOwnProperty(e)&&(s+=d.indexOf(e)>-1||0===e.indexOf("data-")?" "+e+'="'+a[e]+'"':" data-"+e+'="'+a[e]+'"');return s+">Glossary "+("term_list"===i?"List":"A-to-Z")+"</span>"})}],a.restoreShortcodesEl=[function(t){return t.replace(/<a\s+(?=[^>]*data-type="ithoughts-tooltip-glossary-(term|tooltip|mediatip)")(.*?)>(.*?)<\/a>/g,function(t,i,o,e){for(var a,n={},r=/(data-)?([\w\d\-]+?)="(.+?)"/g,p=null,l={term:"glossary",tooltip:"tooltip",mediatip:"mediatip"}[i],u="["+s+"-"+l;Boolean(p=r.exec(o))===!0;)"data-"===p[1]&&"type"===p[2]||(d.indexOf(p[2])>-1&&"undefined"!=typeof p[1]?n[p[1]+p[2]]=p[3]:n[p[2]]=p[3]);for(a in n)n.hasOwnProperty(a)&&(u+=" "+a+'="'+n[a]+'"');return u+"]"+e+"[/"+s+"-"+l+"]"})},function(t){return t.replace(/<span\s+(?=[^>]*data-type="ithoughts-tooltip-glossary-(term_list|atoz)")(.*?)>.*?<\/span>/g,function(t,i,o){for(var e,a={},n=/(data-)?([\w\d\-]+?)="(.+?)"/g,r=null,p="[glossary_"+i;Boolean(r=n.exec(o))===!0;)"data-"===r[1]&&"type"===r[2]||(d.indexOf(e)>-1&&"undefined"!=typeof r[1]?a[r[1]+r[2]]=r[3]:a[r[2]]=r[3]);for(e in a)a.hasOwnProperty(e)&&(p+=" "+e+'="'+a[e]+'"');return p+"/]"})}],a.editorForms={list:function(i,e,p){a.log("Selection infos to load TIP: ",i);var l,d,c="insert_content",m=i.start,g={list:{alpha:"",cols:"",desc:"",group:""},atoz:{group:"",alpha:"",lazy:!0},type:0};u(i.start)||i.start!==i.end||(a.log("Start & End node are the same, operating on a node of type "+m.nodeName),m&&"#text"!=m.nodeName&&("ithoughts-tooltip-glossary-atoz"===m.getAttribute("data-type")?(c="load",g.type=1,g.atoz={alpha:m.getAttribute("data-alpha"),group:m.getAttribute("data-group"),lazy:"true"===m.getAttribute("data-lazy")}):"ithoughts-tooltip-glossary-term_list"===m.getAttribute("data-type")&&(c="load",g.type=0,g.list={alpha:m.getAttribute("data-alpha"),cols:m.getAttribute("data-cols"),desc:m.getAttribute("data-desc"),group:m.getAttribute("data-group")}))),d=t.makeLoader(),o.ajax({method:"POST",async:!0,url:a.admin_ajax,data:{action:r+"_get_tinymce_list_form",data:g},success:function(t){d.remove();var i=o(o.parseHTML(t,!0));i.find("#"+r+"-list-form");o(document.body).append(i.css({opacity:0}).animate({opacity:1},500)),a.finishListTinymce=function(){var t=i;return function(i){if(a.info("New list data:",i),t.animate({opacity:0},500,function(){t.remove()}),"undefined"!=typeof i){var o,r,p,l,d=t.find("#attributes-list option").map(function(){return this.value}).toArray(),m=[],y=i.opts||g.opts,f=function(t,i,o){return i=String(i).trim(),t.match(/^[\w_\-]*$/)?n(t.trim(),!0)+'="'+(!u(o)&&o?i.replace(/"/g,"&aquot;").replace(/\n/g,"<br/>"):n(i,!0))+'"':null},h=function(t,i,o){m.push(f(t,i,o)),m=m.filter(function(t){return!u(t)})},_=["span","link"],x=_.length,q=-1,v=y&&y.attributes||{},w=s+"-"+i.type,b="load"!==c&&0===content.length?" ":"";if(!u(y))for(y["qtip-content"]&&h("data-termcontent",y["qtip-content"]),y["qtip-keep-open"]&&h("data-qtip-keep-open","true"),u(y.qtiprounded)||h("data-qtiprounded",String(y.qtiprounded)),u(y.qtipshadow)||h("data-qtipshadow",String(y.qtipshadow)),y.qtipstyle&&h("data-qtipstyle",y.qtipstyle),y.qtiptrigger&&h("data-qtiptrigger",y.qtiptrigger),y.position&&(y.position.at&&y.position.at[1]&&y.position.at[2]&&h("data-position-at",y.position.at[1]+" "+y.position.at[2]),y.position.my&&y.position.my[1]&&y.position.my[2]&&(o=[y.position.my[1],y.position.my[2]],y.position.my.invert&&o.reverse(),h("data-position-my",o.join(" ")))),y.anim&&(y.anim["in"]&&h("data-animation_in",y.anim["in"]),y.anim.out&&h("data-animation_out",y.anim.out),y.anim.time&&h("data-animation_time",y.anim.time)),y.maxwidth&&h("data-tooltip-maxwidth",y.maxwidth);(q+=1)<x;)if(v.hasOwnProperty(q))for(r in v[_[q]])v[_[q]].hasOwnProperty(r)&&(p=d.indexOf(r)>-1?"":"data-",l="link"===_[q]?"link-":"",h(p+l+r,v[_[q]][r],!0));if(i.link&&h("href",encodeURI(i.link)),"glossary"===i.type){if(!i.glossary_id||!i.text)return;h("glossary-id",i.glossary_id),i.disable_auto_translation&&h("disable_auto_translation","true")}else if("tooltip"===i.type){if(!i.tooltip_content||!i.text)return;h("tooltip-content",i.tooltip_content,!0)}else if("mediatip"===i.type){if(!(i.mediatip_type&&i.mediatip_content&&i.text))return;h("mediatip-type",i.mediatip_type),h("mediatip-content",i.mediatip_content,!0),i.mediatip_caption&&h("mediatip-caption",i.mediatip_caption,!0)}var O="["+w+" "+m.join(" ")+"]"+i.text+"[/"+w+"]"+b;return a.log("Final content:",O),e(O,c)}}}()},error:function(){d.remove(),a.error("Error while getting TinyMCE form for Tip: ",arguments)}}),l=g.type},tip:function(i,e,p){a.info("Selection infos to load TIP: ",i);var d,c,m,g,y,f,h,_,x,q,v,w={},b=i.start,O=(o(b),""),k=-1;if(!u(i.start)&&i.start===i.end)if(a.log("Start & End node are the same, operating on a node of type "+b.nodeName),d=b&&b.text||i.html,a.log("Loading content: ",d),b&&"#text"!=b.nodeName&&l.indexOf(b.getAttribute("data-type"))>-1){for(O="load",g={},c=b.attributes,m=c.length;(k+=1)<m;)y=c[k],g[y.nodeName]=y.nodeValue;f=function(t,i){!u(i)&&i||(t="data-"+t);var o=g[t];return delete g[t],o},h=(f("position-at")||" ").split(" "),_=(f("position-my")||" ").split(" "),x=1===Math.max(_.indexOf("top"),_.indexOf("bottom"))||0===Math.max(_.indexOf("right"),_.indexOf("left")),h={1:h[0],2:h[1]},_={1:_[x?1:0],2:_[x?0:1],invert:x?"enabled":void 0},q=function(t){return"true"===t?!0:"false"===t?!1:null};var S=f("tooltip-content");p&&S&&(S=S.replace(/&lt;/g,"<").replace(/&gt;/g,">")),w={text:d,link:f("href",!0),tooltip_content:n(S||d,!1),glossary_id:f("glossary-id"),term_search:a.removeAccents(d.toLowerCase()),mediatip_type:f("mediatip-type"),mediatip_content:n(f("mediatip-content"),!1),mediatip_link:f("mediatip-link"),mediatip_caption:f("mediatip-caption"),type:["glossary","tooltip","mediatip"][l.indexOf(f("type"))],glossary_disable_auto_translation:"true"===(f("disable_auto_translation")||!1),opts:{termcontent:f("termcontent"),"qtip-keep-open":"true"===f("qtip-keep-open"),qtiprounded:q(f("qtiprounded")),qtipshadow:q(f("qtipshadow")),qtipstyle:f("qtipstyle"),qtiptrigger:f("qtiptrigger"),position:{at:h,my:_},attributes:{span:{},link:{}},anim:{"in":f("animation_in"),out:f("animation_out"),time:f("animation_time")},maxwidth:f("tooltip-maxwidth")}};for(k in g)g.hasOwnProperty(k)&&(k.match(/^data-link-/)?w.opts.attributes.link[k.replace(/^data-link-(data-)?/,"")]=g[k]:w.opts.attributes.span[k.replace(/^data-/,"")]=g[k])}else d&&d.length>0?(O="replace_content",w={text:d,link:"",tooltip_content:d,glossary_id:null,term_search:a.removeAccents(d.toLowerCase()),mediatip_type:"",mediatip_content:"",mediatip_caption:"",type:"tooltip",glossary_disable_auto_translation:!1}):(O="add_content",w={text:"",link:"",tooltip_content:"",glossary_id:null,term_search:"",mediatip_type:"",mediatip_content:"",mediatip_caption:"",type:"tooltip",glossary_disable_auto_translation:!1});v=t.makeLoader(),o.ajax({method:"POST",async:!0,url:a.admin_ajax,data:{action:r+"_get_tinymce_tooltip_form",data:w},success:function(t){v.remove();var i=o(o.parseHTML(t,!0));i.find("#"+r+"-tooltip-form"),i.find("#"+r+"-tooltip-form-options");o(document.body).append(i.css({opacity:1}).animate({opacity:1},500)),a.finishTipTinymce=function(){var t=i;return function(i){if(a.info("New tooltip data:",i),t.animate({opacity:0},500,function(){t.remove()}),"undefined"!=typeof i){var o,r,l,c,m=t.find("#attributes-list option").map(function(){return this.value}).toArray(),g=[],y=i.opts||w.opts,f=function(t,i,o){return i=String(i).trim(),t.match(/^[\w_\-]*$/)?n(t.trim(),!0)+'="'+(!u(o)&&o?i.replace(/"/g,"&aquot;").replace(/\n/g,"<br/>"):n(i,!0))+'"':null},h=function(t,i,o){g.push(f(t,i,o)),g=g.filter(function(t){return!u(t)})},_=["span","link"],x=_.length,q=-1,v=y&&y.attributes||{},b=s+"-"+i.type,k="load"!==O&&0===d.length?" ":"";if(!u(y))for(y["qtip-content"]&&h("data-termcontent",y["qtip-content"]),y["qtip-keep-open"]&&h("data-qtip-keep-open","true"),u(y.qtiprounded)||h("data-qtiprounded",String(y.qtiprounded)),u(y.qtipshadow)||h("data-qtipshadow",String(y.qtipshadow)),y.qtipstyle&&h("data-qtipstyle",y.qtipstyle),y.qtiptrigger&&h("data-qtiptrigger",y.qtiptrigger),y.position&&(y.position.at&&y.position.at[1]&&y.position.at[2]&&h("data-position-at",y.position.at[1]+" "+y.position.at[2]),y.position.my&&y.position.my[1]&&y.position.my[2]&&(o=[y.position.my[1],y.position.my[2]],y.position.my.invert&&o.reverse(),h("data-position-my",o.join(" ")))),y.anim&&(y.anim["in"]&&h("data-animation_in",y.anim["in"]),y.anim.out&&h("data-animation_out",y.anim.out),y.anim.time&&h("data-animation_time",y.anim.time)),y.maxwidth&&h("data-tooltip-maxwidth",y.maxwidth);q++<x;){var S=_[q];if(v.hasOwnProperty(S))for(r in v[S])v[S].hasOwnProperty(r)&&(l=m.indexOf(r)>-1&&!r.startsWith("data-")?"":"data-",c="link"===S?"link-":"",h(l+c+r,v[S][r],!0))}if(i.link&&h("href",encodeURI(i.link)),"glossary"===i.type){if(!i.glossary_id||!i.text)return;h("glossary-id",i.glossary_id),i.disable_auto_translation&&h("disable_auto_translation","true")}else if("tooltip"===i.type){if(!i.tooltip_content||!i.text)return;h("tooltip-content",p?i.tooltip_content.replace(/</g,"&lt;").replace(/>/g,"&gt;"):i.tooltip_content,!0)}else if("mediatip"===i.type){if(!(i.mediatip_type&&i.mediatip_content&&i.text))return;h("mediatip-type",i.mediatip_type),h("mediatip-content",i.mediatip_content,!0),i.mediatip_caption&&h("mediatip-caption",i.mediatip_caption,!0)}var T="["+b+" "+g.join(" ")+"]"+i.text+"[/"+b+"]"+k;return a.log("Final content:",T),e(T,O)}}}()},error:function(){v.remove(),a.error("Error while getting TinyMCE form for Tip: ",arguments)}})}},QTags.addButton("ithoughts_tt_gl-tip","ITG Tip",function(){a.editorForms.tip(i(),QTags.insertContent,!0)}),QTags.addButton("ithoughts_tt_gl-list","ITG List",function(){a.editorForms.list(i(),QTags.insertContent,!0)})})}(Ithoughts.v4);