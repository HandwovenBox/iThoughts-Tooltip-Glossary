/*global Ithoughts, ithoughts_tt_gl, tinyMCE, tinymce */
!function(t){"use strict";t.$d.ready(function(){function i(){var t=o("#content").get(0),i={html:n.replaceShortcodes(t.value.substring(t.selectionStart,t.selectionEnd))};return i.DOM=o.parseHTML(i.html),i.start=o(i.DOM).first().get(0),i.end=o(i.DOM).last().get(0),i}var o=t.$,e=t.$w,a=ithoughts_tt_gl,n=ithoughts_tt_gl_editor,r=a.stripQuotes,p="ithoughts_tt_gl",s="ithoughts-tooltip-glossary",l="ithoughts_tooltip_glossary",d=["ithoughts-tooltip-glossary-term","ithoughts-tooltip-glossary-tooltip","ithoughts-tooltip-glossary-mediatip"],u=["href"],c=t.isNA;t.initLoggers(n,"iThoughts Tooltip Glossary",n.verbosity),n.removeAccents=function(t){var i=/[¹²³áàâãäåaaaÀÁÂÃÄÅAAAÆccç©CCÇÐÐèéê?ëeeeeeÈÊË?EEEEE€gGiìíîïìiiiÌÍÎÏ?ÌIIIlLnnñNNÑòóôõöoooøÒÓÔÕÖOOOØŒr®Ršs?ßŠS?ùúûüuuuuÙÚÛÜUUUUýÿÝŸžzzŽZZ]/g,o={"¹":"1","²":"2","³":"3","á":"a","à":"a","â":"a","ã":"a","ä":"a","å":"a",a:"a","À":"a","Á":"a","Â":"a","Ã":"a","Ä":"a","Å":"a",A:"a","Æ":"a",c:"c","ç":"c","©":"c",C:"c","Ç":"c","Ð":"d","è":"e","é":"e","ê":"e","?":"s","ë":"e",e:"e","È":"e","Ê":"e","Ë":"e",E:"e","€":"e",g:"g",G:"g",i:"i","ì":"i","í":"i","î":"i","ï":"i","Ì":"i","Í":"i","Î":"i","Ï":"i",I:"i",l:"l",L:"l",n:"n","ñ":"n",N:"n","Ñ":"n","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o",o:"o","ø":"o","Ò":"o","Ó":"o","Ô":"o","Õ":"o","Ö":"o",O:"o","Ø":"o","Œ":"o",r:"r","®":"r",R:"r","š":"s",s:"s","ß":"s","Š":"s",S:"s","ù":"u","ú":"u","û":"u","ü":"u",u:"u","Ù":"u","Ú":"u","Û":"u","Ü":"u",U:"u","ý":"y","ÿ":"y","Ý":"y","Ÿ":"y","ž":"z",z:"z","Ž":"z",Z:"z"};return t.replace(i,function(t){return o[t]})},n.replaceShortcodes=function(t){for(var i=n.replaceShortcodesEl.length,o=-1;(o+=1)<i;)t=n.replaceShortcodesEl[o](t);return t},n.restoreShortcodes=function(t){for(var i=n.restoreShortcodesEl.length,o=-1;(o+=1)<i;)t=n.restoreShortcodesEl[o](t);return t},n.replaceShortcodesEl=[function(t){return t.replace(/\[(?:ithoughts_tooltip_glossary-)?(glossary|tooltip|mediatip)(?!_)(.*?)\](.*?)\[\/(?:ithoughts_tooltip_glossary-)?(glossary|tooltip|mediatip)\]/g,function(t,i,o,e){for(var a,n={},r=/([\w\d\-]+?)="(.+?)"/g,p=null,l='<a data-type="'+s+"-"+{glossary:"term",tooltip:"tooltip",mediatip:"mediatip"}[i]+'"';Boolean(p=r.exec(o))===!0;)n[p[1]]=p[2];for(a in n)n.hasOwnProperty(a)&&(l+=u.indexOf(a)>-1||0===a.indexOf("data-")?" "+a+'="'+n[a]+'"':" data-"+a+'="'+n[a]+'"');return l+">"+e+"</a>"})},function(t){return t.replace(/\[glossary_(term_list|atoz)(.*?)\/\]/g,function(t,i,o){for(var e,a={},n=/([\w\d\-]+?)="(.+?)"/g,r=null,p='<span data-type="'+s+"-"+i+'"';Boolean(r=n.exec(o))===!0;)a[r[1]]=r[2];for(e in a)a.hasOwnProperty(e)&&(p+=u.indexOf(e)>-1||0===e.indexOf("data-")?" "+e+'="'+a[e]+'"':" data-"+e+'="'+a[e]+'"');return p+">Glossary "+("term_list"===i?"List":"A-to-Z")+"</span>"})}],n.restoreShortcodesEl=[function(t){return t.replace(/<a\s+(?=[^>]*data-type="ithoughts-tooltip-glossary-(term|tooltip|mediatip)")(.*?)>(.*?)<\/a>/g,function(t,i,o,e){for(var a,n={},r=/(data-)?([\w\d\-]+?)="(.+?)"/g,p=null,s={term:"glossary",tooltip:"tooltip",mediatip:"mediatip"}[i],d="["+l+"-"+s;Boolean(p=r.exec(o))===!0;)"data-"===p[1]&&"type"===p[2]||(u.indexOf(p[2])>-1&&"undefined"!=typeof p[1]?n[p[1]+p[2]]=p[3]:n[p[2]]=p[3]);for(a in n)n.hasOwnProperty(a)&&(d+=" "+a+'="'+n[a]+'"');return d+"]"+e+"[/"+l+"-"+s+"]"})},function(t){return t.replace(/<span\s+(?=[^>]*data-type="ithoughts-tooltip-glossary-(term_list|atoz)")(.*?)>.*?<\/span>/g,function(t,i,o){for(var e,a={},n=/(data-)?([\w\d\-]+?)="(.+?)"/g,r=null,p="[glossary_"+i;Boolean(r=n.exec(o))===!0;)"data-"===r[1]&&"type"===r[2]||(u.indexOf(e)>-1&&"undefined"!=typeof r[1]?a[r[1]+r[2]]=r[3]:a[r[2]]=r[3]);for(e in a)a.hasOwnProperty(e)&&(p+=" "+e+'="'+a[e]+'"');return p+"/]"})}],n.editorForms={list:function(i,a,s){n.log("Selection infos to load TIP: ",i);var d,u,m="insert_content",g=i.start,y={list:{alpha:"",cols:"",desc:"",group:""},atoz:{group:"",alpha:"",lazy:!0},type:0};i.start===i.end&&(n.log("Start & End node are the same, operating on a node of type "+g.nodeName),g&&"#text"!=g.nodeName&&("ithoughts-tooltip-glossary-atoz"===g.getAttribute("data-type")?(m="load",y.type=1,y.atoz={alpha:g.getAttribute("data-alpha"),group:g.getAttribute("data-group"),lazy:"true"===g.getAttribute("data-lazy")}):"ithoughts-tooltip-glossary-term_list"===g.getAttribute("data-type")&&(m="load",y.type=0,y.list={alpha:g.getAttribute("data-alpha"),cols:g.getAttribute("data-cols"),desc:g.getAttribute("data-desc"),group:g.getAttribute("data-group")}))),u=t.makeLoader(),o.ajax({method:"POST",async:!0,url:n.admin_ajax,data:{action:p+"_get_tinymce_list_form",data:y},success:function(t){u.remove();var i=o(o.parseHTML(t,!0)),s=400,d=455,g=i.find("#"+p+"-tooltip-form"),f=i.find("#"+p+"-tooltip-form-options");e.on("resize",function(){var t={width:d+"px",height:s+"px",left:(e.width()-d)/2+"px",top:(e.height()-s)/2+"px"};g.css(t),f.css(t)}).resize(),o(document.body).append(i.css({opacity:0}).animate({opacity:1},500)),n.finishTinymce=function(){var t=i;return function(i){if(n.info("New tooltip data:",i),t.animate({opacity:0},500,function(){t.remove()}),"undefined"!=typeof i){var o,e,p,s,d=t.find("#attributes-list option").map(function(){return this.value}).toArray(),u=[],g=i.opts||y.opts,f=function(t,i,o){return i=String(i).trim(),t.match(/^[\w_\-]*$/)?r(t.trim(),!0)+'="'+(!c(o)&&o?i.replace(/"/g,"&aquot;").replace(/\n/g,"<br/>"):r(i,!0))+'"':null},h=function(t,i,o){u.push(f(t,i,o)),u=u.filter(function(t){return!c(t)})},_=["span","link"],x=_.length,q=-1,v=g&&g.attributes||{},w=l+"-"+i.type,b="load"!==m&&0===content.length?" ":"";if(!c(g))for(g["qtip-content"]&&h("data-termcontent",g["qtip-content"]),g["qtip-keep-open"]&&h("data-qtip-keep-open","true"),c(g.qtiprounded)||h("data-qtiprounded",String(g.qtiprounded)),c(g.qtipshadow)||h("data-qtipshadow",String(g.qtipshadow)),g.qtipstyle&&h("data-qtipstyle",g.qtipstyle),g.qtiptrigger&&h("data-qtiptrigger",g.qtiptrigger),g.position&&(g.position.at&&g.position.at[1]&&g.position.at[2]&&h("data-position-at",g.position.at[1]+" "+g.position.at[2]),g.position.my&&g.position.my[1]&&g.position.my[2]&&(o=[g.position.my[1],g.position.my[2]],g.position.my.invert&&o.reverse(),h("data-position-my",o.join(" ")))),g.anim&&(g.anim["in"]&&h("data-animation_in",g.anim["in"]),g.anim.out&&h("data-animation_out",g.anim.out),g.anim.time&&h("data-animation_time",g.anim.time)),g.maxwidth&&h("data-tooltip-maxwidth",g.maxwidth);(q+=1)<x;)if(v.hasOwnProperty(q))for(e in v[_[q]])v[_[q]].hasOwnProperty(e)&&(p=d.indexOf(e)>-1?"":"data-",s="link"===_[q]?"link-":"",h(p+s+e,v[_[q]][e],!0));if(i.link&&h("href",encodeURI(i.link)),"glossary"===i.type){if(!i.glossary_id||!i.text)return;h("glossary-id",i.glossary_id),i.disable_auto_translation&&h("disable_auto_translation","true")}else if("tooltip"===i.type){if(!i.tooltip_content||!i.text)return;h("tooltip-content",i.tooltip_content,!0)}else if("mediatip"===i.type){if(!(i.mediatip_type&&i.mediatip_content&&i.text))return;h("mediatip-type",i.mediatip_type),h("mediatip-content",i.mediatip_content,!0),i.mediatip_caption&&h("mediatip-caption",i.mediatip_caption,!0)}var O="["+w+" "+u.join(" ")+"]"+i.text+"[/"+w+"]"+b;return n.log("Final content:",O),a(O,m)}}}()},error:function(){u.remove(),n.error("Error while getting TinyMCE form for Tip: ",arguments)}}),d=y.type},tip:function(i,a,s){n.info("Selection infos to load TIP: ",i);var u,m,g,y,f,h,_,x,q,v,w,b={},O=i.start,k=(o(O),""),S=-1;if(i.start===i.end)if(n.log("Start & End node are the same, operating on a node of type "+O.nodeName),u=O&&O.text||i.html,n.log("Loading content: ",u),O&&"#text"!=O.nodeName&&d.indexOf(O.getAttribute("data-type"))>-1){for(k="load",y={},m=O.attributes,g=m.length;(S+=1)<g;)f=m[S],y[f.nodeName]=f.nodeValue;h=function(t,i){!c(i)&&i||(t="data-"+t);var o=y[t];return delete y[t],o},_=(h("position-at")||" ").split(" "),x=(h("position-my")||" ").split(" "),q=1===Math.max(x.indexOf("top"),x.indexOf("bottom"))||0===Math.max(x.indexOf("right"),x.indexOf("left")),_={1:_[0],2:_[1]},x={1:x[q?1:0],2:x[q?0:1],invert:q?"enabled":void 0},v=function(t){return"true"===t?!0:"false"===t?!1:null},b={text:u,link:h("href",!0),tooltip_content:r(h("tooltip-content")||u,!1),glossary_id:h("glossary-id"),term_search:n.removeAccents(u.toLowerCase()),mediatip_type:h("mediatip-type"),mediatip_content:r(h("mediatip-content"),!1),mediatip_link:h("mediatip-link"),mediatip_caption:h("mediatip-caption"),type:["glossary","tooltip","mediatip"][d.indexOf(h("type"))],glossary_disable_auto_translation:"true"===(h("disable_auto_translation")||!1),opts:{termcontent:h("termcontent"),"qtip-keep-open":"true"===h("qtip-keep-open"),qtiprounded:v(h("qtiprounded")),qtipshadow:v(h("qtipshadow")),qtipstyle:h("qtipstyle"),qtiptrigger:h("qtiptrigger"),position:{at:_,my:x},attributes:{span:{},link:{}},anim:{"in":h("animation_in"),out:h("animation_out"),time:h("animation_time")},maxwidth:h("tooltip-maxwidth")}};for(S in y)y.hasOwnProperty(S)&&(S.match(/^data-link-/)?b.opts.attributes.link[S.replace(/^data-link-/,"")]=y[S]:b.opts.attributes.span[S.replace(/^data-/,"")]=y[S])}else u&&u.length>0?(k="replace_content",b={text:u,link:"",tooltip_content:u,glossary_id:null,term_search:n.removeAccents(u.toLowerCase()),mediatip_type:"",mediatip_content:"",mediatip_caption:"",type:"tooltip",glossary_disable_auto_translation:!1}):(k="add_content",b={text:"",link:"",tooltip_content:"",glossary_id:null,term_search:"",mediatip_type:"",mediatip_content:"",mediatip_caption:"",type:"tooltip",glossary_disable_auto_translation:!1});w=t.makeLoader(),o.ajax({method:"POST",async:!0,url:n.admin_ajax,data:{action:p+"_get_tinymce_tooltip_form",data:b},success:function(t){w.remove();var i=o(o.parseHTML(t,!0)),s=400,d=455,m=i.find("#"+p+"-tooltip-form"),g=i.find("#"+p+"-tooltip-form-options");e.on("resize",function(){var t={width:d+"px",height:s+"px",left:(e.width()-d)/2+"px",top:(e.height()-s)/2+"px"};m.css(t),g.css(t)}).resize(),o(document.body).append(i.css({opacity:0}).animate({opacity:1},500)),n.finishTinymce=function(){var t=i;return function(i){if(n.info("New tooltip data:",i),t.animate({opacity:0},500,function(){t.remove()}),"undefined"!=typeof i){var o,e,p,s,d=t.find("#attributes-list option").map(function(){return this.value}).toArray(),m=[],g=i.opts||b.opts,y=function(t,i,o){return i=String(i).trim(),t.match(/^[\w_\-]*$/)?r(t.trim(),!0)+'="'+(!c(o)&&o?i.replace(/"/g,"&aquot;").replace(/\n/g,"<br/>"):r(i,!0))+'"':null},f=function(t,i,o){m.push(y(t,i,o)),m=m.filter(function(t){return!c(t)})},h=["span","link"],_=h.length,x=-1,q=g&&g.attributes||{},v=l+"-"+i.type,w="load"!==k&&0===u.length?" ":"";if(!c(g))for(g["qtip-content"]&&f("data-termcontent",g["qtip-content"]),g["qtip-keep-open"]&&f("data-qtip-keep-open","true"),c(g.qtiprounded)||f("data-qtiprounded",String(g.qtiprounded)),c(g.qtipshadow)||f("data-qtipshadow",String(g.qtipshadow)),g.qtipstyle&&f("data-qtipstyle",g.qtipstyle),g.qtiptrigger&&f("data-qtiptrigger",g.qtiptrigger),g.position&&(g.position.at&&g.position.at[1]&&g.position.at[2]&&f("data-position-at",g.position.at[1]+" "+g.position.at[2]),g.position.my&&g.position.my[1]&&g.position.my[2]&&(o=[g.position.my[1],g.position.my[2]],g.position.my.invert&&o.reverse(),f("data-position-my",o.join(" ")))),g.anim&&(g.anim["in"]&&f("data-animation_in",g.anim["in"]),g.anim.out&&f("data-animation_out",g.anim.out),g.anim.time&&f("data-animation_time",g.anim.time)),g.maxwidth&&f("data-tooltip-maxwidth",g.maxwidth);(x+=1)<_;)if(q.hasOwnProperty(x))for(e in q[h[x]])q[h[x]].hasOwnProperty(e)&&(p=d.indexOf(e)>-1?"":"data-",s="link"===h[x]?"link-":"",f(p+s+e,q[h[x]][e],!0));if(i.link&&f("href",encodeURI(i.link)),"glossary"===i.type){if(!i.glossary_id||!i.text)return;f("glossary-id",i.glossary_id),i.disable_auto_translation&&f("disable_auto_translation","true")}else if("tooltip"===i.type){if(!i.tooltip_content||!i.text)return;f("tooltip-content",i.tooltip_content,!0)}else if("mediatip"===i.type){if(!(i.mediatip_type&&i.mediatip_content&&i.text))return;f("mediatip-type",i.mediatip_type),f("mediatip-content",i.mediatip_content,!0),i.mediatip_caption&&f("mediatip-caption",i.mediatip_caption,!0)}var O="["+v+" "+m.join(" ")+"]"+i.text+"[/"+v+"]"+w;return n.log("Final content:",O),a(O,k)}}}()},error:function(){w.remove(),n.error("Error while getting TinyMCE form for Tip: ",arguments)}})}},QTags.addButton("ithoughts_tt_gl-tip","ITG Tip",function(){n.editorForms.tip(i(),QTags.insertContent)}),QTags.addButton("ithoughts_tt_gl-list","ITG List",function(){n.editorForms.list(i(),QTags.insertContent)})})}(Ithoughts.v4);