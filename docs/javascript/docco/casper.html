<!DOCTYPE html>

<html>
<head>
  <title>casper.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="ithoughts_tt_gl-admin.html">
                  ithoughts_tt_gl-admin.js
                </a>
              
                
                <a class="source" href="ithoughts_tt_gl-atoz.html">
                  ithoughts_tt_gl-atoz.js
                </a>
              
                
                <a class="source" href="ithoughts_tt_gl-editor.html">
                  ithoughts_tt_gl-editor.js
                </a>
              
                
                <a class="source" href="ithoughts_tt_gl-floater.html">
                  ithoughts_tt_gl-floater.js
                </a>
              
                
                <a class="source" href="ithoughts_tt_gl-qtip2.html">
                  ithoughts_tt_gl-qtip2.js
                </a>
              
                
                <a class="source" href="ithoughts_tt_gl-styleeditor.html">
                  ithoughts_tt_gl-styleeditor.js
                </a>
              
                
                <a class="source" href="ithoughts_tt_gl-tinymce-forms.html">
                  ithoughts_tt_gl-tinymce-forms.js
                </a>
              
                
                <a class="source" href="ithoughts_tt_gl-tinymce.html">
                  ithoughts_tt_gl-tinymce.js
                </a>
              
                
                <a class="source" href="ithoughts_tt_gl-updater.html">
                  ithoughts_tt_gl-updater.js
                </a>
              
                
                <a class="source" href="bootstrap.html">
                  bootstrap.js
                </a>
              
                
                <a class="source" href="casperjs.html">
                  casperjs.js
                </a>
              
                
                <a class="source" href="style-switcher.html">
                  style-switcher.js
                </a>
              
                
                <a class="source" href="casper.html">
                  casper.js
                </a>
              
                
                <a class="source" href="cli.html">
                  cli.js
                </a>
              
                
                <a class="source" href="clientutils.html">
                  clientutils.js
                </a>
              
                
                <a class="source" href="colorizer.html">
                  colorizer.js
                </a>
              
                
                <a class="source" href="events.html">
                  events.js
                </a>
              
                
                <a class="source" href="http.html">
                  http.js
                </a>
              
                
                <a class="source" href="mouse.html">
                  mouse.js
                </a>
              
                
                <a class="source" href="pagestack.html">
                  pagestack.js
                </a>
              
                
                <a class="source" href="querystring.html">
                  querystring.js
                </a>
              
                
                <a class="source" href="tester.html">
                  tester.js
                </a>
              
                
                <a class="source" href="utils.html">
                  utils.js
                </a>
              
                
                <a class="source" href="xunit.html">
                  xunit.js
                </a>
              
                
                <a class="source" href="bbcshots.html">
                  bbcshots.js
                </a>
              
                
                <a class="source" href="cliplay.html">
                  cliplay.js
                </a>
              
                
                <a class="source" href="customevents.html">
                  customevents.js
                </a>
              
                
                <a class="source" href="customlogging.html">
                  customlogging.js
                </a>
              
                
                <a class="source" href="download.html">
                  download.js
                </a>
              
                
                <a class="source" href="dynamic.html">
                  dynamic.js
                </a>
              
                
                <a class="source" href="each.html">
                  each.js
                </a>
              
                
                <a class="source" href="events.html">
                  events.js
                </a>
              
                
                <a class="source" href="extends.html">
                  extends.js
                </a>
              
                
                <a class="source" href="googlelinks.html">
                  googlelinks.js
                </a>
              
                
                <a class="source" href="googlematch.html">
                  googlematch.js
                </a>
              
                
                <a class="source" href="googlepagination.html">
                  googlepagination.js
                </a>
              
                
                <a class="source" href="googletesting.html">
                  googletesting.js
                </a>
              
                
                <a class="source" href="logcolor.html">
                  logcolor.js
                </a>
              
                
                <a class="source" href="metaextract.html">
                  metaextract.js
                </a>
              
                
                <a class="source" href="multirun.html">
                  multirun.js
                </a>
              
                
                <a class="source" href="screenshot.html">
                  screenshot.js
                </a>
              
                
                <a class="source" href="statushandlers.html">
                  statushandlers.js
                </a>
              
                
                <a class="source" href="steptimeout.html">
                  steptimeout.js
                </a>
              
                
                <a class="source" href="timeout.html">
                  timeout.js
                </a>
              
                
                <a class="source" href="translate.html">
                  translate.js
                </a>
              
                
                <a class="source" href="syntax.html">
                  syntax.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="hook.html">
                  hook.js
                </a>
              
                
                <a class="source" href="test1.html">
                  test1.js
                </a>
              
                
                <a class="source" href="test2.html">
                  test2.js
                </a>
              
                
                <a class="source" href="test3.html">
                  test3.js
                </a>
              
                
                <a class="source" href="mod.html">
                  mod.js
                </a>
              
                
                <a class="source" href="bar.html">
                  bar.js
                </a>
              
                
                <a class="source" href="baz.html">
                  baz.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="mod.html">
                  mod.js
                </a>
              
                
                <a class="source" href="test.html">
                  test.js
                </a>
              
                
                <a class="source" href="test_coffee.html">
                  test_coffee.js
                </a>
              
                
                <a class="source" href="test_node_json.html">
                  test_node_json.js
                </a>
              
                
                <a class="source" href="test_node_mod.html">
                  test_node_mod.js
                </a>
              
                
                <a class="source" href="test_node_mod_index.html">
                  test_node_mod_index.js
                </a>
              
                
                <a class="source" href="test_node_mod_json_package.html">
                  test_node_mod_json_package.js
                </a>
              
                
                <a class="source" href="test_node_mod.html">
                  test_node_mod.js
                </a>
              
                
                <a class="source" href="test_patched_require.html">
                  test_patched_require.js
                </a>
              
                
                <a class="source" href="options.html">
                  options.js
                </a>
              
                
                <a class="source" href="script.html">
                  script.js
                </a>
              
                
                <a class="source" href="casper-instance-override.html">
                  casper-instance-override.js
                </a>
              
                
                <a class="source" href="dubious.html">
                  dubious.js
                </a>
              
                
                <a class="source" href="exit.html">
                  exit.js
                </a>
              
                
                <a class="source" href="failing.html">
                  failing.js
                </a>
              
                
                <a class="source" href="mytest.html">
                  mytest.js
                </a>
              
                
                <a class="source" href="passing.html">
                  passing.js
                </a>
              
                
                <a class="source" href="skipped.html">
                  skipped.js
                </a>
              
                
                <a class="source" href="step_throws.html">
                  step_throws.js
                </a>
              
                
                <a class="source" href="waitFor_timeout.html">
                  waitFor_timeout.js
                </a>
              
                
                <a class="source" href="run.html">
                  run.js
                </a>
              
                
                <a class="source" href="jsmodule.html">
                  jsmodule.js
                </a>
              
                
                <a class="source" href="selftest.html">
                  selftest.js
                </a>
              
                
                <a class="source" href="dummy.html">
                  dummy.js
                </a>
              
                
                <a class="source" href="include1.html">
                  include1.js
                </a>
              
                
                <a class="source" href="include2.html">
                  include2.js
                </a>
              
                
                <a class="source" href="agent.html">
                  agent.js
                </a>
              
                
                <a class="source" href="alert.html">
                  alert.js
                </a>
              
                
                <a class="source" href="auth.html">
                  auth.js
                </a>
              
                
                <a class="source" href="bypass.html">
                  bypass.js
                </a>
              
                
                <a class="source" href="callback.html">
                  callback.js
                </a>
              
                
                <a class="source" href="callutils.html">
                  callutils.js
                </a>
              
                
                <a class="source" href="capture.html">
                  capture.js
                </a>
              
                
                <a class="source" href="click.html">
                  click.js
                </a>
              
                
                <a class="source" href="confirm.html">
                  confirm.js
                </a>
              
                
                <a class="source" href="content.html">
                  content.js
                </a>
              
                
                <a class="source" href="css3selector.html">
                  css3selector.js
                </a>
              
                
                <a class="source" href="debug.html">
                  debug.js
                </a>
              
                
                <a class="source" href="elementattribute.html">
                  elementattribute.js
                </a>
              
                
                <a class="source" href="encode.html">
                  encode.js
                </a>
              
                
                <a class="source" href="encodedurl.html">
                  encodedurl.js
                </a>
              
                
                <a class="source" href="evaluate.html">
                  evaluate.js
                </a>
              
                
                <a class="source" href="events.html">
                  events.js
                </a>
              
                
                <a class="source" href="exists.html">
                  exists.js
                </a>
              
                
                <a class="source" href="fetchtext.html">
                  fetchtext.js
                </a>
              
                
                <a class="source" href="formfill.html">
                  formfill.js
                </a>
              
                
                <a class="source" href="frames.html">
                  frames.js
                </a>
              
                
                <a class="source" href="getplaintext.html">
                  getplaintext.js
                </a>
              
                
                <a class="source" href="global.html">
                  global.js
                </a>
              
                
                <a class="source" href="headers.html">
                  headers.js
                </a>
              
                
                <a class="source" href="history.html">
                  history.js
                </a>
              
                
                <a class="source" href="hooks.html">
                  hooks.js
                </a>
              
                
                <a class="source" href="keys.html">
                  keys.js
                </a>
              
                
                <a class="source" href="location.html">
                  location.js
                </a>
              
                
                <a class="source" href="logging.html">
                  logging.js
                </a>
              
                
                <a class="source" href="mouseevents.html">
                  mouseevents.js
                </a>
              
                
                <a class="source" href="multiplepopups.html">
                  multiplepopups.js
                </a>
              
                
                <a class="source" href="navigation.html">
                  navigation.js
                </a>
              
                
                <a class="source" href="newpage.html">
                  newpage.js
                </a>
              
                
                <a class="source" href="onerror.html">
                  onerror.js
                </a>
              
                
                <a class="source" href="open.html">
                  open.js
                </a>
              
                
                <a class="source" href="pagerequest.html">
                  pagerequest.js
                </a>
              
                
                <a class="source" href="popup.html">
                  popup.js
                </a>
              
                
                <a class="source" href="prompt.html">
                  prompt.js
                </a>
              
                
                <a class="source" href="reload.html">
                  reload.js
                </a>
              
                
                <a class="source" href="request.html">
                  request.js
                </a>
              
                
                <a class="source" href="resources.html">
                  resources.js
                </a>
              
                
                <a class="source" href="scripts.html">
                  scripts.js
                </a>
              
                
                <a class="source" href="scroll.html">
                  scroll.js
                </a>
              
                
                <a class="source" href="sendAjax.html">
                  sendAjax.js
                </a>
              
                
                <a class="source" href="start.html">
                  start.js
                </a>
              
                
                <a class="source" href="steps.html">
                  steps.js
                </a>
              
                
                <a class="source" href="urls.html">
                  urls.js
                </a>
              
                
                <a class="source" href="viewport.html">
                  viewport.js
                </a>
              
                
                <a class="source" href="visible.html">
                  visible.js
                </a>
              
                
                <a class="source" href="wait.html">
                  wait.js
                </a>
              
                
                <a class="source" href="xpath.html">
                  xpath.js
                </a>
              
                
                <a class="source" href="cli.html">
                  cli.js
                </a>
              
                
                <a class="source" href="clientutils.html">
                  clientutils.js
                </a>
              
                
                <a class="source" href="fs.html">
                  fs.js
                </a>
              
                
                <a class="source" href="http_status.html">
                  http_status.js
                </a>
              
                
                <a class="source" href="pagestack.html">
                  pagestack.js
                </a>
              
                
                <a class="source" href="require.html">
                  require.js
                </a>
              
                
                <a class="source" href="assert.html">
                  assert.js
                </a>
              
                
                <a class="source" href="begin-config.html">
                  begin-config.js
                </a>
              
                
                <a class="source" href="setup-teardown-async.html">
                  setup-teardown-async.js
                </a>
              
                
                <a class="source" href="setup-teardown.html">
                  setup-teardown.js
                </a>
              
                
                <a class="source" href="skip.html">
                  skip.js
                </a>
              
                
                <a class="source" href="test-order.html">
                  test-order.js
                </a>
              
                
                <a class="source" href="testcase.html">
                  testcase.js
                </a>
              
                
                <a class="source" href="testsuite.html">
                  testsuite.js
                </a>
              
                
                <a class="source" href="utils.html">
                  utils.js
                </a>
              
                
                <a class="source" href="xunit.html">
                  xunit.js
                </a>
              
                
                <a class="source" href="abc.html">
                  abc.js
                </a>
              
                
                <a class="source" href="def.html">
                  def.js
                </a>
              
                
                <a class="source" href="abc.html">
                  abc.js
                </a>
              
                
                <a class="source" href="03_a.html">
                  03_a.js
                </a>
              
                
                <a class="source" href="03_b.html">
                  03_b.js
                </a>
              
                
                <a class="source" href="01_init.html">
                  01_init.js
                </a>
              
                
                <a class="source" href="02_do.html">
                  02_do.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>casper.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*!
 * Casper is a navigation utility for PhantomJS.
 *
 * Documentation: http://casperjs.org/
 * Repository:    http://github.com/casperjs/casperjs
 *
 * Copyright (c) 2011-2012 Nicolas Perriault
 *
 * Part of source code is Copyright Joyent, Inc. and other Node contributors.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a
 * copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
 * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 *
 */</span>

<span class="hljs-comment">/*global __utils__, CasperError, console, exports, phantom, patchRequire, require:true*/</span>
<span class="hljs-built_in">require</span> = patchRequire(<span class="hljs-built_in">require</span>);
<span class="hljs-keyword">var</span> colorizer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'colorizer'</span>);
<span class="hljs-keyword">var</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>);
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">var</span> mouse = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mouse'</span>);
<span class="hljs-keyword">var</span> pagestack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pagestack'</span>);
<span class="hljs-keyword">var</span> qs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'querystring'</span>);
<span class="hljs-keyword">var</span> tester = <span class="hljs-built_in">require</span>(<span class="hljs-string">'tester'</span>);
<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'utils'</span>);
<span class="hljs-keyword">var</span> f = utils.format;


<span class="hljs-keyword">var</span> defaultUserAgent = phantom.defaultPageSettings.userAgent
    .replace(<span class="hljs-regexp">/(PhantomJS|SlimerJS)/</span>, f(<span class="hljs-string">"CasperJS/%s"</span>, phantom.casperVersion) + <span class="hljs-string">'+$&amp;'</span>);

exports.create = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span>(<span class="hljs-params">options</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This is a bit of a hack to check if one is trying to override the preconfigured
casper instance from within a test environment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (phantom.casperTest &amp;&amp; <span class="hljs-built_in">window</span>.casper) {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Fatal: you can't override the preconfigured casper instance in a test environment."</span>);
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Docs: http://docs.casperjs.org/en/latest/testing.html#test-command-args-and-options"</span>);
        phantom.exit(<span class="hljs-number">1</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Casper(options);
};

<span class="hljs-comment">/**
 * Shortcut to build an XPath selector object.
 *
 * @param  String  expression  The XPath expression
 * @return Object
 * @see    http://casperjs.org/selectors.html
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">selectXPath</span>(<span class="hljs-params">expression</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'xpath'</span>,
        <span class="hljs-attr">path</span>: expression,
        <span class="hljs-attr">toString</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.type + <span class="hljs-string">' selector: '</span> + <span class="hljs-keyword">this</span>.path;
        }
    };
}
exports.selectXPath = selectXPath;

<span class="hljs-comment">/**
 * Main Casper object.
 *
 * @param  Object  options  Casper options
 */</span>
<span class="hljs-keyword">var</span> Casper = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Casper</span>(<span class="hljs-params">options</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-comment">/*eslint max-statements:0*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>init &amp; checks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Casper)) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Casper(options);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>default options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.defaults = {
        <span class="hljs-attr">clientScripts</span>:       [],
        <span class="hljs-attr">colorizerType</span>:       <span class="hljs-string">'Colorizer'</span>,
        <span class="hljs-attr">exitOnError</span>:         <span class="hljs-literal">true</span>,
        <span class="hljs-attr">logLevel</span>:            <span class="hljs-string">"error"</span>,
        <span class="hljs-attr">httpStatusHandlers</span>:  {},
        <span class="hljs-attr">safeLogs</span>:            <span class="hljs-literal">true</span>,
        <span class="hljs-attr">onAlert</span>:             <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onDie</span>:               <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onError</span>:             <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onLoadError</span>:         <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onPageInitialized</span>:   <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onResourceReceived</span>:  <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onResourceRequested</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onRunComplete</span>:       <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_onRunComplete</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>.exit();
        },
        <span class="hljs-attr">onStepComplete</span>:      <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onStepTimeout</span>:       <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_onStepTimeout</span>(<span class="hljs-params">timeout, stepNum</span>) </span>{
            <span class="hljs-keyword">this</span>.die(<span class="hljs-string">"Maximum step execution timeout exceeded for step "</span> + stepNum);
        },
        <span class="hljs-attr">onTimeout</span>:           <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_onTimeout</span>(<span class="hljs-params">timeout</span>) </span>{
            <span class="hljs-keyword">this</span>.die(f(<span class="hljs-string">"Script timeout of %dms reached, exiting."</span>, timeout));
        },
        <span class="hljs-attr">onWaitTimeout</span>:       <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_onWaitTimeout</span>(<span class="hljs-params">timeout</span>) </span>{
            <span class="hljs-keyword">this</span>.die(f(<span class="hljs-string">"Wait timeout of %dms expired, exiting."</span>, timeout));
        },
        <span class="hljs-attr">page</span>:                <span class="hljs-literal">null</span>,
        <span class="hljs-attr">pageSettings</span>:        {
            <span class="hljs-attr">localToRemoteUrlAccessEnabled</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">javascriptEnabled</span>:             <span class="hljs-literal">true</span>,
            <span class="hljs-attr">userAgent</span>:                     defaultUserAgent
        },
        <span class="hljs-attr">remoteScripts</span>:       [],
        <span class="hljs-attr">silentErrors</span>:        <span class="hljs-literal">false</span>,
        <span class="hljs-attr">stepTimeout</span>:         <span class="hljs-literal">null</span>,
        <span class="hljs-attr">timeout</span>:             <span class="hljs-literal">null</span>,
        <span class="hljs-attr">verbose</span>:             <span class="hljs-literal">false</span>,
        <span class="hljs-attr">retryTimeout</span>:        <span class="hljs-number">20</span>,
        <span class="hljs-attr">waitTimeout</span>:         <span class="hljs-number">5000</span>,
        <span class="hljs-attr">clipRect</span> : <span class="hljs-literal">null</span>,
        <span class="hljs-attr">viewportSize</span> : <span class="hljs-literal">null</span>
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.options = utils.mergeObjects(<span class="hljs-keyword">this</span>.defaults, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>factories</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.cli = phantom.casperArgs;
    <span class="hljs-keyword">this</span>.options.logLevel = <span class="hljs-keyword">this</span>.cli.get(<span class="hljs-string">'log-level'</span>, <span class="hljs-keyword">this</span>.options.logLevel);
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.options.verbose) {
        <span class="hljs-keyword">this</span>.options.verbose = <span class="hljs-keyword">this</span>.cli.has(<span class="hljs-string">'direct'</span>) || <span class="hljs-keyword">this</span>.cli.has(<span class="hljs-string">'verbose'</span>);
    }
    <span class="hljs-keyword">this</span>.colorizer = <span class="hljs-keyword">this</span>.getColorizer();
    <span class="hljs-keyword">this</span>.mouse = mouse.create(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.popups = pagestack.create();</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.checker = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.currentResponse = {};
    <span class="hljs-keyword">this</span>.currentUrl = <span class="hljs-string">'about:blank'</span>;
    <span class="hljs-keyword">this</span>.currentHTTPStatus = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.history = [];
    <span class="hljs-keyword">this</span>.navigationRequested = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.logFormats = {};
    <span class="hljs-keyword">this</span>.logLevels = [<span class="hljs-string">"debug"</span>, <span class="hljs-string">"info"</span>, <span class="hljs-string">"warning"</span>, <span class="hljs-string">"error"</span>];
    <span class="hljs-keyword">this</span>.logStyles = {
        <span class="hljs-attr">debug</span>:   <span class="hljs-string">'INFO'</span>,
        <span class="hljs-attr">info</span>:    <span class="hljs-string">'PARAMETER'</span>,
        <span class="hljs-attr">warning</span>: <span class="hljs-string">'COMMENT'</span>,
        <span class="hljs-attr">error</span>:   <span class="hljs-string">'ERROR'</span>
    };
    <span class="hljs-keyword">this</span>.page = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.pendingWait = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.requestUrl = <span class="hljs-string">'about:blank'</span>;
    <span class="hljs-keyword">this</span>.resources = [];
    <span class="hljs-keyword">this</span>.result = {
        <span class="hljs-attr">log</span>:    [],
        <span class="hljs-attr">status</span>: <span class="hljs-string">"success"</span>,
        <span class="hljs-attr">time</span>:   <span class="hljs-number">0</span>
    };
    <span class="hljs-keyword">this</span>.started = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.step = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">this</span>.steps = [];
    <span class="hljs-keyword">this</span>.waiters = [];
    <span class="hljs-keyword">this</span>._test = <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">this</span>.__defineGetter__(<span class="hljs-string">'test'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!phantom.casperTest) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">'casper.test property is only available using the `casperjs test` command'</span>);
        }
        <span class="hljs-keyword">if</span> (!utils.isObject(<span class="hljs-keyword">this</span>._test)) {
            <span class="hljs-keyword">this</span>._test = tester.create(<span class="hljs-keyword">this</span>, {
                <span class="hljs-attr">concise</span>: <span class="hljs-keyword">this</span>.cli.get(<span class="hljs-string">'concise'</span>)
            });
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._test;
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>init phantomjs error handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.initErrorHandler();

    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg, backtrace</span>) </span>{
        <span class="hljs-keyword">var</span> c = <span class="hljs-keyword">this</span>.getColorizer();
        <span class="hljs-keyword">var</span> match = <span class="hljs-regexp">/^(.*): __mod_error(.*):: (.*)/</span>.exec(msg);
        <span class="hljs-keyword">var</span> notices = [];
        <span class="hljs-keyword">if</span> (match &amp;&amp; match.length === <span class="hljs-number">4</span>) {
            notices.push(<span class="hljs-string">'  in module '</span> + match[<span class="hljs-number">2</span>]);
            msg = match[<span class="hljs-number">3</span>];
        }

        <span class="hljs-built_in">console</span>.log(c.colorize(msg, <span class="hljs-string">'RED_BAR'</span>, <span class="hljs-number">80</span>));
        notices.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">notice</span>) </span>{
            <span class="hljs-built_in">console</span>.log(c.colorize(notice, <span class="hljs-string">'COMMENT'</span>));
        });
        (backtrace || []).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
            <span class="hljs-keyword">var</span> message = fs.absolute(item.file) + <span class="hljs-string">":"</span> + c.colorize(item.line, <span class="hljs-string">"COMMENT"</span>);
            <span class="hljs-keyword">if</span> (item[<span class="hljs-string">'function'</span>]) {
                message += <span class="hljs-string">" in "</span> + c.colorize(item[<span class="hljs-string">'function'</span>], <span class="hljs-string">"PARAMETER"</span>);
            }
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"  "</span> + message);
        });
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>deprecated feature event handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'deprecated'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onDeprecated</span>(<span class="hljs-params">message</span>) </span>{
        <span class="hljs-keyword">this</span>.warn(<span class="hljs-string">'[deprecated] '</span> + message);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>dispatching an event when instance has been constructed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'init'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>deprecated direct option</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cli.has(<span class="hljs-string">'direct'</span>)) {
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"deprecated"</span>, <span class="hljs-string">"--direct option has been deprecated since 1.1; you should use --verbose instead."</span>);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Casper class is an EventEmitter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>utils.inherits(Casper, events.EventEmitter);

<span class="hljs-comment">/**
 * Go a step back in browser's history
 *
 * @return Casper
 */</span>
Casper.prototype.back = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">back</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'back'</span>);
        <span class="hljs-keyword">this</span>.page.goBack();
    });
};

<span class="hljs-comment">/**
 * Encodes a resource using the base64 algorithm synchronously using
 * client-side XMLHttpRequest.
 *
 * <span class="hljs-doctag">NOTE:</span> we cannot use window.btoa() for some strange reasons here.
 *
 * @param  String  url     The url to download
 * @param  String  method  The method to use, optional: default GET
 * @param  String  data    The data to send, optional
 * @return string          Base64 encoded result
 */</span>
Casper.prototype.base64encode = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">base64encode</span>(<span class="hljs-params">url, method, data</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"getBase64"</span>, url, method, data);
};

<span class="hljs-comment">/**
 * Bypasses `nb` steps.
 *
 * @param  Integer  nb  Number of steps to bypass
 */</span>
Casper.prototype.bypass = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bypass</span>(<span class="hljs-params">nb</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">var</span> step = <span class="hljs-keyword">this</span>.step,
        steps = <span class="hljs-keyword">this</span>.steps,
        last = steps.length,
        targetStep = <span class="hljs-built_in">Math</span>.min(step + nb, last);
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">this</span>.step = targetStep;
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'step.bypassed'</span>, targetStep, step);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Invokes a client side utils object method within the remote page, with arguments.
 *
 * @param  {String}   method  Method name
 * @return {...args}          Arguments
 * @return {Mixed}
 * @throws {CasperError}      If invokation failed.
 */</span>
Casper.prototype.callUtils = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callUtils</span>(<span class="hljs-params">method</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">method, args</span>) </span>{
        <span class="hljs-keyword">return</span> __utils__.__call(method, args);
    }, method, args);
    <span class="hljs-keyword">if</span> (utils.isObject(result) &amp;&amp; result.__isCallError) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(f(<span class="hljs-string">"callUtils(%s) with args %s thrown an error: %s"</span>,
                              method, args, result.message));
    }
    <span class="hljs-keyword">return</span> result;
};

<span class="hljs-comment">/**
 * Proxy method for WebPage#render. Adds a clipRect parameter for
 * automatically set page clipRect setting values and sets it back once
 * done. If the cliprect parameter is omitted, the full page viewport
 * area will be rendered.
 *
 * @param  String  targetFile  A target filename
 * @param  mixed   clipRect    An optional clipRect object (optional)
 * @return Casper
 */</span>
Casper.prototype.capture = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">capture</span>(<span class="hljs-params">targetFile, clipRect, imgOptions</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-comment">/*eslint max-statements:0*/</span>
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">var</span> previousClipRect;
    targetFile = fs.absolute(targetFile);
    <span class="hljs-keyword">if</span> (clipRect) {
        <span class="hljs-keyword">if</span> (!utils.isClipRect(clipRect)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"clipRect must be a valid ClipRect object."</span>);
        }
        previousClipRect = <span class="hljs-keyword">this</span>.page.clipRect;
        <span class="hljs-keyword">this</span>.page.clipRect = clipRect;
        <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Capturing page to %s with clipRect %s"</span>, targetFile, <span class="hljs-built_in">JSON</span>.stringify(clipRect)), <span class="hljs-string">"debug"</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Capturing page to %s"</span>, targetFile), <span class="hljs-string">"debug"</span>);
    }
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.page.render(<span class="hljs-keyword">this</span>.filter(<span class="hljs-string">'capture.target_filename'</span>, targetFile) || targetFile, imgOptions)) {
        <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Failed to save screenshot to %s; please check permissions"</span>, targetFile), <span class="hljs-string">"error"</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Capture saved to %s"</span>, targetFile), <span class="hljs-string">"info"</span>);
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'capture.saved'</span>, targetFile);
    }
    <span class="hljs-keyword">if</span> (previousClipRect) {
        <span class="hljs-keyword">this</span>.page.clipRect = previousClipRect;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Returns a Base64 representation of a binary image capture of the current
 * page, or an area within the page, in a given format.
 *
 * Supported image formats are `bmp`, `jpg`, `jpeg`, `png`, `ppm`, `tiff`,
 * `xbm` and `xpm`.
 *
 * @param  String                   format    The image format
 * @param  String|Object|undefined  selector  DOM CSS3/XPath selector or clipRect object (optional)
 * @return Casper
 */</span>
Casper.prototype.captureBase64 = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">captureBase64</span>(<span class="hljs-params">format, area</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-comment">/*eslint max-statements:0*/</span>
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">var</span> base64, previousClipRect, formats = [<span class="hljs-string">'bmp'</span>, <span class="hljs-string">'jpg'</span>, <span class="hljs-string">'jpeg'</span>, <span class="hljs-string">'png'</span>, <span class="hljs-string">'ppm'</span>, <span class="hljs-string">'tiff'</span>, <span class="hljs-string">'xbm'</span>, <span class="hljs-string">'xpm'</span>];
    <span class="hljs-keyword">if</span> (formats.indexOf(format.toLowerCase()) === <span class="hljs-number">-1</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(f(<span class="hljs-string">'Unsupported format "%s"'</span>, format));
    }
    <span class="hljs-keyword">if</span> (utils.isClipRect(area)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>if area is a clipRect object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Capturing base64 %s representation of %s"</span>, format, utils.serialize(area)), <span class="hljs-string">"debug"</span>);
        previousClipRect = <span class="hljs-keyword">this</span>.page.clipRect;
        <span class="hljs-keyword">this</span>.page.clipRect = area;
        base64 = <span class="hljs-keyword">this</span>.page.renderBase64(format);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (utils.isValidSelector(area)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>if area is a selector string or object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Capturing base64 %s representation of %s"</span>, format, area), <span class="hljs-string">"debug"</span>);
        <span class="hljs-keyword">var</span> scrollPos = <span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> { <span class="hljs-attr">x</span>: scrollX, <span class="hljs-attr">y</span>: scrollY };
        });
        <span class="hljs-keyword">var</span> elementBounds = <span class="hljs-keyword">this</span>.getElementBounds(area);
        elementBounds.top += scrollPos.y;
        elementBounds.left += scrollPos.x;
        base64 = <span class="hljs-keyword">this</span>.captureBase64(format, elementBounds);
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>whole page capture</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Capturing base64 %s representation of page"</span>, format), <span class="hljs-string">"debug"</span>);
        base64 = <span class="hljs-keyword">this</span>.page.renderBase64(format);
    }
    <span class="hljs-keyword">if</span> (previousClipRect) {
        <span class="hljs-keyword">this</span>.page.clipRect = previousClipRect;
    }
    <span class="hljs-keyword">return</span> base64;
};

<span class="hljs-comment">/**
 * Captures the page area matching the provided selector.
 *
 * @param  String  targetFile  Target destination file path.
 * @param  String  selector    DOM CSS3/XPath selector
 * @return Casper
 */</span>
Casper.prototype.captureSelector = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">captureSelector</span>(<span class="hljs-params">targetFile, selector, imgOptions</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">var</span> scrollPos = <span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x</span>: scrollX, <span class="hljs-attr">y</span>: scrollY };
    });
    <span class="hljs-keyword">var</span> elementBounds = <span class="hljs-keyword">this</span>.getElementBounds(selector);
    elementBounds.top += scrollPos.y;
    elementBounds.left += scrollPos.x;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.capture(targetFile, elementBounds, imgOptions);
};

<span class="hljs-comment">/**
 * Checks for any further navigation step to process.
 *
 * @param  Casper    self        A self reference
 * @param  function  onComplete  An options callback to apply on completion
 */</span>
Casper.prototype.checkStep = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkStep</span>(<span class="hljs-params">self, onComplete</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;

    <span class="hljs-keyword">if</span> (self.page !== <span class="hljs-literal">null</span> &amp;&amp; (self.pendingWait || self.page.loadInProgress || self.navigationRequested || self.page.browserInitializing )) {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> step = self.steps[self.step++];
    <span class="hljs-keyword">if</span> (utils.isFunction(step)) {
        <span class="hljs-keyword">return</span> self.runStep(step);
    }
    self.result.time = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - self.startTime;
    self.log(f(<span class="hljs-string">"Done %s steps in %dms"</span>, self.steps.length, self.result.time), <span class="hljs-string">"info"</span>);
    clearInterval(self.checker);
    self.step -= <span class="hljs-number">1</span>;
    self.emit(<span class="hljs-string">'run.complete'</span>);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (utils.isFunction(onComplete)) {
            onComplete.call(self, self);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (utils.isFunction(self.options.onRunComplete)) {
            self.options.onRunComplete.call(self, self);
        }
    } <span class="hljs-keyword">catch</span> (error) {
        self.emit(<span class="hljs-string">'complete.error'</span>, error);
        <span class="hljs-keyword">if</span> (!self.options.silentErrors) {
            <span class="hljs-keyword">throw</span> error;
        }
    }
};

<span class="hljs-comment">/**
 * Checks if this instance is started.
 *
 * @return Boolean
 * @throws CasperError
 */</span>
Casper.prototype.checkStarted = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkStarted</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.started) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(f(<span class="hljs-string">"Casper is not started, can't execute `%s()`"</span>,
                                checkStarted.caller.name));
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.page === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">this</span>.newPage();
    }
};

<span class="hljs-comment">/**
 * Clears the current page execution environment context. Useful to avoid
 * having previously loaded DOM contents being still active (refs #34).
 *
 * Think of it as a way to stop javascript execution within the remote DOM
 * environment.
 *
 * @return Casper
 */</span>
Casper.prototype.clear = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clear</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">this</span>.page.content = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Replace currente page by a new page object, with newPage()
 * Clears the memory cache, with clearMemoryCache()
 * 
 * @return Casper
 */</span>
Casper.prototype.clearCache = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearCache</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">this</span>.page = <span class="hljs-keyword">this</span>.newPage();
    <span class="hljs-keyword">this</span>.clearMemoryCache();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Clears the memory cache, using engine method
 * reference: https://github.com/ariya/phantomjs/issues/10357
 *
 * @return Casper
 */</span>
Casper.prototype.clearMemoryCache = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearMemoryCache</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.page.clearMemoryCache === <span class="hljs-string">'function'</span>) {
        <span class="hljs-keyword">this</span>.page.clearMemoryCache();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( phantom.casperEngine === <span class="hljs-string">'slimerjs'</span> || utils.matchEngine({<span class="hljs-attr">name</span>: <span class="hljs-string">'phantomjs'</span>, <span class="hljs-attr">version</span>: {<span class="hljs-attr">min</span>: <span class="hljs-string">'2.0.0'</span>}}) ) {
        <span class="hljs-keyword">this</span>.log(<span class="hljs-string">'clearMemoryCache() did nothing: page.clearMemoryCache is not avliable in this engine'</span>, <span class="hljs-string">"warning"</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"clearMemoryCache(): page.clearMemoryCache should be avaliable in this engine"</span>);
    };
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Emulates a click on the element from the provided selector using the mouse
 * pointer, if possible.
 *
 * In case of success, `true` is returned, `false` otherwise.
 *
 * @param  String   selector  A DOM CSS3 compatible selector
 * @param  String   target    A HTML target '_blank','_self','_parent','_top','framename' (optional)
 * @param  Number   x         X position (optional)
 * @param  Number   y         Y position (optional)
 * @return Boolean
 */</span>
Casper.prototype.click = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">click</span>(<span class="hljs-params">selector, x, y</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">var</span> success = <span class="hljs-keyword">this</span>.mouseEvent(<span class="hljs-string">'mousedown'</span>, selector, x, y) &amp;&amp; <span class="hljs-keyword">this</span>.mouseEvent(<span class="hljs-string">'mouseup'</span>, selector, x, y);
    success = success &amp;&amp; <span class="hljs-keyword">this</span>.mouseEvent(<span class="hljs-string">'click'</span>, selector, x, y);
    <span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">selector</span>) </span>{
        <span class="hljs-keyword">var</span> element = __utils__.findOne(selector);
        <span class="hljs-keyword">if</span> (element) {
            element.focus();
        }
    }, selector);
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'click'</span>, selector);
    <span class="hljs-keyword">return</span> success;
};

<span class="hljs-comment">/**
 * Emulates a click on the element having `label` as innerText. The first
 * element matching this label will be selected, so use with caution.
 *
 * @param  String   label  Element innerText value
 * @param  String   tag    An element tag name (eg. `a` or `button`) (optional)
 * @return Boolean
 */</span>
Casper.prototype.clickLabel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clickLabel</span>(<span class="hljs-params">label, tag</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    tag = tag || <span class="hljs-string">"*"</span>;
    <span class="hljs-keyword">var</span> escapedLabel = utils.quoteXPathAttributeString(label);
    <span class="hljs-keyword">var</span> selector = selectXPath(f(<span class="hljs-string">'//%s[text()=%s]'</span>, tag, escapedLabel));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.click(selector);
};

<span class="hljs-comment">/**
 * Configures HTTP authentication parameters. Will try parsing auth credentials from
 * the passed location first, then check for configured settings if any.
 *
 * @param  String  location  Requested url
 * @param  Object  settings  Request settings
 * @return Casper
 */</span>
Casper.prototype.configureHttpAuth = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">configureHttpAuth</span>(<span class="hljs-params">location, settings</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">var</span> httpAuthMatch = location.match(<span class="hljs-regexp">/^https?:\/\/(.+):(.+)@/i</span>);
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (httpAuthMatch) {
        <span class="hljs-keyword">this</span>.page.settings.userName = httpAuthMatch[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">this</span>.page.settings.password = httpAuthMatch[<span class="hljs-number">2</span>];
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (utils.isObject(settings) &amp;&amp; settings.username) {
        <span class="hljs-keyword">this</span>.page.settings.userName = settings.username;
        <span class="hljs-keyword">this</span>.page.settings.password = settings.password;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'http.auth'</span>, <span class="hljs-keyword">this</span>.page.settings.userName, <span class="hljs-keyword">this</span>.page.settings.password);
    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"Setting HTTP authentication for user "</span> + <span class="hljs-keyword">this</span>.page.settings.userName, <span class="hljs-string">"info"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Creates a step definition.
 *
 * @param  Function  fn       The step function to call
 * @param  Object    options  Step options
 * @return Function  The final step function
 */</span>
Casper.prototype.createStep = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createStep</span>(<span class="hljs-params">fn, options</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">if</span> (!utils.isFunction(fn)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"createStep(): a step definition must be a function"</span>);
    }
    fn.options = utils.isObject(options) ? options : {};
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'step.created'</span>, fn);
    <span class="hljs-keyword">return</span> fn;
};

<span class="hljs-comment">/**
 * Logs the HTML code of the current page.
 *
 * @param  String   selector  A DOM CSS3/XPath selector (optional)
 * @param  Boolean  outer     Whether to fetch outer HTML contents (default: false)
 * @return Casper
 */</span>
Casper.prototype.debugHTML = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">debugHTML</span>(<span class="hljs-params">selector, outer</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.echo(<span class="hljs-keyword">this</span>.getHTML(selector, outer));
};

<span class="hljs-comment">/**
 * Logs the textual contents of the current page.
 *
 * @return Casper
 */</span>
Casper.prototype.debugPage = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">debugPage</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">this</span>.echo(<span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_evaluate</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.body.textContent || <span class="hljs-built_in">document</span>.body.innerText;
    }));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Exit phantom on failure, with a logged error message.
 *
 * @param  String  message  An optional error message
 * @param  Number  status   An optional exit status code (must be &gt; 0)
 * @return Casper
 */</span>
Casper.prototype.die = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">die</span>(<span class="hljs-params">message, status</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.result.status = <span class="hljs-string">"error"</span>;
    <span class="hljs-keyword">this</span>.result.time = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - <span class="hljs-keyword">this</span>.startTime;
    <span class="hljs-keyword">if</span> (!utils.isString(message) || !message.length) {
        message = <span class="hljs-string">"Suite explicitly interrupted without any message given."</span>;
    }
    <span class="hljs-keyword">this</span>.log(message, <span class="hljs-string">"error"</span>);
    <span class="hljs-keyword">this</span>.echo(message, <span class="hljs-string">"ERROR"</span>);
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'die'</span>, message, status);
    <span class="hljs-keyword">if</span> (utils.isFunction(<span class="hljs-keyword">this</span>.options.onDie)) {
        <span class="hljs-keyword">this</span>.options.onDie.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>, message, status);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.exit(~~status &gt; <span class="hljs-number">0</span> ? ~~status : <span class="hljs-number">1</span>);
};

<span class="hljs-comment">/**
 * Downloads a resource and saves it on the filesystem.
 *
 * @param  String  url         The url of the resource to download
 * @param  String  targetPath  The destination file path
 * @param  String  method      The HTTP method to use (default: GET)
 * @param  String  data        Optional data to pass performing the request
 * @return Casper
 */</span>
Casper.prototype.download = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">download</span>(<span class="hljs-params">url, targetPath, method, data</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">var</span> cu = <span class="hljs-built_in">require</span>(<span class="hljs-string">'clientutils'</span>).create(utils.mergeObjects({}, <span class="hljs-keyword">this</span>.options));
    <span class="hljs-keyword">try</span> {
        fs.write(targetPath, cu.decode(<span class="hljs-keyword">this</span>.base64encode(url, method, data)), <span class="hljs-string">'wb'</span>);
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'downloaded.file'</span>, targetPath);
        <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Downloaded and saved resource in %s"</span>, targetPath));
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'downloaded.error'</span>, url);
        <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Error while downloading %s to %s: %s"</span>, url, targetPath, e), <span class="hljs-string">"error"</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Iterates over the values of a provided array and execute a callback for each
 * item.
 *
 * @param  Array     array
 * @param  Function  fn     Callback: function(casper, item, index)
 * @return Casper
 */</span>
Casper.prototype.each = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">each</span>(<span class="hljs-params">array, fn</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">if</span> (!utils.isArray(array)) {
        <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"each() only works with arrays"</span>, <span class="hljs-string">"error"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }
    array.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_forEach</span>(<span class="hljs-params">item, i</span>) </span>{
        fn.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>, item, i);
    }, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Iterates over the values of a provided array and adds a step for each item.
 *
 * @param  Array     array
 * @param  Function  then   Step: function(response); item will be attached to response.data
 * @return Casper
 */</span>
Casper.prototype.eachThen = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">each</span>(<span class="hljs-params">array, then</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">if</span> (!utils.isArray(array)) {
        <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"eachThen() only works with arrays"</span>, <span class="hljs-string">"error"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }
    array.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_forEach</span>(<span class="hljs-params">item</span>) </span>{
        <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>.then(<span class="hljs-keyword">this</span>.createStep(then, {<span class="hljs-attr">data</span>: item}));
        });
    }, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Prints something to stdout.
 *
 * @param  String  text   A string to echo to stdout
 * @param  String  style  An optional style name
 * @param  Number  pad    An optional pad value
 * @return Casper
 */</span>
Casper.prototype.echo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">echo</span>(<span class="hljs-params">text, style, pad</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">if</span> (!utils.isString(text)) {
        <span class="hljs-keyword">try</span> {
            text = text.toString();
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-keyword">try</span> {
                text = utils.serialize(text);
            } <span class="hljs-keyword">catch</span> (e2) {
                text = <span class="hljs-string">''</span>;
            }
        }
    }
    <span class="hljs-keyword">var</span> message = style ? <span class="hljs-keyword">this</span>.colorizer.colorize(text, style, pad) : text;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">this</span>.filter(<span class="hljs-string">'echo.message'</span>, message) || message);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Evaluates an expression in the page context, a bit like what
 * WebPage#evaluate does, but the passed function can also accept
 * parameters if a context Object is also passed:
 *
 *     casper.evaluate(function(username, password) {
 *         document.querySelector('#username').value = username;
 *         document.querySelector('#password').value = password;
 *         document.querySelector('#submit').click();
 *     }, 'Bazoonga', 'baz00nga');
 *
 * @param  Function  fn       The function to be evaluated within current page DOM
 * @param  Object    context  Object containing the parameters to inject into the function
 * @return mixed
 * @see    WebPage#evaluate
 */</span>
Casper.prototype.evaluate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">evaluate</span>(<span class="hljs-params">fn, context</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>check whether javascript is enabled !!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.options.pageSettings.javascriptEnabled === <span class="hljs-literal">false</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"evaluate() requires javascript to be enabled"</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>preliminary checks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!utils.isFunction(fn) &amp;&amp; !utils.isString(fn)) { <span class="hljs-comment">// phantomjs allows functions defs as string</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"evaluate() only accepts functions or strings"</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>ensure client utils are always injected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.injectClientUtils();</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>function context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> utils.clone(<span class="hljs-keyword">this</span>.page.evaluate(fn));
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">2</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>check for closure signature if it matches context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (utils.isObject(context) &amp;&amp; fn.length === <span class="hljs-built_in">Object</span>.keys(context).length) {
            <span class="hljs-comment">/*
             * in case if user passes argument as one array with only one object.
             * evaluate shlould return original array with one object
             * instead of converte this array to object
             */</span>
            <span class="hljs-keyword">if</span> (utils.isArray(context) &amp;&amp; context.length === <span class="hljs-number">1</span>) {
                context = [context];
            } <span class="hljs-keyword">else</span> {
                context = utils.objectValues(context);
            }
        } <span class="hljs-keyword">else</span> {
            context = [context];
        }
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>phantomjs-style signature</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        context = [].slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
    }
    <span class="hljs-keyword">return</span> utils.clone(<span class="hljs-keyword">this</span>.page.evaluate.apply(<span class="hljs-keyword">this</span>.page, [fn].concat(context)));
};

<span class="hljs-comment">/**
 * Evaluates an expression within the current page DOM and die() if it
 * returns false.
 *
 * @param  function  fn       The expression to evaluate
 * @param  String    message  The error message to log
 * @param  Number  status   An optional exit status code (must be &gt; 0)
 *
 * @return Casper
 */</span>
Casper.prototype.evaluateOrDie = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">evaluateOrDie</span>(<span class="hljs-params">fn, message, status</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.evaluate(fn)) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.die(message, status);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Checks if an element matching the provided DOM CSS3/XPath selector exists in
 * current page DOM.
 *
 * @param  String  selector  A DOM CSS3/XPath selector
 * @return Boolean
 */</span>
Casper.prototype.exists = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exists</span>(<span class="hljs-params">selector</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"exists"</span>, selector);
};

<span class="hljs-comment">/**
 * Exits phantom.
 *
 * @param  Number  status  Status
 * @return Casper
 */</span>
Casper.prototype.exit = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exit</span>(<span class="hljs-params">status</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'exit'</span>, status);
    <span class="hljs-keyword">this</span>.die = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{};
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ phantom.exit(status); }, <span class="hljs-number">0</span>);
};

<span class="hljs-comment">/**
 * Fetches plain text contents contained in the DOM element(s) matching a given CSS3/XPath
 * selector.
 *
 * @param  String  selector  A DOM CSS3/XPath selector
 * @return String
 */</span>
Casper.prototype.fetchText = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchText</span>(<span class="hljs-params">selector</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"fetchText"</span>, selector);
};

<span class="hljs-comment">/**
 * Fills a form with provided field values.
 *
 * @param  String selector  A DOM CSS3/XPath selector to the target form to fill
 * @param  Object vals      Field values
 * @param  Object options   The fill settings (optional)
 */</span>
Casper.prototype.fillForm = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fillForm</span>(<span class="hljs-params">selector, vals, options</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> selectorType = options &amp;&amp; options.selectorType || <span class="hljs-string">"names"</span>,
        submit = !!(options &amp;&amp; options.submit);

    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'fill'</span>, selector, vals, options);

    <span class="hljs-keyword">var</span> fillResults = <span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_evaluate</span>(<span class="hljs-params">selector, vals, selectorType</span>) </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> __utils__.fill(selector, vals, selectorType);
        } <span class="hljs-keyword">catch</span> (exception) {
            <span class="hljs-keyword">return</span> {<span class="hljs-attr">exception</span>: exception.toString()};
        }
    }, selector, vals, selectorType);

    <span class="hljs-keyword">if</span> (!fillResults) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"Unable to fill form"</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fillResults &amp;&amp; fillResults.exception) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"Unable to fill form: "</span> + fillResults.exception);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fillResults.errors.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(f(<span class="hljs-string">'Errors encountered while filling form: %s'</span>,
                              fillResults.errors.join(<span class="hljs-string">'; '</span>)));
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>File uploads</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (fillResults.files &amp;&amp; fillResults.files.length &gt; <span class="hljs-number">0</span>) {
        fillResults.files.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_forEach</span>(<span class="hljs-params">file</span>) </span>{
            <span class="hljs-keyword">if</span> (!file || !file.path) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">var</span> paths = (utils.isArray(file.path) &amp;&amp; file.path.length &gt; <span class="hljs-number">0</span>) ? file.path : [file.path];
            paths.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filePath</span>) </span>{
                <span class="hljs-keyword">if</span> (!fs.exists(filePath)) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">'Cannot upload nonexistent file: '</span> + filePath);
                }
            },<span class="hljs-keyword">this</span>);
            <span class="hljs-keyword">var</span> fileFieldSelector;
            <span class="hljs-keyword">if</span> (file.type === <span class="hljs-string">"names"</span>) {
                fileFieldSelector = [selector, <span class="hljs-string">'input[name="'</span> + file.selector + <span class="hljs-string">'"]'</span>].join(<span class="hljs-string">' '</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file.type === <span class="hljs-string">"css"</span> || file.type === <span class="hljs-string">"labels"</span>) {
                fileFieldSelector = [selector, file.selector].join(<span class="hljs-string">' '</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file.type === <span class="hljs-string">"xpath"</span>) {
                fileFieldSelector = [selector, self.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_evaluate</span>(<span class="hljs-params">selector, scope, limit</span>) </span>{
                    <span class="hljs-keyword">return</span> __utils__.getCssSelector(selector, scope, limit);
                }, selectXPath(file.selector), selector, <span class="hljs-string">'FORM'</span>)].join(<span class="hljs-string">' '</span>);
            }
            <span class="hljs-keyword">this</span>.page.uploadFile(fileFieldSelector, paths);
        }.bind(<span class="hljs-keyword">this</span>));
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Form submission?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (submit) {
        <span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_evaluate</span>(<span class="hljs-params">selector</span>) </span>{
            <span class="hljs-keyword">var</span> form = __utils__.findOne(selector);
            <span class="hljs-keyword">var</span> method = (form.getAttribute(<span class="hljs-string">'method'</span>) || <span class="hljs-string">"GET"</span>).toUpperCase();
            <span class="hljs-keyword">var</span> action = form.getAttribute(<span class="hljs-string">'action'</span>) || <span class="hljs-string">"unknown"</span>;
            __utils__.log(<span class="hljs-string">'submitting form to '</span> + action + <span class="hljs-string">', HTTP '</span> + method, <span class="hljs-string">'info'</span>);
            <span class="hljs-keyword">var</span> event = <span class="hljs-built_in">document</span>.createEvent(<span class="hljs-string">'Event'</span>);
            event.initEvent(<span class="hljs-string">'submit'</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">if</span> (!form.dispatchEvent(event)) {
                __utils__.log(<span class="hljs-string">'unable to submit form'</span>, <span class="hljs-string">'warning'</span>);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> form.submit === <span class="hljs-string">"function"</span>) {
                form.submit();
            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><a href="http://www.spiration.co.uk/post/1232/Submit-is-not-a-function">http://www.spiration.co.uk/post/1232/Submit-is-not-a-function</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                form.submit.click();
            }
        }, selector);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Fills a form with provided field values using the Name attribute.
 *
 * @param  String  formSelector  A DOM CSS3/XPath selector to the target form to fill
 * @param  Object  vals          Field values
 * @param  Boolean submit        Submit the form?
 */</span>
Casper.prototype.fillNames = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fillNames</span>(<span class="hljs-params">formSelector, vals, submit</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fillForm(formSelector, vals, {
        <span class="hljs-attr">submit</span>: submit,
        <span class="hljs-attr">selectorType</span>: <span class="hljs-string">'names'</span>
    });
};

<span class="hljs-comment">/**
 * Fills a form with provided field values using associated label text.
 *
 * @param  String  formSelector  A DOM CSS3/XPath selector to the target form to fill
 * @param  Object  vals          Field values
 * @param  Boolean submit        Submit the form?
 */</span>
Casper.prototype.fillLabels = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fillLabels</span>(<span class="hljs-params">formSelector, vals, submit</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fillForm(formSelector, vals, {
        <span class="hljs-attr">submit</span>: submit,
        <span class="hljs-attr">selectorType</span>: <span class="hljs-string">'labels'</span>
    });
};

<span class="hljs-comment">/**
 * Fills a form with provided field values using CSS3 selectors.
 *
 * @param  String  formSelector  A DOM CSS3/XPath selector to the target form to fill
 * @param  Object  vals          Field values
 * @param  Boolean submit        Submit the form?
 */</span>
Casper.prototype.fillSelectors = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fillSelectors</span>(<span class="hljs-params">formSelector, vals, submit</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fillForm(formSelector, vals, {
        <span class="hljs-attr">submit</span>: submit,
        <span class="hljs-attr">selectorType</span>: <span class="hljs-string">'css'</span>
    });
};

<span class="hljs-comment">/**
 * Fills a form with provided field values using the Name attribute by default.
 *
 * @param  String  formSelector  A DOM CSS3/XPath selector to the target form to fill
 * @param  Object  vals          Field values
 * @param  Boolean submit        Submit the form?
 */</span>
Casper.prototype.fill = Casper.prototype.fillNames;

<span class="hljs-comment">/**
 * Fills a form with provided field values using XPath selectors.
 *
 * @param  String  formSelector  A DOM CSS3/XPath selector to the target form to fill
 * @param  Object  vals          Field values
 * @param  Boolean submit        Submit the form?
 */</span>
Casper.prototype.fillXPath = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fillXPath</span>(<span class="hljs-params">formSelector, vals, submit</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fillForm(formSelector, vals, {
        <span class="hljs-attr">submit</span>: submit,
        <span class="hljs-attr">selectorType</span>: <span class="hljs-string">'xpath'</span>
    });
};

<span class="hljs-comment">/**
 * Go a step forward in browser's history
 *
 * @return Casper
 */</span>
Casper.prototype.forward = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">forward</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'forward'</span>);
        <span class="hljs-keyword">this</span>.page.goForward();
    });
};

<span class="hljs-comment">/**
 * Creates a new Colorizer instance. Sets `Casper.options.type` to change the
 * colorizer type name (see the `colorizer` module).
 *
 * @return Object
 */</span>
Casper.prototype.getColorizer = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getColorizer</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">return</span> colorizer.create(<span class="hljs-keyword">this</span>.options.colorizerType || <span class="hljs-string">'Colorizer'</span>);
};

<span class="hljs-comment">/**
 * Retrieves current page contents, dealing with exotic other content types than HTML.
 *
 * @return String
 */</span>
Casper.prototype.getPageContent = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPageContent</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">var</span> contentType = utils.getPropertyPath(<span class="hljs-keyword">this</span>, <span class="hljs-string">'currentResponse.contentType'</span>);
    <span class="hljs-keyword">if</span> (!utils.isString(contentType) || contentType.indexOf(<span class="hljs-string">"text/html"</span>) !== <span class="hljs-number">-1</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.page.frameContent;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>FIXME: with slimerjs this will work only for
text/* and application/json content types.
see FIXME in slimerjs src/modules/webpageUtils.jsm getWindowContent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.page.framePlainText;
};

<span class="hljs-comment">/**
 * Retrieves current page contents in plain text.
 *
 * @return String
 */</span>
Casper.prototype.getPlainText = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPlainText</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.page.framePlainText;
};

<span class="hljs-comment">/**
 * Retrieves current document url.
 *
 * @return String
 */</span>
Casper.prototype.getCurrentUrl = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCurrentUrl</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.options.pageSettings.javascriptEnabled === <span class="hljs-literal">false</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.page.url;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> utils.decodeUrl(<span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_evaluate</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.location.href;
            }));
        }
    } <span class="hljs-keyword">catch</span> (e) {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>most likely the current page object has been “deleted” (think closed popup)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/deleted QObject/</span>.test(e.message))
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        <span class="hljs-keyword">throw</span> e;
    }
};

<span class="hljs-comment">/**
 * Retrieves the value of an attribute on the first element matching the provided
 * DOM CSS3/XPath selector.
 *
 * @param  String  selector   A DOM CSS3/XPath selector
 * @param  String  attribute  The attribute name to lookup
 * @return String  The requested DOM element attribute value
 */</span>
Casper.prototype.getElementAttribute =
Casper.prototype.getElementAttr = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getElementAttr</span>(<span class="hljs-params">selector, attribute</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_evaluate</span>(<span class="hljs-params">selector, attribute</span>) </span>{
        <span class="hljs-keyword">return</span> __utils__.findOne(selector).getAttribute(attribute);
    }, selector, attribute);
};

<span class="hljs-comment">/**
 * Retrieves the value of an attribute for each element matching the provided
 * DOM CSS3/XPath selector.
 *
 * @param  String  selector   A DOM CSS3/XPath selector
 * @param  String  attribute  The attribute name to lookup
 * @return Array
 */</span>
Casper.prototype.getElementsAttribute =
Casper.prototype.getElementsAttr = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getElementsAttr</span>(<span class="hljs-params">selector, attribute</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_evaluate</span>(<span class="hljs-params">selector, attribute</span>) </span>{
        <span class="hljs-keyword">return</span> [].map.call(__utils__.findAll(selector), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element</span>) </span>{
            <span class="hljs-keyword">return</span> element.getAttribute(attribute);
        });
    }, selector, attribute);
};

<span class="hljs-comment">/**
 * Retrieves boundaries for a DOM element matching the provided DOM CSS3/XPath selector.
 *
 * @param  String  selector  A DOM CSS3/XPath selector
 * @param  Boolean page      A flag that allows to get coords of the full page (iframe includes)
 * @return Object
 */</span>
Casper.prototype.getElementBounds = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getElementBounds</span>(<span class="hljs-params">selector, page</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.exists(selector)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"No element matching selector found: "</span> + selector);
    }
    <span class="hljs-keyword">var</span> zoomFactor = <span class="hljs-keyword">this</span>.page.zoomFactor || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> clipRect = <span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"getElementBounds"</span>, selector);
    <span class="hljs-keyword">if</span> (zoomFactor !== <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> prop <span class="hljs-keyword">in</span> clipRect) {
            <span class="hljs-keyword">if</span> (clipRect.hasOwnProperty(prop)) {
                clipRect[prop] = clipRect[prop] * zoomFactor;
            }
        }
    }
    <span class="hljs-keyword">if</span> (!utils.isClipRect(clipRect)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">'Could not fetch boundaries for element matching selector: '</span> + selector);
    }
    <span class="hljs-keyword">if</span> (page) {
        clipRect = {
            <span class="hljs-string">"x"</span>: clipRect.left + <span class="hljs-keyword">this</span>.page.context.x,
            <span class="hljs-string">"y"</span>: clipRect.top + <span class="hljs-keyword">this</span>.page.context.y,
            <span class="hljs-string">"left"</span>: clipRect.left + <span class="hljs-keyword">this</span>.page.context.x,
            <span class="hljs-string">"top"</span>: clipRect.top + <span class="hljs-keyword">this</span>.page.context.y,
            <span class="hljs-string">"width"</span>: clipRect.width,
            <span class="hljs-string">"height"</span>: clipRect.height
        };
    }
    <span class="hljs-keyword">return</span> clipRect;
};

<span class="hljs-comment">/**
 * Retrieves information about the node matching the provided selector.
 *
 * @param  String|Objects  selector  CSS3/XPath selector
 * @return Object
 */</span>
Casper.prototype.getElementInfo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getElementInfo</span>(<span class="hljs-params">selector</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.exists(selector)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(f(<span class="hljs-string">"Cannot get informations from %s: element not found."</span>, selector));
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"getElementInfo"</span>, selector);
};

<span class="hljs-comment">/**
 * Retrieves information about the nodes matching the provided selector.
 *
 * @param String|Objects  selector  CSS3/XPath selector
 * @return Array
 */</span>
Casper.prototype.getElementsInfo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getElementsInfo</span>(<span class="hljs-params">selector</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.exists(selector)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(f(<span class="hljs-string">"Cannot get information from %s: no elements found."</span>, selector));
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"getElementsInfo"</span>, selector);
};

<span class="hljs-comment">/**
 * Retrieves boundaries for all the DOM elements matching the provided DOM CSS3/XPath selector.
 *
 * @param  String  selector  A DOM CSS3/XPath selector
 * @return Array
 */</span>
Casper.prototype.getElementsBounds = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getElementsBounds</span>(<span class="hljs-params">selector</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.exists(selector)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"No element matching selector found: "</span> + selector);
    }
    <span class="hljs-keyword">var</span> zoomFactor = <span class="hljs-keyword">this</span>.page.zoomFactor || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> clipRects = <span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"getElementsBounds"</span>, selector);
    <span class="hljs-keyword">if</span> (zoomFactor !== <span class="hljs-number">1</span>) {
        <span class="hljs-built_in">Array</span>.prototype.forEach.call(clipRects, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">clipRect</span>) </span>{
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> prop <span class="hljs-keyword">in</span> clipRect) {
                <span class="hljs-keyword">if</span> (clipRect.hasOwnProperty(prop)) {
                    clipRect[prop] = clipRect[prop] * zoomFactor;
                }
            }
        });
    }
    <span class="hljs-keyword">return</span> clipRects;
};

<span class="hljs-comment">/**
 * Retrieves a given form all of its field values.
 *
 * @param  String  selector  A DOM CSS3/XPath selector
 * @return Object
 */</span>
Casper.prototype.getFormValues = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">selector</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.exists(selector)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(f(<span class="hljs-string">'Form matching selector "%s" not found'</span>, selector));
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"getFormValues"</span>, selector);
};

<span class="hljs-comment">/**
 * Retrieves global variable.
 *
 * @param  String  name  The name of the global variable to retrieve
 * @return mixed
 */</span>
Casper.prototype.getGlobal = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getGlobal</span>(<span class="hljs-params">name</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_evaluate</span>(<span class="hljs-params">name</span>) </span>{
        <span class="hljs-keyword">var</span> result = {};
        <span class="hljs-keyword">try</span> {
            result.value = <span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-built_in">window</span>[name]);
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-keyword">var</span> message = <span class="hljs-string">"Unable to JSON encode window."</span> + name + <span class="hljs-string">": "</span> + e;
            __utils__.log(message, <span class="hljs-string">"error"</span>);
            result.error = message;
        }
        <span class="hljs-keyword">return</span> result;
    }, name);
    <span class="hljs-keyword">if</span> (!utils.isObject(result)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(f(<span class="hljs-string">'Could not retrieve global value for "%s"'</span>, name));
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'error'</span> <span class="hljs-keyword">in</span> result) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(result.error);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (utils.isString(result.value)) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(result.value);
    }
};

<span class="hljs-comment">/**
 * Retrieves current HTML code matching the provided CSS3/XPath selector.
 * Returns the HTML contents for the whole page if no arg is passed.
 *
 * @param  String   selector  A DOM CSS3/XPath selector
 * @param  Boolean  outer     Whether to fetch outer HTML contents (default: false)
 * @return String
 */</span>
Casper.prototype.getHTML = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getHTML</span>(<span class="hljs-params">selector, outer</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (!selector) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.page.frameContent;
    }
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.exists(selector)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"No element matching selector found: "</span> + selector);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSelectorHTML</span>(<span class="hljs-params">selector, outer</span>) </span>{
        <span class="hljs-keyword">var</span> element = __utils__.findOne(selector);
        <span class="hljs-keyword">return</span> outer ? element.outerHTML : element.innerHTML;
    }, selector, !!outer);
};

<span class="hljs-comment">/**
 * Retrieves current page title, if any.
 *
 * @return String
 */</span>
Casper.prototype.getTitle = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTitle</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_evaluate</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.title;
    });
};

<span class="hljs-comment">/**
 * Handles received HTTP resource.
 *
 * @param  Object  resource  PhantomJS HTTP resource
 */</span>
Casper.prototype.handleReceivedResource = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resource</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-comment">/*eslint max-statements:0*/</span>
    <span class="hljs-keyword">if</span> (resource.stage !== <span class="hljs-string">"end"</span>) {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">this</span>.resources.push(resource);

    <span class="hljs-keyword">var</span> checkUrl = ((phantom.casperEngine === <span class="hljs-string">'phantomjs'</span> &amp;&amp; utils.ltVersion(phantom.version, <span class="hljs-string">'2.1.0'</span>)) ||
                   (phantom.casperEngine === <span class="hljs-string">'slimerjs'</span> &amp;&amp; utils.ltVersion(slimer.version, <span class="hljs-string">'0.10.0'</span>))) ? utils.decodeUrl(resource.url) : resource.url;
    <span class="hljs-keyword">if</span> (checkUrl !== <span class="hljs-keyword">this</span>.requestUrl) {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">this</span>.currentHTTPStatus = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.currentResponse = {};
    <span class="hljs-keyword">if</span> (utils.isHTTPResource(resource)) {
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'page.resource.received'</span>, resource);
        <span class="hljs-keyword">this</span>.currentResponse = resource;
        <span class="hljs-keyword">this</span>.currentHTTPStatus = resource.status;
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'http.status.'</span> + resource.status, resource);
        <span class="hljs-keyword">if</span> (utils.isObject(<span class="hljs-keyword">this</span>.options.httpStatusHandlers) &amp;&amp;
            resource.status <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.options.httpStatusHandlers &amp;&amp;
            utils.isFunction(<span class="hljs-keyword">this</span>.options.httpStatusHandlers[resource.status])) {
            <span class="hljs-keyword">this</span>.options.httpStatusHandlers[resource.status].call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>, resource);
        }
    }
    <span class="hljs-keyword">this</span>.currentUrl = resource.url;
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'location.changed'</span>, resource.url);
};

<span class="hljs-comment">/**
 * Initializes PhantomJS error handler.
 *
 */</span>
Casper.prototype.initErrorHandler = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initErrorHandler</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">var</span> casper = <span class="hljs-keyword">this</span>;
    phantom.onError = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">phantom_onError</span>(<span class="hljs-params">msg, backtrace</span>) </span>{
        casper.emit(<span class="hljs-string">'error'</span>, msg, backtrace);
        <span class="hljs-keyword">if</span> (casper.options.exitOnError === <span class="hljs-literal">true</span>) {
            casper.exit(<span class="hljs-number">1</span>);
        }
    };
};

<span class="hljs-comment">/**
 * Injects configured local client scripts.
 *
 * @return Casper
 */</span>
Casper.prototype.injectClientScripts = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">injectClientScripts</span>(<span class="hljs-params">page</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.options.clientScripts) {
        <span class="hljs-keyword">return</span>;
    }
    page = page || <span class="hljs-keyword">this</span>.page;
    <span class="hljs-keyword">if</span> (utils.isString(<span class="hljs-keyword">this</span>.options.clientScripts)) {
        <span class="hljs-keyword">this</span>.options.clientScripts = [<span class="hljs-keyword">this</span>.options.clientScripts];
    }
    <span class="hljs-keyword">if</span> (!utils.isArray(<span class="hljs-keyword">this</span>.options.clientScripts)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"The clientScripts option must be an array"</span>);
    }
    <span class="hljs-keyword">this</span>.options.clientScripts.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_forEach</span>(<span class="hljs-params">script</span>) </span>{
        <span class="hljs-keyword">if</span> (page.injectJs(script)) {
            <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">'Automatically injected %s client side'</span>, script), <span class="hljs-string">"debug"</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.warn(f(<span class="hljs-string">'Failed injecting %s client side'</span>, script));
        }
    }.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Injects Client-side utilities in current page context.
 *
 */</span>
Casper.prototype.injectClientUtils = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">injectClientUtils</span>(<span class="hljs-params">page</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    page = page || <span class="hljs-keyword">this</span>.page;
    <span class="hljs-keyword">var</span> clientUtilsInjected = page.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> __utils__ === <span class="hljs-string">"object"</span>;
    });
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span> === clientUtilsInjected) {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> clientUtilsPath = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>).pathJoin(phantom.casperPath, <span class="hljs-string">'modules'</span>, <span class="hljs-string">'clientutils.js'</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span> === page.injectJs(clientUtilsPath)) {
        <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"Successfully injected Casper client-side utilities"</span>, <span class="hljs-string">"debug"</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.warn(<span class="hljs-string">"Failed to inject Casper client-side utilities"</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>ClientUtils and Casper shares the same options
These are not the lines I’m the most proud of in my life, but it works.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-comment">/*global __options*/</span>
    page.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-built_in">window</span>.__utils__ = <span class="hljs-keyword">new</span> <span class="hljs-built_in">window</span>.ClientUtils(__options);
    }.toString().replace(<span class="hljs-string">'__options'</span>, <span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-keyword">this</span>.options)));
};

<span class="hljs-comment">/**
 * Loads and include remote client scripts to current page.
 *
 * @return Casper
 */</span>
Casper.prototype.includeRemoteScripts = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">includeRemoteScripts</span>(<span class="hljs-params">page</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">var</span> numScripts = <span class="hljs-keyword">this</span>.options.remoteScripts.length, loaded = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (numScripts === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }
    <span class="hljs-keyword">this</span>.waitStart();
    page = page || <span class="hljs-keyword">this</span>.page;
    <span class="hljs-keyword">this</span>.options.remoteScripts.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scriptUrl</span>) </span>{
        <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Loading remote script: %s"</span>, scriptUrl), <span class="hljs-string">"debug"</span>);
        page.includeJs(scriptUrl, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            loaded++;
            <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Remote script %s loaded"</span>, scriptUrl), <span class="hljs-string">"debug"</span>);
            <span class="hljs-keyword">if</span> (loaded === numScripts) {
                <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"All remote scripts loaded."</span>, <span class="hljs-string">"debug"</span>);
                <span class="hljs-keyword">this</span>.waitDone();
            }
        }.bind(<span class="hljs-keyword">this</span>));
    }.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Logs a message.
 *
 * @param  String  message  The message to log
 * @param  String  level    The log message level (from Casper.logLevels property)
 * @param  String  space    Space from where the logged event occurred (default: "phantom")
 * @return Casper
 */</span>
Casper.prototype.log = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params">message, level, space</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    level = level &amp;&amp; <span class="hljs-keyword">this</span>.logLevels.indexOf(level) &gt; <span class="hljs-number">-1</span> ? level : <span class="hljs-string">"debug"</span>;
    space = space ? space : <span class="hljs-string">"phantom"</span>;
    <span class="hljs-keyword">if</span> (level === <span class="hljs-string">"error"</span> &amp;&amp; utils.isFunction(<span class="hljs-keyword">this</span>.options.onError)) {
        <span class="hljs-keyword">this</span>.options.onError.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>, message, space);
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.logLevels.indexOf(level) &lt; <span class="hljs-keyword">this</span>.logLevels.indexOf(<span class="hljs-keyword">this</span>.options.logLevel)) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>; <span class="hljs-comment">// skip logging</span>
    }
    <span class="hljs-keyword">var</span> entry = {
        <span class="hljs-attr">level</span>:   level,
        <span class="hljs-attr">space</span>:   space,
        <span class="hljs-attr">message</span>: message,
        <span class="hljs-attr">date</span>:    <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toString()
    };
    <span class="hljs-keyword">if</span> (level <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.logFormats &amp;&amp; utils.isFunction(<span class="hljs-keyword">this</span>.logFormats[level])) {
        message = <span class="hljs-keyword">this</span>.logFormats[level](message, level, space);
    } <span class="hljs-keyword">else</span> {
        message = f(<span class="hljs-string">'%s [%s] %s'</span>,
                    <span class="hljs-keyword">this</span>.colorizer.colorize(f(<span class="hljs-string">'[%s]'</span>, level), <span class="hljs-keyword">this</span>.logStyles[level]),
                    space,
                    message);
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.options.verbose) {
        <span class="hljs-keyword">this</span>.echo(<span class="hljs-keyword">this</span>.filter(<span class="hljs-string">'log.message'</span>, message) || message); <span class="hljs-comment">// direct output</span>
    }
    <span class="hljs-keyword">this</span>.result.log.push(entry);
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'log'</span>, entry);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Emulates an event on the element from the provided selector using the mouse
 * pointer, if possible.
 *
 * In case of success, `true` is returned, `false` otherwise.
 *
 * @param  String   type      Type of event to emulate
 * @param  String   selector  A DOM CSS3 compatible selector
 * @param  {Number} x X position
 * @param  {Number} y Y position
 * @return Boolean
 */</span>
Casper.prototype.mouseEvent = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mouseEvent</span>(<span class="hljs-params">type, selector, x, y</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"Mouse event '"</span> + type + <span class="hljs-string">"' on selector: "</span> + selector, <span class="hljs-string">"debug"</span>);
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.exists(selector)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(f(<span class="hljs-string">"Cannot dispatch %s event on nonexistent selector: %s"</span>, type, selector));
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"mouseEvent"</span>, type, selector, x, y)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>fallback onto native QtWebKit mouse events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.mouse.processEvent(type, selector, x, y);
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Couldn't emulate '%s' event on %s: %s"</span>, type, selector, e), <span class="hljs-string">"error"</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

<span class="hljs-comment">/**
 * Performs an HTTP request, with optional settings.
 *
 * Available settings are:
 *
 * - String  method:   The HTTP method to use
 * - Object  data:     The data to use to perform the request, eg. {foo: 'bar'}
 * - Object  headers:  Custom request headers object, eg. {'Cache-Control': 'max-age=0'}
 *
 * @param  String  location  The url to open
 * @param  Object  settings  The request settings (optional)
 * @return Casper
 */</span>
Casper.prototype.open = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">open</span>(<span class="hljs-params">location, settings</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-comment">/*eslint max-statements:0*/</span>
    <span class="hljs-keyword">var</span> baseCustomHeaders = <span class="hljs-keyword">this</span>.page.customHeaders,
        customHeaders = settings &amp;&amp; settings.headers || {};
    <span class="hljs-keyword">this</span>.checkStarted();
    settings = utils.isObject(settings) ? settings : {};
    settings.method = settings.method || <span class="hljs-string">"get"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>http method
taken from <a href="https://github.com/ariya/phantomjs/blob/master/src/webpage.cpp#L302">https://github.com/ariya/phantomjs/blob/master/src/webpage.cpp#L302</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> methods = [<span class="hljs-string">"get"</span>, <span class="hljs-string">"head"</span>, <span class="hljs-string">"put"</span>, <span class="hljs-string">"post"</span>, <span class="hljs-string">"delete"</span>];
    <span class="hljs-keyword">if</span> (settings.method &amp;&amp; (!utils.isString(settings.method) || methods.indexOf(settings.method.toLowerCase()) === <span class="hljs-number">-1</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"open(): settings.method must be part of "</span> + methods.join(<span class="hljs-string">', '</span>));
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>http data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (settings.data) {
        <span class="hljs-keyword">if</span> (utils.isObject(settings.data)) { <span class="hljs-comment">// query object</span>
            <span class="hljs-keyword">if</span> (settings.headers &amp;&amp; settings.headers[<span class="hljs-string">"Content-Type"</span>] &amp;&amp; settings.headers[<span class="hljs-string">"Content-Type"</span>].match(<span class="hljs-regexp">/application\/json/</span>)) {
                settings.data = <span class="hljs-built_in">JSON</span>.stringify(settings.data); <span class="hljs-comment">// convert object to JSON notation</span>
            } <span class="hljs-keyword">else</span> {
                settings.data = qs.encode(settings.data); <span class="hljs-comment">// escapes all characters except alphabetic, decimal digits and ,-_.!~*'()</span>
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!utils.isString(settings.data)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"open(): invalid request settings data value: "</span> + settings.data);
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>clean location</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    location = utils.cleanUrl(location);</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>current request url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.configureHttpAuth(location, settings);
    <span class="hljs-keyword">this</span>.requestUrl = <span class="hljs-keyword">this</span>.filter(<span class="hljs-string">'open.location'</span>, location) || location;

    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'open'</span>, <span class="hljs-keyword">this</span>.requestUrl, settings);
    <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">'opening url: %s, HTTP %s'</span>, <span class="hljs-keyword">this</span>.requestUrl, settings.method.toUpperCase()), <span class="hljs-string">"debug"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>reset resources</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.resources = [];
    <span class="hljs-keyword">this</span>.resourcesTime = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>custom headers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.page.customHeaders = utils.mergeObjects(utils.clone(baseCustomHeaders), customHeaders);</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>perfom request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.page.browserInitializing = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> phantomJsSettings = {
        <span class="hljs-attr">operation</span>: settings.method,
        <span class="hljs-attr">data</span>:      settings.data
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>override any default encoding setting in phantomjs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-string">'encoding'</span> <span class="hljs-keyword">in</span> settings) {
        phantomJsSettings.encoding = settings.encoding;
    }

    <span class="hljs-keyword">this</span>.page.openUrl(<span class="hljs-keyword">this</span>.requestUrl, phantomJsSettings, <span class="hljs-keyword">this</span>.page.settings);</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>revert base custom headers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.page.customHeaders = baseCustomHeaders;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Reloads current page.
 *
 * @param  Function  then  a next step function
 * @return Casper
 */</span>
Casper.prototype.reload = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reload</span>(<span class="hljs-params">then</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.page.reload();
    });
    <span class="hljs-keyword">if</span> (utils.isFunction(then)) {
        <span class="hljs-keyword">this</span>.then(<span class="hljs-keyword">this</span>.createStep(then));
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Repeats a step a given number of times.
 *
 * @param  Number    times  Number of times to repeat step
 * @aram   function  then   The step closure
 * @return Casper
 * @see    Casper#then
 */</span>
Casper.prototype.repeat = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">repeat</span>(<span class="hljs-params">times, then</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; times; i++) {
        <span class="hljs-keyword">this</span>.then(then);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Checks if a given resource was loaded by the remote page.
 *
 * @param  Function/String/RegExp  test  A test function, string or regular expression.
 *                                       In case a string is passed, url matching will be tested.
 * @return Boolean
 */</span>
Casper.prototype.resourceExists = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resourceExists</span>(<span class="hljs-params">test</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">var</span> testFn;
    <span class="hljs-keyword">switch</span> (utils.betterTypeOf(test)) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"string"</span>:
            testFn = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_testResourceExists_String</span>(<span class="hljs-params">res</span>) </span>{
                <span class="hljs-keyword">return</span> res.url.indexOf(test) !== <span class="hljs-number">-1</span> &amp;&amp; res.status !== <span class="hljs-number">404</span>;
            };
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">"regexp"</span>:
            testFn = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_testResourceExists_Regexp</span>(<span class="hljs-params">res</span>) </span>{
                <span class="hljs-keyword">return</span> test.test(res.url) &amp;&amp; res.status !== <span class="hljs-number">404</span>;
            };
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">"function"</span>:
            testFn = test;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"Invalid type"</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.resources.some(testFn);
};

<span class="hljs-comment">/**
 * Runs the whole suite of steps.
 *
 * @param  function  onComplete  an optional callback
 * @param  Number    time        an optional amount of milliseconds for interval checking
 * @return Casper
 */</span>
Casper.prototype.run = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">onComplete, time</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.steps || <span class="hljs-keyword">this</span>.steps.length &lt; <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">'No steps defined, aborting'</span>);
    }
    <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Running suite: %d step%s"</span>, <span class="hljs-keyword">this</span>.steps.length, <span class="hljs-keyword">this</span>.steps.length &gt; <span class="hljs-number">1</span> ? <span class="hljs-string">"s"</span> : <span class="hljs-string">""</span>), <span class="hljs-string">"info"</span>);
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'run.start'</span>);
    <span class="hljs-keyword">this</span>.checker = setInterval(<span class="hljs-keyword">this</span>.checkStep, (time ? time: <span class="hljs-keyword">this</span>.options.retryTimeout), <span class="hljs-keyword">this</span>, onComplete);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Runs a step.
 *
 * @param  Function  step
 */</span>
Casper.prototype.runStep = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runStep</span>(<span class="hljs-params">step</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-comment">/*eslint max-statements:0*/</span>
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">var</span> skipLog = !!step.options &amp;&amp; utils.isObject(step.options) &amp;&amp; step.options.skipLog === <span class="hljs-literal">true</span>,
        stepInfo = f(<span class="hljs-string">"Step %s %d/%d"</span>, step.name || <span class="hljs-string">"anonymous"</span>, <span class="hljs-keyword">this</span>.step, <span class="hljs-keyword">this</span>.steps.length),
        stepResult;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCurrentSuiteId</span>(<span class="hljs-params">casper</span>) </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> casper.test.getCurrentSuiteId();
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-keyword">return</span> casper.step;
        }
    }
    <span class="hljs-keyword">if</span> (!skipLog &amp;&amp; <span class="hljs-regexp">/^http/</span>.test(<span class="hljs-keyword">this</span>.getCurrentUrl())) {
        <span class="hljs-keyword">this</span>.log(stepInfo + f(<span class="hljs-string">' %s (HTTP %d)'</span>, <span class="hljs-keyword">this</span>.getCurrentUrl(), <span class="hljs-keyword">this</span>.currentHTTPStatus), <span class="hljs-string">"info"</span>);
    }
    <span class="hljs-keyword">if</span> (utils.isNumber(<span class="hljs-keyword">this</span>.options.stepTimeout) &amp;&amp; <span class="hljs-keyword">this</span>.options.stepTimeout &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">var</span> stepTimeoutCheckInterval = setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_check</span>(<span class="hljs-params">self, start, stepNum</span>) </span>{
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - start &gt; self.options.stepTimeout) {
                <span class="hljs-keyword">if</span> (getCurrentSuiteId(self) === stepNum) {
                    self.emit(<span class="hljs-string">'step.timeout'</span>, stepNum, self.options.onStepTimeout);
                    <span class="hljs-keyword">if</span> (utils.isFunction(self.options.onStepTimeout)) {
                        self.options.onStepTimeout.call(self, self.options.stepTimeout, stepNum);
                    }
                }
                clearInterval(stepTimeoutCheckInterval);
            }
        }, <span class="hljs-keyword">this</span>.options.stepTimeout, <span class="hljs-keyword">this</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(), getCurrentSuiteId(<span class="hljs-keyword">this</span>));
    }
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'step.start'</span>, step);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.currentResponse) {
        <span class="hljs-keyword">if</span> (step.options &amp;&amp; (<span class="hljs-keyword">typeof</span> step.options.data !== <span class="hljs-string">'undefined'</span>)) {
            <span class="hljs-keyword">this</span>.currentResponse.data = step.options.data;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.currentResponse.data = <span class="hljs-literal">null</span>;
        }
    }
    <span class="hljs-keyword">try</span> {
        stepResult = step.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.currentResponse);
        <span class="hljs-keyword">if</span> (utils.isFunction(<span class="hljs-keyword">this</span>.options.onStepComplete)) {
            <span class="hljs-keyword">this</span>.options.onStepComplete.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>, stepResult);
        }
    } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'step.error'</span>, err);
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.options.silentErrors) {
            <span class="hljs-keyword">throw</span> err;
        }
    }
    <span class="hljs-keyword">if</span> (!skipLog) {
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'step.complete'</span>, stepResult);
        <span class="hljs-keyword">this</span>.log(stepInfo + f(<span class="hljs-string">": done in %dms."</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - <span class="hljs-keyword">this</span>.startTime), <span class="hljs-string">"info"</span>);
    }
};

<span class="hljs-comment">/**
 * Sends keys to given element.
 *
 * Options:
 *
 * - eventType: "keypress", "keyup" or "keydown" (default: "keypress")
 * - modifiers: a string defining the key modifiers, eg. "alt", "alt+shift"
 *
 * @param  String  selector  A DOM CSS3 compatible selector
 * @param  String  keys      A string representing the sequence of char codes to send
 * @param  Object  options   Options
 * @return Casper
 */</span>
Casper.prototype.sendKeys = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">selector, keys, options</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    options = utils.mergeObjects({
        <span class="hljs-attr">eventType</span>: <span class="hljs-string">'keypress'</span>,
        <span class="hljs-attr">reset</span>: <span class="hljs-literal">false</span>
    }, options || {});
    <span class="hljs-keyword">var</span> elemInfos = <span class="hljs-keyword">this</span>.getElementInfo(selector),
        tag = elemInfos.nodeName.toLowerCase(),
        type = utils.getPropertyPath(elemInfos, <span class="hljs-string">'attributes.type'</span>),
        supported = [<span class="hljs-string">"color"</span>, <span class="hljs-string">"date"</span>, <span class="hljs-string">"datetime"</span>, <span class="hljs-string">"datetime-local"</span>, <span class="hljs-string">"email"</span>,
                     <span class="hljs-string">"hidden"</span>, <span class="hljs-string">"month"</span>, <span class="hljs-string">"number"</span>, <span class="hljs-string">"password"</span>, <span class="hljs-string">"range"</span>, <span class="hljs-string">"search"</span>,
                     <span class="hljs-string">"tel"</span>, <span class="hljs-string">"text"</span>, <span class="hljs-string">"time"</span>, <span class="hljs-string">"url"</span>, <span class="hljs-string">"week"</span>],
        isTextInput = <span class="hljs-literal">false</span>,
        isTextArea = tag === <span class="hljs-string">'textarea'</span>,
        isValidInput = tag === <span class="hljs-string">'input'</span> &amp;&amp; (<span class="hljs-keyword">typeof</span> type === <span class="hljs-string">'undefined'</span> || supported.indexOf(type) !== <span class="hljs-number">-1</span>),
        isContentEditable = !!elemInfos.attributes.contenteditable;

    <span class="hljs-keyword">if</span> (isTextArea || isValidInput || isContentEditable) {</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>clicking on the input element brings it focus</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        isTextInput = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.click(selector);
    }
    <span class="hljs-keyword">if</span> (options.reset) {
        <span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">selector</span>) </span>{
            __utils__.setField(__utils__.findOne(selector), <span class="hljs-string">''</span>);
        }, selector);
        <span class="hljs-keyword">this</span>.click(selector);
    }
    <span class="hljs-keyword">var</span> modifiers = utils.computeModifier(options &amp;&amp; options.modifiers || <span class="hljs-literal">null</span>,
                                          <span class="hljs-keyword">this</span>.page.event.modifier);
    <span class="hljs-keyword">this</span>.page.sendEvent(options.eventType, keys, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, modifiers);
    <span class="hljs-keyword">if</span> (isTextInput &amp;&amp; !options.keepFocus) {</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>remove the focus</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">selector</span>) </span>{
            __utils__.findOne(selector).blur();
        }, selector);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Scrolls current document to x, y coordinates.
 *
 * @param  {Number} x X position
 * @param  {Number} y Y position
 * @return {Casper}
 */</span>
Casper.prototype.scrollTo = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x, y</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"scrollTo"</span>, x, y);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Scrolls current document up to its bottom.
 *
 * @return {Casper}
 */</span>
Casper.prototype.scrollToBottom = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scrollToBottom</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"scrollToBottom"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Sets current page content.
 *
 * @param  String  content  Desired page content
 * @return Casper
 */</span>
Casper.prototype.setContent = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setContent</span>(<span class="hljs-params">content</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">this</span>.page.content = content;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};


<span class="hljs-comment">/**
 * Sets a value to form field by CSS3, XPath selector or by its name attribute or label text.
 *
 * @param String|Object selector    CSS3, XPath, name or label
 * @param Mixed         value       Value being set
 * @param String|Object form        (optional) CSS3 or XPath selector of form
 * @param Object        options     Options to setFieldValue, it accepts:
 *                                  - options.selectorType name|labes|xpath|css3 - type of selector, where
 *                                    CSS3 and XPath(object) is autodetected (need not be set)
 */</span>
Casper.prototype.setFieldValue = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setFieldValue</span>(<span class="hljs-params">selector, value, form, options</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();

    <span class="hljs-keyword">var</span> selectorType = options &amp;&amp; options.selectorType;
    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">this</span>.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_evaluate</span>(<span class="hljs-params">selector, value, form, selectorType</span>) </span>{
        <span class="hljs-keyword">if</span> (selectorType) {
            selector = __utils__.makeSelector(selector, selectorType);
        }
        <span class="hljs-keyword">var</span> info = __utils__.getElementInfo(selector);
        <span class="hljs-keyword">if</span> (!!info &amp;&amp; info.nodeName === <span class="hljs-string">'input'</span> &amp;&amp; info.attributes.type === <span class="hljs-string">'file'</span>) {
            <span class="hljs-keyword">return</span> __utils__.getCssSelector(selector);
        }
        <span class="hljs-keyword">return</span> __utils__.setFieldValue(selector, value, form);
    }, selector, value, form, selectorType);

    <span class="hljs-keyword">if</span> (!result) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"Unable to set field '"</span> + selector + <span class="hljs-string">" to value: "</span> + value) +
            <span class="hljs-string">' in setFieldValue().'</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> result === <span class="hljs-string">"string"</span>) {
        <span class="hljs-keyword">if</span> (!value || !fs.exists(value)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">'Cannot upload nonexistent file: '</span> + value);
        }
        <span class="hljs-keyword">this</span>.page.uploadFile(result, value);
    }
};

<span class="hljs-comment">/**
 * Alias to setFieldValue() with implicit type name
 *
 * @param String        name    Name of form field
 * @param Mixed         value   Value being set
 * @param String|Object form    (optional) CSS3 or XPath selector of form
 */</span>
Casper.prototype.setFieldValueName = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setFieldValueName</span>(<span class="hljs-params">name, value, form</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">this</span>.setFieldValue(name, value, form, {<span class="hljs-string">'selectorType'</span>: <span class="hljs-string">'name'</span>});
};

<span class="hljs-comment">/**
 * Alias to setFieldValue() with implicit type label
 *
 * @param String        name    Name of form field
 * @param Mixed         value   Value being set
 * @param String|Object form    (optional) CSS3 or XPath selector of form
 */</span>
Casper.prototype.setFieldValueLabel = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setFieldValueLabel</span>(<span class="hljs-params">label, value, form</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">this</span>.setFieldValue(label, value, form, {<span class="hljs-string">'selectorType'</span>: <span class="hljs-string">'label'</span>});
};

<span class="hljs-comment">/**
 * Sets current WebPage instance the credentials for HTTP authentication.
 *
 * @param  String  username
 * @param  String  password
 * @return Casper
 */</span>
Casper.prototype.setHttpAuth = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setHttpAuth</span>(<span class="hljs-params">username, password</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">this</span>.page.settings.userName = username;
    <span class="hljs-keyword">this</span>.page.settings.password = password;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Configures and starts Casper.
 *
 * @param  String   location  An optional location to open on start
 * @param  function then      Next step function to execute on page loaded (optional)
 * @return Casper
 */</span>
Casper.prototype.start = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">start</span>(<span class="hljs-params">location, then</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-comment">/*eslint max-statements:0*/</span>
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'starting'</span>);
    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">'Starting...'</span>, <span class="hljs-string">"info"</span>);
    <span class="hljs-keyword">this</span>.startTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
    <span class="hljs-keyword">this</span>.currentResponse = {};
    <span class="hljs-keyword">this</span>.history = [];
    <span class="hljs-keyword">this</span>.popups = pagestack.create();
    <span class="hljs-keyword">this</span>.steps = [];
    <span class="hljs-keyword">this</span>.step = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Option checks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.logLevels.indexOf(<span class="hljs-keyword">this</span>.options.logLevel) &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Unknown log level '%d', defaulting to 'warning'"</span>, <span class="hljs-keyword">this</span>.options.logLevel), <span class="hljs-string">"warning"</span>);
        <span class="hljs-keyword">this</span>.options.logLevel = <span class="hljs-string">"warning"</span>;
    }
    <span class="hljs-keyword">if</span> (!utils.isWebPage(<span class="hljs-keyword">this</span>.page)) {
        <span class="hljs-keyword">this</span>.page = <span class="hljs-keyword">this</span>.mainPage = utils.isWebPage(<span class="hljs-keyword">this</span>.options.page) ? <span class="hljs-keyword">this</span>.options.page : createPage(<span class="hljs-keyword">this</span>);
    }
    <span class="hljs-keyword">this</span>.page.settings = utils.mergeObjects(<span class="hljs-keyword">this</span>.page.settings, <span class="hljs-keyword">this</span>.options.pageSettings);
    <span class="hljs-keyword">if</span> (utils.isClipRect(<span class="hljs-keyword">this</span>.options.clipRect)) {
        <span class="hljs-keyword">this</span>.page.clipRect = <span class="hljs-keyword">this</span>.options.clipRect;
    }
    <span class="hljs-keyword">if</span> (utils.isObject(<span class="hljs-keyword">this</span>.options.viewportSize)) {
        <span class="hljs-keyword">this</span>.page.viewportSize = <span class="hljs-keyword">this</span>.options.viewportSize;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>timeout handling</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (utils.isNumber(<span class="hljs-keyword">this</span>.options.timeout) &amp;&amp; <span class="hljs-keyword">this</span>.options.timeout &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"Execution timeout set to %dms"</span>, <span class="hljs-keyword">this</span>.options.timeout), <span class="hljs-string">"info"</span>);
        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_check</span>(<span class="hljs-params">self</span>) </span>{
            self.emit(<span class="hljs-string">'timeout'</span>);
            <span class="hljs-keyword">if</span> (utils.isFunction(self.options.onTimeout)) {
                self.options.onTimeout.call(self, self.options.timeout);
            }
        }, <span class="hljs-keyword">this</span>.options.timeout, <span class="hljs-keyword">this</span>);
    }
    <span class="hljs-keyword">this</span>.started = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'started'</span>);
    <span class="hljs-keyword">if</span> (utils.isString(location) &amp;&amp; location.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.thenOpen(location, utils.isFunction(then) ? then : <span class="hljs-keyword">this</span>.createStep(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_step</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"start page is loaded"</span>, <span class="hljs-string">"debug"</span>);
        }, {<span class="hljs-attr">skipLog</span>: <span class="hljs-literal">true</span>}));
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Returns the current status of current instance
 *
 * @param  Boolean  asString  Export status object as string
 * @return Object
 */</span>
Casper.prototype.status = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">status</span>(<span class="hljs-params">asString</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">var</span> properties = [<span class="hljs-string">'currentHTTPStatus'</span>, <span class="hljs-string">'loadInProgress'</span>, <span class="hljs-string">'navigationRequested'</span>,
                      <span class="hljs-string">'options'</span>, <span class="hljs-string">'pendingWait'</span>, <span class="hljs-string">'requestUrl'</span>, <span class="hljs-string">'started'</span>, <span class="hljs-string">'step'</span>, <span class="hljs-string">'url'</span>];
    <span class="hljs-keyword">var</span> currentStatus = {};
    properties.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">property</span>) </span>{
        currentStatus[property] = <span class="hljs-keyword">this</span>[property] || <span class="hljs-keyword">this</span>.page[property];
    }.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">return</span> asString === <span class="hljs-literal">true</span> ? utils.dump(currentStatus) : currentStatus;
};

<span class="hljs-comment">/**
 * Schedules the next step in the navigation process.
 *
 * @param  function  step  A function to be called as a step
 * @return Casper
 */</span>
Casper.prototype.then = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">then</span>(<span class="hljs-params">step</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (!utils.isFunction(step)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"You can only define a step as a function"</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>check if casper is running</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.checker === <span class="hljs-literal">null</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>append step to the end of the queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        step.level = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.steps.push(step);
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>insert substep a level deeper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">try</span> {
            step.level = <span class="hljs-keyword">this</span>.steps[<span class="hljs-keyword">this</span>.step - <span class="hljs-number">1</span>].level + <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">catch</span> (e) {
            step.level = <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">var</span> insertIndex = <span class="hljs-keyword">this</span>.step;
        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.steps[insertIndex] &amp;&amp; step.level === <span class="hljs-keyword">this</span>.steps[insertIndex].level) {
            insertIndex++;
        }
        <span class="hljs-keyword">this</span>.steps.splice(insertIndex, <span class="hljs-number">0</span>, step);
    }
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'step.added'</span>, step);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Adds a new navigation step for clicking on a provided link selector
 * and execute an optional next step.
 *
 * @param  String   selector        A DOM CSS3 compatible selector
 * @param  Function then            Next step function to execute on page loaded (optional)
 * @return Casper
 * @see    Casper#click
 * @see    Casper#then
 */</span>
Casper.prototype.thenClick = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">thenClick</span>(<span class="hljs-params">selector, then</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_step</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.click(selector);
    });
    <span class="hljs-keyword">return</span> utils.isFunction(then) ? <span class="hljs-keyword">this</span>.then(then) : <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Adds a new navigation step to perform code evaluation within the
 * current retrieved page DOM.
 *
 * @param  function  fn       The function to be evaluated within current page DOM
 * @param  Array     args...  The rest of arguments passed to fn
 * @return Casper
 * @see    Casper#evaluate
 */</span>
Casper.prototype.thenEvaluate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">thenEvaluate</span>(<span class="hljs-params">fn</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_step</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.evaluate.apply(<span class="hljs-keyword">this</span>, args);
    });
};

<span class="hljs-comment">/**
 * Adds a new navigation step for opening the provided location.
 *
 * @param  String   location  The URL to load
 * @param  function then      Next step function to execute on page loaded (optional)
 * @return Casper
 * @see    Casper#open
 */</span>
Casper.prototype.thenOpen = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">thenOpen</span>(<span class="hljs-params">location, settings, then</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (!(settings &amp;&amp; !utils.isFunction(settings))) {
      then = settings;
      settings = <span class="hljs-literal">null</span>;
    }
    <span class="hljs-keyword">this</span>.then(<span class="hljs-keyword">this</span>.createStep(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_step</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.open(location, settings);
    }, {
        <span class="hljs-attr">skipLog</span>: <span class="hljs-literal">true</span>
    }));
    <span class="hljs-keyword">return</span> utils.isFunction(then) ? <span class="hljs-keyword">this</span>.then(then) : <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Adds a step which bypasses `nb` steps.
 *
 * @param  Integer  nb  Number of steps to bypass
 */</span>
Casper.prototype.thenBypass = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">thenBypass</span>(<span class="hljs-params">nb</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_thenBypass</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.bypass(nb);
    });
};

<span class="hljs-comment">/**
 * Bypass `nb` steps if condition is true.
 *
 * @param  Mixed    condition  Test condition
 * @param  Integer  nb         Number of steps to bypass
 */</span>
Casper.prototype.thenBypassIf = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">thenBypassIf</span>(<span class="hljs-params">condition, nb</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_thenBypassIf</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (utils.isFunction(condition)) {
            condition = condition.call(<span class="hljs-keyword">this</span>);
        }
        <span class="hljs-keyword">if</span> (utils.isTruthy(condition)) {
            <span class="hljs-keyword">this</span>.bypass(nb);
        }
    });
};

<span class="hljs-comment">/**
 * Bypass `nb` steps if condition is false.
 *
 * @param Mixed    condition  Test condition
 * @param Integer  nb         Number of tests to bypass
 */</span>
Casper.prototype.thenBypassUnless = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">thenBypassUnless</span>(<span class="hljs-params">condition, nb</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_thenBypassUnless</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (utils.isFunction(condition)) {
            condition = condition.call(<span class="hljs-keyword">this</span>);
        }
        <span class="hljs-keyword">if</span> (utils.isFalsy(condition)) {
            <span class="hljs-keyword">this</span>.bypass(nb);
        }
    });
};

<span class="hljs-comment">/**
 * Adds a new navigation step for opening and evaluate an expression
 * against the DOM retrieved from the provided location.
 *
 * @param  String    location  The url to open
 * @param  function  fn        The function to be evaluated within current page DOM
 * @param  Array     args...   The rest of arguments will passed to the evaluate function
 * @return Casper
 * @see    Casper#evaluate
 * @see    Casper#open
 */</span>
Casper.prototype.thenOpenAndEvaluate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">thenOpenAndEvaluate</span>(<span class="hljs-params">location, fn</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.thenOpen(location).thenEvaluate.apply(<span class="hljs-keyword">this</span>, args);
};

<span class="hljs-comment">/**
 * Returns a string representation of current instance
 *
 * @return String
 */</span>
Casper.prototype.toString = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toString</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'[object Casper], currently at '</span> + <span class="hljs-keyword">this</span>.getCurrentUrl();
};

<span class="hljs-comment">/**
 * Clear all wait processes.
 *
 * @return Casper
 */</span>
Casper.prototype.unwait = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unwait</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.waiters.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">interval</span>) </span>{
        <span class="hljs-keyword">if</span> (interval) {
            clearInterval(interval);
        }
    });
    <span class="hljs-keyword">this</span>.waiters = [];
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Sets the user-agent string currently used when requesting urls.
 *
 * @param  String  userAgent  User agent string
 * @return String
 */</span>
Casper.prototype.userAgent = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">userAgent</span>(<span class="hljs-params">agent</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.options.pageSettings.userAgent = agent;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.started &amp;&amp; <span class="hljs-keyword">this</span>.page) {
        <span class="hljs-keyword">this</span>.page.settings.userAgent = agent;
        <span class="hljs-keyword">this</span>.page.customHeaders = {<span class="hljs-string">"User-Agent"</span>: agent};
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Changes the current viewport size. That operation is asynchronous as the page
 * has to reflow its contents accordingly.
 *
 * @param  Number    width   The viewport width, in pixels
 * @param  Number    height  The viewport height, in pixels
 * @param  Function  then    Next step to process (optional)
 * @return Casper
 */</span>
Casper.prototype.viewport = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">viewport</span>(<span class="hljs-params">width, height, then</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (!utils.isNumber(width) || !utils.isNumber(height) || width &lt;= <span class="hljs-number">0</span> || height &lt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(f(<span class="hljs-string">"Invalid viewport: %dx%d"</span>, width, height));
    }

    <span class="hljs-keyword">this</span>.page.viewportSize = {
        <span class="hljs-attr">width</span>: width,
        <span class="hljs-attr">height</span>: height
    };
    
    <span class="hljs-keyword">this</span>.options.viewportSize = <span class="hljs-keyword">this</span>.page.viewportSize;</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>setting the viewport could cause a redraw and it can take
time. At least for Gecko, we should wait a bit, even
if this time could not be enough.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> time = (phantom.casperEngine === <span class="hljs-string">'slimerjs'</span>?<span class="hljs-number">400</span>:<span class="hljs-number">100</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_step</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.waitStart();
        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_check</span>(<span class="hljs-params">self</span>) </span>{
            self.waitDone();
            self.emit(<span class="hljs-string">'viewport.changed'</span>, [width, height]);
            <span class="hljs-keyword">if</span> (utils.isFunction(then)){
                self.then(then);
            }
        }, time, <span class="hljs-keyword">this</span>);
    });
};

<span class="hljs-comment">/**
 * Checks if an element matching the provided DOM CSS3/XPath selector is visible
 * current page DOM by checking that offsetWidth and offsetHeight are
 * both non-zero.
 *
 * @param  String  selector  A DOM CSS3/XPath selector
 * @return Boolean
 */</span>
Casper.prototype.visible = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">visible</span>(<span class="hljs-params">selector</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"visible"</span>, selector);
};

<span class="hljs-comment">/**
 * Checks if all elements matching the provided DOM CSS3/XPath selector are visible
 *
 * @param  String  selector  A DOM CSS3/XPath selector
 * @return Boolean
 */</span>
Casper.prototype.allVisible = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allVisible</span>(<span class="hljs-params">selector</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"allVisible"</span>, selector);
};

<span class="hljs-comment">/**
 * Displays a warning message onto the console and logs the event. Also emits a
 * `warn` event with the message passed.
 *
 * @param  String  message
 * @return Casper
 */</span>
Casper.prototype.warn = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">warn</span>(<span class="hljs-params">message</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.log(message, <span class="hljs-string">"warning"</span>, <span class="hljs-string">"phantom"</span>);
    <span class="hljs-keyword">var</span> formatted = f.apply(<span class="hljs-literal">null</span>, [<span class="hljs-string">"⚠  "</span> + message].concat([].slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>)));
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'warn'</span>, message);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.echo(formatted, <span class="hljs-string">'COMMENT'</span>);
};

<span class="hljs-comment">/**
 * Helper functions needed in wait*() methods. Casts timeout argument to integer and checks if next step
 * function is really a function and if it has been given (if required - depending on isThenRequired flag).
 *
 * @param   Number   timeout        The max amount of time to wait, in milliseconds
 * @param   Function then           Next step to process (optional or required, depending on isThenRequired flag)
 * @param   String   methodName     Name of the method, inside of which the helper has been called
 * @param   Number   defaultTimeout The default max amount of time to wait, in milliseconds (optional)
 * @param   Boolean  isThenRequired Determines if the next step function should be considered as required
 * @returns Number
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTimeoutAndCheckNextStepFunction</span>(<span class="hljs-params">timeout, then, methodName, defaultTimeout, isThenRequired</span>) </span>{
    <span class="hljs-keyword">if</span> (isThenRequired || then) {
        <span class="hljs-keyword">var</span> isFunction = utils.isFunction(then); <span class="hljs-comment">// Optimization to perform "isFunction" check only once.</span>

        <span class="hljs-keyword">if</span> (isThenRequired &amp;&amp; !isFunction) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(methodName + <span class="hljs-string">"() needs a step function"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (then &amp;&amp; !isFunction) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(methodName + <span class="hljs-string">"() next step definition must be a function"</span>);
        }
    }

    timeout = ~~timeout || ~~defaultTimeout;
    <span class="hljs-keyword">if</span> (timeout &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(methodName + <span class="hljs-string">"() only accepts an integer &gt;= 0 as a timeout value"</span>);
    }

    <span class="hljs-keyword">return</span> timeout;
}

<span class="hljs-comment">/**
 * Makes the provided frame page as the currently active one. Note that the
 * active page will NOT be reverted when finished.
 *
 * @param  String|Number frameInfo  Target frame name or number
 * @return Casper
 */</span>
Casper.prototype.switchToChildFrame = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">switchToChildFrame</span>(<span class="hljs-params">frameInfo</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">if</span> (utils.isNumber(frameInfo)) {
        <span class="hljs-keyword">if</span> (frameInfo &gt; <span class="hljs-keyword">this</span>.page.childFramesCount() - <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(f(<span class="hljs-string">'Frame number "%d" is out of bounds.'</span>, frameInfo));
        }
        <span class="hljs-keyword">this</span>.page.context = <span class="hljs-keyword">this</span>.getElementBounds(selectXPath(<span class="hljs-string">'(//frame|//iframe)['</span> + (frameInfo + <span class="hljs-number">1</span>) + <span class="hljs-string">']'</span>), <span class="hljs-literal">true</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.page.childFramesName().indexOf(frameInfo) === <span class="hljs-number">-1</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(f(<span class="hljs-string">'No frame named "%s" was found.'</span>, frameInfo));
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.page.context = <span class="hljs-keyword">this</span>.getElementBounds(selectXPath(<span class="hljs-string">'(//frame|//iframe)[@name="'</span> + frameInfo + <span class="hljs-string">'"]'</span>), <span class="hljs-literal">true</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>make the frame page the currently active one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.page.switchToFrame(frameInfo);


    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Makes the provided frame page as the currently active one. Note that the
 * active page will NOT be reverted when finished.
 *
 * @param  String|Number frameInfo  Target frame name or number
 * @return Casper
 */</span>
Casper.prototype.switchToFrame = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">switchToFrame</span>(<span class="hljs-params">frameInfo</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.switchToChildFrame(frameInfo);
    <span class="hljs-keyword">this</span>.page.frames.push(<span class="hljs-keyword">this</span>.page.frameName);
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'frame.changed'</span>, frameInfo, <span class="hljs-string">'enter'</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Makes the main frame the currently active one. Note that the
 * active page will NOT be reverted when finished.
 *
 * @return Casper
 */</span>
Casper.prototype.switchToMainFrame = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">switchToMainFrame</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.page.context = {
        <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>,
        <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span>
    };

    <span class="hljs-keyword">var</span> frames = <span class="hljs-keyword">this</span>.page.frames.concat(<span class="hljs-keyword">this</span>.page.framesReloaded);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> index = frames.length - <span class="hljs-number">1</span>; index &gt;= <span class="hljs-number">0</span> ; index--) {
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'frame.changed'</span>, frames[index], <span class="hljs-string">'leave'</span>);
    }
    <span class="hljs-keyword">this</span>.page.frames = [];
    <span class="hljs-keyword">this</span>.page.framesReloaded = [];
    <span class="hljs-keyword">this</span>.page.switchToMainFrame();

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Makes parent frame of current one the currently active one. Note that the
 * active page will NOT be reverted when finished.
 *
 * @param  String|Number frameInfo  Target frame name or number
 * @return Casper
 */</span>
Casper.prototype.switchToParentFrame = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">switchToParentFrame</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">var</span> l = <span class="hljs-keyword">this</span>.page.frames.length;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.page.framesReloaded.length !== <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'frame.changed'</span>, <span class="hljs-keyword">this</span>.page.framesReloaded.pop(), <span class="hljs-string">'leave'</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (l &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>.page.frameName === <span class="hljs-keyword">this</span>.page.frames[l<span class="hljs-number">-1</span>]) {
        <span class="hljs-keyword">this</span>.page.context = {
            <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span>
        };
        <span class="hljs-keyword">this</span>.page.switchToMainFrame();
        <span class="hljs-keyword">var</span> frameName = <span class="hljs-keyword">this</span>.page.frames.pop();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>; index &lt; l ; index++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">this</span>.switchToChildFrame(<span class="hljs-keyword">this</span>.page.frames[index]);
            } <span class="hljs-keyword">catch</span>(e) {
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'frame.changed'</span>, frameName, <span class="hljs-string">'leave'</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Adds a new step that will wait for a given amount of time (expressed
 * in milliseconds) before processing an optional next one.
 *
 * @param  Number    timeout  The max amount of time to wait, in milliseconds
 * @param  Function  then     Next step to process (optional)
 * @return Casper
 */</span>
Casper.prototype.wait = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wait</span>(<span class="hljs-params">timeout, then</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    timeout = getTimeoutAndCheckNextStepFunction(timeout, then, <span class="hljs-string">'wait'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_step</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.waitStart();
        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_check</span>(<span class="hljs-params">self</span>) </span>{
            self.log(f(<span class="hljs-string">"wait() finished waiting for %dms."</span>, timeout), <span class="hljs-string">"info"</span>);
            <span class="hljs-keyword">if</span> (then) {
                <span class="hljs-keyword">try</span> {
                    then.call(self, self);
                } <span class="hljs-keyword">catch</span> (error) {
                    self.emit(<span class="hljs-string">'wait.error'</span>, error);
                    <span class="hljs-keyword">if</span> (!self.options.silentErrors) {
                        <span class="hljs-keyword">throw</span> error;
                    }
                }
            }
            self.waitDone();
        }, timeout, <span class="hljs-keyword">this</span>);
    });
};

Casper.prototype.waitStart = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitStart</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'wait.start'</span>);
    <span class="hljs-keyword">this</span>.pendingWait = <span class="hljs-literal">true</span>;
};

Casper.prototype.waitDone = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitDone</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'wait.done'</span>);
    <span class="hljs-keyword">this</span>.pendingWait = <span class="hljs-literal">false</span>;
};

<span class="hljs-comment">/**
 * Waits until a function returns true to process a next step.
 *
 * @param  Function  testFx     A function to be evaluated for returning condition satisfecit
 * @param  Function  then       The next step to perform (optional)
 * @param  Function  onTimeout  A callback function to call on timeout (optional)
 * @param  Number    timeout    The max amount of time to wait, in milliseconds (optional)
 * @param  Object    details    A property bag of information about the condition being waited on (optional)
 * @return Casper
 */</span>
Casper.prototype.waitFor = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitFor</span>(<span class="hljs-params">testFx, then, onTimeout, timeout, details</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (!utils.isFunction(testFx)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"waitFor() needs a test function"</span>);
    }
    timeout = getTimeoutAndCheckNextStepFunction(timeout, then, <span class="hljs-string">'waitFor'</span>, <span class="hljs-keyword">this</span>.options.waitTimeout);
    details = details || { <span class="hljs-attr">testFx</span>: testFx };
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_step</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.waitStart();
        <span class="hljs-keyword">var</span> start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
        <span class="hljs-keyword">var</span> condition = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>set conditionTestedAfterTimeout to 1 to test condition not run one time after timeout when !condition</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> conditionTestedAfterTimeout = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> interval = setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_check</span>(<span class="hljs-params">self</span>) </span>{
            <span class="hljs-comment">/*eslint max-statements: [1, 20]*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>refs #1805 #1806</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> ( (!condition &amp;&amp; (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - start &lt; timeout)) || (!condition &amp;&amp; !conditionTestedAfterTimeout++) ) {
                condition = testFx.call(self, self);
                <span class="hljs-keyword">return</span>;
            }
            self.waitDone();
            <span class="hljs-keyword">if</span> (!condition) {
                self.log(<span class="hljs-string">"Casper.waitFor() timeout"</span>, <span class="hljs-string">"warning"</span>);
                <span class="hljs-keyword">var</span> onWaitTimeout = onTimeout ? onTimeout : self.options.onWaitTimeout;
                self.emit(<span class="hljs-string">'waitFor.timeout'</span>, timeout, details);
                clearInterval(interval); <span class="hljs-comment">// refs #383</span>
                <span class="hljs-keyword">if</span> (!utils.isFunction(onWaitTimeout)) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">'Invalid timeout function'</span>);
                }
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">return</span> onWaitTimeout.call(self, timeout, details);
                } <span class="hljs-keyword">catch</span> (error) {
                    self.emit(<span class="hljs-string">'waitFor.timeout.error'</span>, error);
                    <span class="hljs-keyword">if</span> (!self.options.silentErrors) {
                        <span class="hljs-keyword">throw</span> error;
                    }
                }
            } <span class="hljs-keyword">else</span> {
                self.log(f(<span class="hljs-string">"waitFor() finished in %dms."</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - start), <span class="hljs-string">"info"</span>);
                clearInterval(interval);
                <span class="hljs-keyword">if</span> (then) {
                    self.then(then);
                }
            }
        }, <span class="hljs-keyword">this</span>.options.retryTimeout, <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">this</span>.waiters.push(interval);
    });
};
<span class="hljs-comment">/**
 * Waits until any alert is triggered.
 *
 * @param  Function  then       The next step to perform (required)
 * @param  Function  onTimeout  A callback function to call on timeout (optional)
 * @param  Number    timeout    The max amount of time to wait, in milliseconds (optional)
 * @return Casper
 */</span>
Casper.prototype.waitForAlert = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">then, onTimeout, timeout</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    timeout = getTimeoutAndCheckNextStepFunction(timeout, then, <span class="hljs-string">'waitForAlert'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">var</span> message;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">alertCallback</span>(<span class="hljs-params">msg</span>) </span>{
        message = msg;
    }
    <span class="hljs-keyword">this</span>.once(<span class="hljs-string">"remote.alert"</span>, alertCallback);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.waitFor(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isAlertReceived</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> message !== <span class="hljs-literal">undefined</span>;
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onAlertReceived</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.then(<span class="hljs-keyword">this</span>.createStep(then, {<span class="hljs-attr">data</span>: message}));
    }, onTimeout, timeout);
};

<span class="hljs-comment">/**
 * Waits until an program is executed (kills it if timeout), 
 * to process a next step.
 * Take care with programs that calls another processes, as it seems to kill only the child.pid
 *
 * @param  String    command     The command to run, with space-separated arguments
 * @param  Array     parameters  array of parameters to be send to program
 * @param  Function  then        The next step to perform (optional)
 * @param  Function  onTimeout   A callback function to call on timeout (optional)
 * @param  Number    timeout     The max amount of time to wait, in milliseconds (optional)
 * @param  Array     timeout     timeout[0] = timeout, timeout[1] is The max amount of time to wait, in milliseconds, for program being killed after SIGTERM, before SIGKILL (optional)
 * @return Casper
 */</span>

Casper.prototype.waitForExec = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitForExec</span>(<span class="hljs-params">command, parameters, then, onTimeout, timeout</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">var</span> killTimeout;
    <span class="hljs-keyword">if</span> (utils.isArray(timeout)) {
        killTimeout = utils.isNumber(timeout[<span class="hljs-number">1</span>]) ? getTimeoutAndCheckNextStepFunction(timeout[<span class="hljs-number">1</span>], then, <span class="hljs-string">'waitForExec'</span>, <span class="hljs-keyword">this</span>.options.waitTimeout) : getTimeoutAndCheckNextStepFunction(timeout[<span class="hljs-number">0</span>], then, <span class="hljs-string">'waitForExec'</span>, <span class="hljs-keyword">this</span>.options.waitTimeout);
        timeout = getTimeoutAndCheckNextStepFunction(timeout[<span class="hljs-number">0</span>], then, <span class="hljs-string">'waitForExec'</span>, <span class="hljs-keyword">this</span>.options.waitTimeout);
    } <span class="hljs-keyword">else</span> {
        timeout = getTimeoutAndCheckNextStepFunction(timeout, then, <span class="hljs-string">'waitForExec'</span>, <span class="hljs-keyword">this</span>.options.waitTimeout);
        killTimeout = timeout;
    };
    
    <span class="hljs-keyword">if</span> ( (!utils.isString(command)) &amp;&amp; (!utils.isArray(parameters))  ) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"waitForExec() needs an command string as program and parameters separated by space to run or an array of parameters. if program is falsy or not a string, it uses default system shell"</span>);
    };
    <span class="hljs-keyword">if</span> (utils.isFalsy(command) || !utils.isString(command)) {
        <span class="hljs-keyword">var</span> system = <span class="hljs-built_in">require</span>(<span class="hljs-string">'system'</span>);
        command = (system.env.SHELL || system.env.ComSpec); <span class="hljs-comment">// SHELL for UNIX(?), ComSpec for Windows(?)</span>
        <span class="hljs-keyword">this</span>.log(<span class="hljs-string">'Casper.waitForExec()  is going to use default system shell '</span> + <span class="hljs-built_in">JSON</span>.stringify(command) + <span class="hljs-string">' - command is falsy or is not a string'</span>, <span class="hljs-string">"warning"</span>);
    };
    <span class="hljs-keyword">if</span> (utils.isFalsy(parameters) || !utils.isArray(parameters)) {
        parameters = [];
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>add use of a escape char like ‘\’??? (e.g.: ‘/bin/bash -c {\ ls\ /\ &amp;&amp;\ ls\ /home\ }’ becomes [‘/bin/bash’, ‘-c’, ‘{ ls / &amp;&amp; ls /home }’]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    command = command.split(<span class="hljs-string">' '</span>);
    parameters = command.splice(<span class="hljs-number">-1</span>,(command.length<span class="hljs-number">-1</span>)).concat(parameters);
    command = command[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
    <span class="hljs-keyword">if</span> (!fs.isExecutable(command)) {
        <span class="hljs-keyword">this</span>.log(<span class="hljs-string">'Casper.waitForExec() is going to call non executable file '</span> + <span class="hljs-built_in">JSON</span>.stringify(command) + <span class="hljs-string">' - maybe runs if is in PATH'</span>, <span class="hljs-string">"warning"</span>);
    };

    <span class="hljs-keyword">var</span> spawn = <span class="hljs-built_in">require</span>(<span class="hljs-string">"child_process"</span>).spawn;
    <span class="hljs-keyword">var</span> stdout = <span class="hljs-string">''</span>; <span class="hljs-comment">// VARIABLE TO STORE PROGRAM STDOUT</span>
    <span class="hljs-keyword">var</span> stderr = <span class="hljs-string">''</span>; <span class="hljs-comment">// VARIABLE TO STORE PROGRAM STDERR</span>
    <span class="hljs-keyword">var</span> exitCode = <span class="hljs-literal">null</span>; <span class="hljs-comment">// VARIABLE TO STORE PROGRAM EXIT CODE</span>
    <span class="hljs-keyword">var</span> realPid = <span class="hljs-literal">null</span>; <span class="hljs-comment">// VARIABLE TO STORE PROGRAM REAL PID</span>
    <span class="hljs-keyword">var</span> elapsedTime = <span class="hljs-literal">null</span>; <span class="hljs-comment">// VARIABLE TO STORE PROGRAM DURATION</span>
    
    <span class="hljs-keyword">var</span> childStartTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
    <span class="hljs-keyword">var</span> child = spawn(command, parameters);
    realPid = child.pid;
    
    child.stdout.on(<span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">standardOut</span>) </span>{ <span class="hljs-comment">// keeps stdout updated</span>
        stdout += standardOut;
    });
    child.stderr.on(<span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">standardError</span>) </span>{ <span class="hljs-comment">// keeps stderr updated</span>
        stderr += standardError;
    });
    child.on(<span class="hljs-string">"exit"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">code</span>) </span>{
        elapsedTime = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime()) - childStartTime;
        exitCode = code;
    });

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__details</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> {<span class="hljs-attr">data</span>: {<span class="hljs-attr">command</span>: command, <span class="hljs-attr">parameters</span>: parameters, <span class="hljs-attr">pid</span>: realPid, <span class="hljs-attr">stdout</span>: stdout, <span class="hljs-attr">stderr</span>: stderr, <span class="hljs-attr">exitCode</span>: exitCode, <span class="hljs-attr">elapsedTime</span>: elapsedTime, <span class="hljs-attr">isChildNotFinished</span>: child.pid }};
    };
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__onTimeout</span>(<span class="hljs-params">timeout, details</span>) </span>{
        <span class="hljs-keyword">var</span> __onWaitTimeout = onTimeout ? onTimeout : <span class="hljs-keyword">this</span>.options.onWaitTimeout;
        <span class="hljs-keyword">var</span> signalToKill = <span class="hljs-string">"SIGTERM"</span>;
        child.kill(signalToKill);
        
        killTimeout = getTimeoutAndCheckNextStepFunction(killTimeout, __onWaitTimeout, <span class="hljs-string">'killAndCallOnWaitTimeout'</span>, <span class="hljs-keyword">this</span>.options.waitTimeout, <span class="hljs-literal">false</span>);
        (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">killAndCallOnWaitTimeout</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>I don’t know if it should return
return this.waitFor(function isProgramKilled() { // HAVE TO ADD waitFor() TO MAKE child.on(“exit”… UPDATES exitCode AND TO child.pid BE UPDATED</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.waitFor(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isProgramKilled</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-comment">// HAVE TO ADD waitFor() TO MAKE child.on("exit"... UPDATES exitCode AND TO child.pid BE UPDATED</span>
                <span class="hljs-keyword">return</span> !child.pid;
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onProgramKilled</span>(<span class="hljs-params"></span>) </span>{ 
                    <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"waitForExec() has killed %s %s (PID %d) with %s"</span>, details.data.command, <span class="hljs-built_in">JSON</span>.stringify(details.data.parameters), details.data.pid, signalToKill), <span class="hljs-string">"info"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>this.then(this.createStep(<strong>onWaitTimeout, timeout, </strong>details()));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    __onWaitTimeout.call(<span class="hljs-keyword">this</span>, timeout, __details());
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onProgramNotKilled</span>(<span class="hljs-params"></span>) </span>{
                    <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"waitForExec() has not killed %s %s (PID %d) with %s"</span>, details.data.command, <span class="hljs-built_in">JSON</span>.stringify(details.data.parameters), details.data.pid, signalToKill), <span class="hljs-string">"warning"</span>);
                    signalToKill = (<span class="hljs-built_in">require</span>(<span class="hljs-string">'system'</span>).os.name !== <span class="hljs-string">"windows"</span>) ? <span class="hljs-string">"SIGKILL"</span> : <span class="hljs-string">"WM_QUIT"</span>; <span class="hljs-comment">// "WM_QUIT" SEEMS TO BE THE WINDOWS EQUIVALENT TO UNIX SIGKILL</span>
                    child.kill(signalToKill);
                    killTimeout = <span class="hljs-number">1</span>;
                    killAndCallOnWaitTimeout.call(<span class="hljs-keyword">this</span>);
            }, killTimeout);
        }).call(<span class="hljs-keyword">this</span>);

    };
    
    <span class="hljs-keyword">this</span>.log(f(<span class="hljs-string">"waitForExec() called %s (PID %d) with %s arguments"</span>, <span class="hljs-built_in">JSON</span>.stringify(command), realPid, <span class="hljs-built_in">JSON</span>.stringify(parameters)), <span class="hljs-string">"info"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.waitFor(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isProgramFinished</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> !child.pid;
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onProgramFinished</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.then(<span class="hljs-keyword">this</span>.createStep(then, __details()));
    }, __onTimeout, timeout, __details());
};

<span class="hljs-comment">/**
 * Waits for a popup page having its url matching the provided pattern to be opened
 * and loaded.
 *
 * @param  String|RegExp  urlPattern  The popup url pattern
 * @param  Function       then        The next step function (optional)
 * @param  Function       onTimeout   Function to call on operation timeout (optional)
 * @param  Number         timeout     Timeout in milliseconds (optional)
 * @return Casper
 */</span>
Casper.prototype.waitForPopup = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitForPopup</span>(<span class="hljs-params">urlPattern, then, onTimeout, timeout</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    timeout = getTimeoutAndCheckNextStepFunction(timeout, then, <span class="hljs-string">'waitForPopup'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.waitFor(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">this</span>.popups.find(urlPattern);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }, then, onTimeout, timeout, { <span class="hljs-attr">popup</span>: urlPattern });
};

<span class="hljs-comment">/**
 * Waits until a given resource is loaded
 *
 * @param  String/Function/RegExp  test       A function to test if the resource exists.
 *                                            A string will be matched against the resources url.
 * @param  Function                then       The next step to perform (optional)
 * @param  Function                onTimeout  A callback function to call on timeout (optional)
 * @param  Number                  timeout    The max amount of time to wait, in milliseconds (optional)
 * @return Casper
 */</span>
Casper.prototype.waitForResource = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitForResource</span>(<span class="hljs-params">test, then, onTimeout, timeout</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    timeout = getTimeoutAndCheckNextStepFunction(timeout, then, <span class="hljs-string">'waitForResource'</span>, <span class="hljs-keyword">this</span>.options.waitTimeout);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.waitFor(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_check</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.resourceExists(test);
    }, then, onTimeout, timeout, { <span class="hljs-attr">resource</span>: test });
};

<span class="hljs-comment">/**
 * Waits for a given url to be loaded.
 *
 * @param  String|RegExp  url  The url to wait for
 * @param  Function         then       The next step to perform (optional)
 * @param  Function         onTimeout  A callback function to call on timeout (optional)
 * @return Casper
 */</span>
Casper.prototype.waitForUrl = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitForUrl</span>(<span class="hljs-params">url, then, onTimeout, timeout</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    timeout = getTimeoutAndCheckNextStepFunction(timeout, then, <span class="hljs-string">'waitForUrl'</span>, <span class="hljs-keyword">this</span>.options.waitTimeout);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.waitFor(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_check</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (utils.isString(url)) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getCurrentUrl().indexOf(url) !== <span class="hljs-number">-1</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (utils.isRegExp(url)) {
            <span class="hljs-keyword">return</span> url.test(<span class="hljs-keyword">this</span>.getCurrentUrl());
        }
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">'invalid url argument'</span>);
    }, then, onTimeout, timeout, { <span class="hljs-attr">url</span>: url });
};

<span class="hljs-comment">/**
 * Waits until an element matching the provided DOM CSS3/XPath selector exists in
 * remote DOM to process a next step.
 *
 * @param  String    selector   A DOM CSS3/XPath selector
 * @param  Function  then       The next step to perform (optional)
 * @param  Function  onTimeout  A callback function to call on timeout (optional)
 * @param  Number    timeout    The max amount of time to wait, in milliseconds (optional)
 * @return Casper
 */</span>
Casper.prototype.waitForSelector = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitForSelector</span>(<span class="hljs-params">selector, then, onTimeout, timeout</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    timeout = getTimeoutAndCheckNextStepFunction(timeout, then, <span class="hljs-string">'waitForSelector'</span>, <span class="hljs-keyword">this</span>.options.waitTimeout);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.waitFor(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_check</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.exists(selector);
    }, then, onTimeout, timeout, { <span class="hljs-attr">selector</span>: selector });
};

<span class="hljs-comment">/**
 * Waits until the page contains given HTML text or matches a given RegExp.
 *
 * @param  String|RegExp  pattern    Text or RegExp to wait for
 * @param  Function       then       The next step to perform (optional)
 * @param  Function       onTimeout  A callback function to call on timeout (optional)
 * @param  Number         timeout    The max amount of time to wait, in milliseconds (optional)
 * @return Casper
 */</span>
Casper.prototype.waitForText = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pattern, then, onTimeout, timeout</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    timeout = getTimeoutAndCheckNextStepFunction(timeout, then, <span class="hljs-string">'waitForText'</span>, <span class="hljs-keyword">this</span>.options.waitTimeout);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.waitFor(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_check</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> content = <span class="hljs-keyword">this</span>.getPageContent();
        <span class="hljs-keyword">if</span> (utils.isRegExp(pattern)) {
            <span class="hljs-keyword">return</span> pattern.test(content);
        }
        <span class="hljs-keyword">return</span> content.indexOf(pattern) !== <span class="hljs-number">-1</span>;
    }, then, onTimeout, timeout, { <span class="hljs-attr">text</span>: pattern });
};

<span class="hljs-comment">/**
 * Waits until the text on an element matching the provided DOM CSS3/XPath selector
 * is changed to a different value.
 *
 * @param String    selector    A DOM CSS3/XPath selector
 * @param Function  then        The next step to preform (optional)
 * @param Function  onTimeout   A callback function to call on timeout (optional)
 * @param Number    timeout     The max amount of time to wait, in milliseconds (optional)
 * @return Casper
 */</span>
Casper.prototype.waitForSelectorTextChange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">selector, then, onTimeout, timeout</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    timeout = getTimeoutAndCheckNextStepFunction(timeout, then, <span class="hljs-string">'waitForSelectorTextChange'</span>, <span class="hljs-keyword">this</span>.options.waitTimeout);
    <span class="hljs-keyword">var</span> currentSelectorText = <span class="hljs-keyword">this</span>.fetchText(selector);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.waitFor(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_check</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> currentSelectorText !== <span class="hljs-keyword">this</span>.fetchText(selector);
    }, then, onTimeout, timeout, { <span class="hljs-attr">selectorTextChange</span>: selector });
};

<span class="hljs-comment">/**
 * Waits until an element matching the provided DOM CSS3/XPath selector does not
 * exist in the remote DOM to process a next step.
 *
 * @param  String    selector   A DOM CSS3/XPath selector
 * @param  Function  then       The next step to perform (optional)
 * @param  Function  onTimeout  A callback function to call on timeout (optional)
 * @param  Number    timeout    The max amount of time to wait, in milliseconds (optional)
 * @return Casper
 */</span>
Casper.prototype.waitWhileSelector = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitWhileSelector</span>(<span class="hljs-params">selector, then, onTimeout, timeout</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    timeout = getTimeoutAndCheckNextStepFunction(timeout, then, <span class="hljs-string">'waitWhileSelector'</span>, <span class="hljs-keyword">this</span>.options.waitTimeout);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.waitFor(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_check</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> !<span class="hljs-keyword">this</span>.exists(selector);
    }, then, onTimeout, timeout, {
        <span class="hljs-attr">selector</span>: selector,
        <span class="hljs-attr">waitWhile</span>: <span class="hljs-literal">true</span>
    });
};

<span class="hljs-comment">/**
 * Waits until an element matching the provided DOM CSS3/XPath selector is
 * visible in the remote DOM to process a next step.
 *
 * @param  String    selector   A DOM CSS3/XPath selector
 * @param  Function  then       The next step to perform (optional)
 * @param  Function  onTimeout  A callback function to call on timeout (optional)
 * @param  Number    timeout    The max amount of time to wait, in milliseconds (optional)
 * @return Casper
 */</span>
Casper.prototype.waitUntilVisible = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitUntilVisible</span>(<span class="hljs-params">selector, then, onTimeout, timeout</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    timeout = getTimeoutAndCheckNextStepFunction(timeout, then, <span class="hljs-string">'waitUntilVisible'</span>, <span class="hljs-keyword">this</span>.options.waitTimeout);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.waitFor(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_check</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.visible(selector);
    }, then, onTimeout, timeout, { <span class="hljs-attr">visible</span>: selector });
};

<span class="hljs-comment">/**
 * Waits until an element matching the provided DOM CSS3/XPath selector is no
 * longer visible in remote DOM to process a next step.
 *
 * @param  String    selector   A DOM CSS3/XPath selector
 * @param  Function  then       The next step to perform (optional)
 * @param  Function  onTimeout  A callback function to call on timeout (optional)
 * @param  Number    timeout    The max amount of time to wait, in milliseconds (optional)
 * @return Casper
 */</span>
Casper.prototype.waitWhileVisible = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waitWhileVisible</span>(<span class="hljs-params">selector, then, onTimeout, timeout</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    timeout = getTimeoutAndCheckNextStepFunction(timeout, then, <span class="hljs-string">'waitWhileVisible'</span>, <span class="hljs-keyword">this</span>.options.waitTimeout);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.waitFor(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_check</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> !<span class="hljs-keyword">this</span>.visible(selector);
    }, then, onTimeout, timeout, {
        <span class="hljs-attr">visible</span>: selector,
        <span class="hljs-attr">waitWhile</span>: <span class="hljs-literal">true</span>
    });
};

<span class="hljs-comment">/**
 * Make the provided scope for page evaluation. Note that the
 * active scope will be reverted when finished.
 *
 * @param  String   selector  A DOM CSS3 / Xpath compatible selector
 * @param  Function  then     Next step function
 * @return Casper
 */</span>
Casper.prototype.withSelectorScope = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">withSelectorScope</span>(<span class="hljs-params">selector, then</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">var</span> currentScope;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_step</span>(<span class="hljs-params"></span>) </span>{
        currentScope = <span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"setScope"</span>, selector);
    });
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">this</span>.then(then);
    } <span class="hljs-keyword">catch</span> (e) {</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>revert to main page on error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.warn(<span class="hljs-string">"Error while processing selector scope step: "</span> + e);
        <span class="hljs-keyword">throw</span> e;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_step</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>revert to previous scope or main document</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.callUtils(<span class="hljs-string">"setScope"</span>, currentScope);
    });
};

<span class="hljs-comment">/**
 * Makes the provided frame page as the currently active one. Note that the
 * active page will be reverted when finished.
 *
 * @param  String|Number    frameInfo  Target frame name or number
 * @param  Function  then       Next step function
 * @return Casper
 */</span>
Casper.prototype.withFrame = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">withFrame</span>(<span class="hljs-params">frameInfo, then</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_step</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>make the frame page the currently active one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.switchToFrame(frameInfo);
    });
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">this</span>.then(then);
    } <span class="hljs-keyword">catch</span> (e) {</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>revert to main page on error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.warn(<span class="hljs-string">"Error while processing frame step: "</span> + e);
        <span class="hljs-keyword">throw</span> e;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_step</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.switchToParentFrame();
    });
};

<span class="hljs-comment">/**
 * Makes the provided frame page as the currently active one. Note that the
 * active page will be reverted when finished.
 *
 * @param  String|RegExp|WebPage  popup  Target frame page information
 * @param  Function               then   Next step function
 * @return Casper
 */</span>
Casper.prototype.withPopup = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">withPopup</span>(<span class="hljs-params">popupInfo, then</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_step</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> popupPage = <span class="hljs-keyword">this</span>.popups.find(popupInfo);
        <span class="hljs-keyword">if</span> (!utils.isFunction(then)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"withPopup() requires a step function."</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>make the popup page the currently active one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.page = popupPage;
    });
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">this</span>.then(then);
    } <span class="hljs-keyword">catch</span> (e) {</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>revert to main page on error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.log(<span class="hljs-string">"error while processing popup step: "</span> + e, <span class="hljs-string">"error"</span>);
        <span class="hljs-keyword">this</span>.page = <span class="hljs-keyword">this</span>.mainPage;
        <span class="hljs-keyword">throw</span> e;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_step</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>revert to main page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.page = <span class="hljs-keyword">this</span>.mainPage;
    });
};

<span class="hljs-comment">/**
* Allow user to create a new page object after calling a casper.page.close()
* @return WebPage
*/</span>

Casper.prototype.newPage = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newPage</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.started) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(f(<span class="hljs-string">"Casper is not started, can't execute `%s()`"</span>,
                                newPage.caller.name));
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.page !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">this</span>.page.close();
    }
    <span class="hljs-keyword">this</span>.page = <span class="hljs-keyword">this</span>.mainPage = createPage(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.page.settings = utils.mergeObjects(<span class="hljs-keyword">this</span>.page.settings, <span class="hljs-keyword">this</span>.options.pageSettings);
    <span class="hljs-keyword">if</span> (utils.isClipRect(<span class="hljs-keyword">this</span>.options.clipRect)) {
        <span class="hljs-keyword">this</span>.page.clipRect = <span class="hljs-keyword">this</span>.options.clipRect;
    }
    <span class="hljs-keyword">if</span> (utils.isObject(<span class="hljs-keyword">this</span>.options.viewportSize)) {
        <span class="hljs-keyword">this</span>.page.viewportSize = <span class="hljs-keyword">this</span>.options.viewportSize;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.page;
};

<span class="hljs-comment">/**
 * Changes the current page zoom factor.
 *
 * @param  Number  factor  The zoom factor
 * @return Casper
 */</span>
Casper.prototype.zoom = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">zoom</span>(<span class="hljs-params">factor</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.checkStarted();
    <span class="hljs-keyword">if</span> (!utils.isNumber(factor) || factor &lt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"Invalid zoom factor: "</span> + factor);
    }
    <span class="hljs-keyword">this</span>.page.zoomFactor = factor;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-comment">/**
 * Extends Casper's prototype with provided one.
 *
 * @param  Object  proto  Prototype methods to add to Casper
 * @deprecated
 * @since 0.6
 */</span>
Casper.extend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">proto</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">"deprecated"</span>, <span class="hljs-string">"Casper.extend() has been deprecated since 0.6; check the docs"</span>);
    <span class="hljs-keyword">if</span> (!utils.isObject(proto)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CasperError(<span class="hljs-string">"extends() only accept objects as prototypes"</span>);
    }
    utils.mergeObjects(Casper.prototype, proto);
};

exports.Casper = Casper;

<span class="hljs-comment">/**
 * Creates a new WebPage instance for Casper use.
 *
 * @param  Casper  casper  A Casper instance
 * @return WebPage
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createPage</span>(<span class="hljs-params">casper</span>) </span>{
    <span class="hljs-comment">/*eslint max-statements:0*/</span>
<span class="hljs-meta">    "use strict"</span>;
    <span class="hljs-keyword">var</span> mainPage = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpage'</span>).create();
    mainPage.isPopup = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">var</span> onClosing = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onClosing</span>(<span class="hljs-params">closedPopup</span>) </span>{
        <span class="hljs-keyword">if</span> (closedPopup.isPopup) {
            <span class="hljs-keyword">if</span> (casper.page !== <span class="hljs-literal">null</span> &amp;&amp; casper.page.id === closedPopup.id) {
                casper.page = casper.mainPage;
            }
            casper.popups.clean();
            casper.emit(<span class="hljs-string">'popup.closed'</span>, closedPopup);
        } <span class="hljs-keyword">else</span> {
            casper.page = <span class="hljs-literal">null</span>;
            casper.emit(<span class="hljs-string">'page.closed'</span>, closedPopup);
        }
    };

    <span class="hljs-keyword">var</span> onLoadFinished = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onLoadFinished</span>(<span class="hljs-params">status</span>) </span>{
        <span class="hljs-keyword">this</span>.windowNameBackUp = <span class="hljs-keyword">this</span>.windowName;
        <span class="hljs-comment">/*eslint max-statements:0*/</span>
        <span class="hljs-keyword">if</span> (status !== <span class="hljs-string">"success"</span>) {
            casper.emit(<span class="hljs-string">'load.failed'</span>, {
                <span class="hljs-attr">status</span>:      status,
                <span class="hljs-attr">http_status</span>: casper.currentHTTPStatus,
                <span class="hljs-attr">url</span>:         <span class="hljs-keyword">this</span>.url
            });
            <span class="hljs-keyword">var</span> message = <span class="hljs-string">'Loading resource failed with status='</span> + status;
            <span class="hljs-keyword">if</span> (casper.currentHTTPStatus) {
                message += f(<span class="hljs-string">' (HTTP %d)'</span>, casper.currentHTTPStatus);
            }
            message += <span class="hljs-string">': '</span> + casper.requestUrl;
            casper.log(message, <span class="hljs-string">"warning"</span>);
            casper.navigationRequested = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">this</span>.browserInitializing = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">if</span> (utils.isFunction(casper.options.onLoadError)) {
                casper.options.onLoadError.call(casper, casper, casper.requestUrl, status);
            }
        }

        <span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>, currentPage = casper.page;
        casper.page = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">this</span>.switchToMainFrame();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> l = <span class="hljs-keyword">this</span>.frames.length; index &lt; l ; index++) {
            <span class="hljs-keyword">try</span> {
                casper.switchToChildFrame(<span class="hljs-keyword">this</span>.frames[index]);
            } <span class="hljs-keyword">catch</span>(e) {
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">this</span>.framesReloaded = <span class="hljs-keyword">this</span>.frames.slice(index);
        <span class="hljs-keyword">this</span>.frames = <span class="hljs-keyword">this</span>.frames.slice(<span class="hljs-number">0</span>, index);

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.framesReloaded.length !== <span class="hljs-number">0</span>) {
            casper.emit(<span class="hljs-string">'frame.reset'</span>, <span class="hljs-keyword">this</span>.framesReloaded);
        }
        casper.page = currentPage;</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>local client scripts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        casper.injectClientScripts(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>remote client scripts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        casper.includeRemoteScripts(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Client-side utils injection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        casper.injectClientUtils(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>history</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        casper.history.push(casper.getCurrentUrl());
        casper.emit(<span class="hljs-string">'load.finished'</span>, status);
        <span class="hljs-keyword">this</span>.loadInProgress = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isPopup) {
            casper.emit(<span class="hljs-string">'popup.loaded'</span>, <span class="hljs-keyword">this</span>);
        } <span class="hljs-keyword">else</span> {
            casper.emit(<span class="hljs-string">'page.loaded'</span>, <span class="hljs-keyword">this</span>);
        }
    };

    <span class="hljs-keyword">var</span> onLoadStarted = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onLoadStarted</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>in some case, there is no navigation requested event, so
be sure that browserInitializing is false to not block checkStep()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.browserInitializing = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">this</span>.loadInProgress = <span class="hljs-literal">true</span>;
        casper.emit(<span class="hljs-string">'load.started'</span>);
    };

    <span class="hljs-keyword">var</span> onNavigationRequested = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onNavigationRequested</span>(<span class="hljs-params">url, type, willNavigate, isMainFrame</span>) </span>{
        casper.log(f(<span class="hljs-string">'Navigation requested: url=%s, type=%s, willNavigate=%s, isMainFrame=%s'</span>,
                     url, type, willNavigate, isMainFrame), <span class="hljs-string">"debug"</span>);
        <span class="hljs-keyword">this</span>.browserInitializing = <span class="hljs-literal">false</span>;
        casper.page.switchToMainFrame();
        <span class="hljs-keyword">if</span> (isMainFrame &amp;&amp; casper.requestUrl !== url) {
            <span class="hljs-keyword">var</span> currentUrl = casper.requestUrl;
            <span class="hljs-keyword">var</span> newUrl = url;
            <span class="hljs-keyword">var</span> pos = currentUrl.indexOf(<span class="hljs-string">'#'</span>);
            <span class="hljs-keyword">if</span> (pos !== <span class="hljs-number">-1</span>) {
                currentUrl = currentUrl.substring(<span class="hljs-number">0</span>, pos);
            }
            pos = newUrl.indexOf(<span class="hljs-string">'#'</span>);
            <span class="hljs-keyword">if</span> (pos !== <span class="hljs-number">-1</span>) {
                newUrl = newUrl.substring(<span class="hljs-number">0</span>, pos);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>for URLs that are only different by their hash part
or if navigation locked (willNavigate == false)
don’t turn navigationRequested to true, because
there will not be loadStarted, loadFinished events
so it could cause issues (for exemple, checkStep that
do no execute the next step -&gt; infinite loop on checkStep)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (willNavigate &amp;&amp; currentUrl !== newUrl) {
                casper.navigationRequested = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">if</span> (willNavigate) {
                casper.requestUrl = url;
            }
        }
        casper.emit(<span class="hljs-string">'navigation.requested'</span>, url, type, willNavigate, isMainFrame);
    };
    
    <span class="hljs-keyword">var</span> onPageCreated = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onPageCreated</span>(<span class="hljs-params">page</span>) </span>{
        page.isPopup = (<span class="hljs-keyword">typeof</span> page.isPopup === <span class="hljs-string">"undefined"</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
        page.id = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
        page.browserInitializing = <span class="hljs-literal">false</span>;
        page.loadInProgress = <span class="hljs-literal">false</span>; 
        page.windowNameBackUp = page.windowName;
        page.frames = [];
        page.framesReloaded = [];
        page.context = {
            <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span>
        };

        page.settings.loadImagesValue = page.settings.loadImages;
        <span class="hljs-built_in">Object</span>.defineProperty(page.settings,<span class="hljs-string">'loadImages'</span>, {
            <span class="hljs-attr">get</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ 
                <span class="hljs-keyword">return</span> page.settings.loadImagesValue;
            },
            <span class="hljs-attr">set</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue</span>) </span>{
                page.settings.loadImagesValue = newValue;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> page.clearMemoryCache === <span class="hljs-string">'function'</span>) {
                    page.clearMemoryCache();
                };
            }
        });

        page.onClosing =  <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> p = page;
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> onClosing.apply(p, <span class="hljs-built_in">arguments</span>);
            };
        }();
        page.onLoadFinished = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> p = page;
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> onLoadFinished.apply(p, <span class="hljs-built_in">arguments</span>);
            };
        }();
        page.onLoadStarted = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> p = page;
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> onLoadStarted.apply(p, <span class="hljs-built_in">arguments</span>);
            };
        }();
        page.onNavigationRequested = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> p = page;
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> onNavigationRequested.apply(p, <span class="hljs-built_in">arguments</span>);
            };
        }();
        page.onPageCreated = onPageCreated;

        page.onAlert = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onAlert</span>(<span class="hljs-params">message</span>) </span>{
            casper.log(<span class="hljs-string">'[alert] '</span> + message, <span class="hljs-string">"info"</span>, <span class="hljs-string">"remote"</span>);
            casper.emit(<span class="hljs-string">'remote.alert'</span>, message);
            <span class="hljs-keyword">if</span> (utils.isFunction(casper.options.onAlert)) {
                casper.options.onAlert.call(casper, casper, message);
            }
        };
        page.onConfirm = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onConfirm</span>(<span class="hljs-params">message</span>) </span>{
            <span class="hljs-keyword">if</span> (<span class="hljs-string">'page.confirm'</span> <span class="hljs-keyword">in</span> casper._filters) {
                <span class="hljs-keyword">return</span> casper.filter(<span class="hljs-string">'page.confirm'</span>, message);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        };
        page.onConsoleMessage = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onConsoleMessage</span>(<span class="hljs-params">msg</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>client utils casper console message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> consoleTest = <span class="hljs-regexp">/^\[casper\.echo\]\s?([\s\S]*)/</span>.exec(msg);
            <span class="hljs-keyword">if</span> (consoleTest &amp;&amp; consoleTest.length === <span class="hljs-number">2</span>) {
                casper.echo(consoleTest[<span class="hljs-number">1</span>]);
                <span class="hljs-keyword">return</span>; <span class="hljs-comment">// don't trigger remote.message event for these</span>
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>client utils log messages</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> logLevel = <span class="hljs-string">"info"</span>,
                logTest = <span class="hljs-regexp">/^\[casper:(\w+)\]\s?([\s\S]*)/m</span>.exec(msg);
            <span class="hljs-keyword">if</span> (logTest &amp;&amp; logTest.length === <span class="hljs-number">3</span>) {
                logLevel = logTest[<span class="hljs-number">1</span>];
                msg = logTest[<span class="hljs-number">2</span>];
                casper.log(msg, logLevel, <span class="hljs-string">"remote"</span>);
            } <span class="hljs-keyword">else</span> {
                casper.emit(<span class="hljs-string">'remote.message'</span>, msg);
            }
        };

        page.onCallback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onCallback</span>(<span class="hljs-params">data</span>)</span>{
            casper.emit(<span class="hljs-string">'remote.callback'</span>, data);
        };
        page.onError = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onError</span>(<span class="hljs-params">msg, trace</span>) </span>{
            casper.emit(<span class="hljs-string">'page.error'</span>, msg, trace);
        };
        page.onFilePicker = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onFilePicker</span>(<span class="hljs-params">olderFile</span>) </span>{
            <span class="hljs-keyword">return</span> casper.filter(<span class="hljs-string">'page.filePicker'</span>, olderFile);
        };
        page.onInitialized = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onInitialized</span>(<span class="hljs-params"></span>) </span>{
            casper.emit(<span class="hljs-string">'page.initialized'</span>, page);
            <span class="hljs-keyword">if</span> (utils.isFunction(casper.options.onPageInitialized)) {
                casper.log(<span class="hljs-string">"Post-configuring WebPage instance"</span>, <span class="hljs-string">"debug"</span>);
                casper.options.onPageInitialized.call(casper, page);
            }
        };
        page.onLongRunningScript = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onLongRunningScript</span>(<span class="hljs-params">message</span>) </span>{
            casper.emit(<span class="hljs-string">'remote.longRunningScript'</span>, page, message);
        };
        page.onPrompt = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onPrompt</span>(<span class="hljs-params">message, value</span>) </span>{
            <span class="hljs-keyword">return</span> casper.filter(<span class="hljs-string">'page.prompt'</span>, message, value);
        };
        page.onResourceReceived = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onResourceReceived</span>(<span class="hljs-params">resource</span>) </span>{
            http.augmentResponse(resource);
            casper.emit(<span class="hljs-string">'resource.received'</span>, resource);
            <span class="hljs-keyword">if</span> (utils.isFunction(casper.options.onResourceReceived)) {
                casper.options.onResourceReceived.call(casper, casper, resource);
            }
            casper.handleReceivedResource(resource);
        };
        page.onResourceRequested = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onResourceRequested</span>(<span class="hljs-params">requestData, request</span>) </span>{
            casper.emit(<span class="hljs-string">'resource.requested'</span>, requestData, request);
            <span class="hljs-keyword">var</span> checkUrl = ((phantom.casperEngine === <span class="hljs-string">'phantomjs'</span> &amp;&amp; utils.ltVersion(phantom.version, <span class="hljs-string">'2.1.0'</span>)) ||
                       (phantom.casperEngine === <span class="hljs-string">'slimerjs'</span> &amp;&amp; utils.ltVersion(slimer.version, <span class="hljs-string">'0.10.0'</span>))) ? utils.decodeUrl(requestData.url) : requestData.url;
            <span class="hljs-keyword">if</span> (checkUrl === casper.requestUrl) {
                casper.emit(<span class="hljs-string">'page.resource.requested'</span>, requestData, request);
            }
            <span class="hljs-keyword">if</span> (utils.isFunction(casper.options.onResourceRequested)) {
                casper.options.onResourceRequested.call(casper, casper, requestData, request);
            }
        };
        page.onResourceError = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onResourceError</span>(<span class="hljs-params">resourceError</span>) </span>{
            casper.emit(<span class="hljs-string">'resource.error'</span>, resourceError);
        };
        page.onResourceTimeout = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onResourceTimeout</span>(<span class="hljs-params">resourceError</span>) </span>{
            casper.emit(<span class="hljs-string">'resource.timeout'</span>, resourceError);
        };
        page.onUrlChanged= <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onUrlChanged</span>(<span class="hljs-params">url</span>) </span>{
            casper.log(f(<span class="hljs-string">'url changed to "%s"'</span>, url), <span class="hljs-string">"debug"</span>);
            casper.navigationRequested= <span class="hljs-literal">false</span>;
            casper.emit(<span class="hljs-string">'url.changed'</span>, url);
        };

        <span class="hljs-keyword">if</span> (page.isPopup) {
            casper.emit(<span class="hljs-string">'popup.created'</span>, page);
            <span class="hljs-keyword">if</span> (casper.options.pageSettings.userAgent !== defaultUserAgent) {
                page.customHeaders = {<span class="hljs-string">"User-Agent"</span>: casper.options.pageSettings.userAgent};
            }
            page.settings = utils.mergeObjects(page.settings, casper.options.pageSettings);
            <span class="hljs-keyword">if</span> (utils.isClipRect(casper.options.clipRect)) {
                page.clipRect = casper.options.clipRect;
            }
            <span class="hljs-keyword">if</span> (utils.isObject(casper.options.viewportSize)) {
                page.viewportSize = casper.options.viewportSize;
            }
            casper.popups.push(page);
        } <span class="hljs-keyword">else</span> {
            casper.emit(<span class="hljs-string">'page.created'</span>, page);
        }
    };
    onPageCreated(mainPage);
    <span class="hljs-keyword">return</span> mainPage;
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
